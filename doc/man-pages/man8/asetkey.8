.rn '' }`
''' $RCSfile$$Revision$$Date$
'''
''' $Log$
'''
.de Sh
.br
.if t .Sp
.ne 5
.PP
\fB\\$1\fR
.PP
..
.de Sp
.if t .sp .5v
.if n .sp
..
.de Ip
.br
.ie \\n(.$>=3 .ne \\$3
.el .ne 3
.IP "\\$1" \\$2
..
.de Vb
.ft CW
.nf
.ne \\$1
..
.de Ve
.ft R

.fi
..
'''
'''
'''     Set up \*(-- to give an unbreakable dash;
'''     string Tr holds user defined translation string.
'''     Bell System Logo is used as a dummy character.
'''
.tr \(*W-|\(bv\*(Tr
.ie n \{\
.ds -- \(*W-
.ds PI pi
.if (\n(.H=4u)&(1m=24u) .ds -- \(*W\h'-12u'\(*W\h'-12u'-\" diablo 10 pitch
.if (\n(.H=4u)&(1m=20u) .ds -- \(*W\h'-12u'\(*W\h'-8u'-\" diablo 12 pitch
.ds L" ""
.ds R" ""
'''   \*(M", \*(S", \*(N" and \*(T" are the equivalent of
'''   \*(L" and \*(R", except that they are used on ".xx" lines,
'''   such as .IP and .SH, which do another additional levels of
'''   double-quote interpretation
.ds M" """
.ds S" """
.ds N" """""
.ds T" """""
.ds L' '
.ds R' '
.ds M' '
.ds S' '
.ds N' '
.ds T' '
'br\}
.el\{\
.ds -- \(em\|
.tr \*(Tr
.ds L" ``
.ds R" ''
.ds M" ``
.ds S" ''
.ds N" ``
.ds T" ''
.ds L' `
.ds R' '
.ds M' `
.ds S' '
.ds N' `
.ds T' '
.ds PI \(*p
'br\}
.\"	If the F register is turned on, we'll generate
.\"	index entries out stderr for the following things:
.\"		TH	Title 
.\"		SH	Header
.\"		Sh	Subsection 
.\"		Ip	Item
.\"		X<>	Xref  (embedded
.\"	Of course, you have to process the output yourself
.\"	in some meaninful fashion.
.if \nF \{
.de IX
.tm Index:\\$1\t\\n%\t"\\$2"
..
.nr % 0
.rr F
.\}
.TH asetkey 8 "OpenAFS" "3/Apr/2006" "AFS Command Reference"
.UC
.if n .hy 0
.if n .na
.ds C+ C\v'-.1v'\h'-1p'\s-2+\h'-1p'+\s0\v'.1v'\h'-1p'
.de CQ          \" put $1 in typewriter font
.ft CW
'if n "\c
'if t \\&\\$1\c
'if n \\&\\$1\c
'if n \&"
\\&\\$2 \\$3 \\$4 \\$5 \\$6 \\$7
'.ft R
..
.\" @(#)ms.acc 1.5 88/02/08 SMI; from UCB 4.2
.	\" AM - accent mark definitions
.bd B 3
.	\" fudge factors for nroff and troff
.if n \{\
.	ds #H 0
.	ds #V .8m
.	ds #F .3m
.	ds #[ \f1
.	ds #] \fP
.\}
.if t \{\
.	ds #H ((1u-(\\\\n(.fu%2u))*.13m)
.	ds #V .6m
.	ds #F 0
.	ds #[ \&
.	ds #] \&
.\}
.	\" simple accents for nroff and troff
.if n \{\
.	ds ' \&
.	ds ` \&
.	ds ^ \&
.	ds , \&
.	ds ~ ~
.	ds ? ?
.	ds ! !
.	ds /
.	ds q
.\}
.if t \{\
.	ds ' \\k:\h'-(\\n(.wu*8/10-\*(#H)'\'\h"|\\n:u"
.	ds ` \\k:\h'-(\\n(.wu*8/10-\*(#H)'\`\h'|\\n:u'
.	ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'^\h'|\\n:u'
.	ds , \\k:\h'-(\\n(.wu*8/10)',\h'|\\n:u'
.	ds ~ \\k:\h'-(\\n(.wu-\*(#H-.1m)'~\h'|\\n:u'
.	ds ? \s-2c\h'-\w'c'u*7/10'\u\h'\*(#H'\zi\d\s+2\h'\w'c'u*8/10'
.	ds ! \s-2\(or\s+2\h'-\w'\(or'u'\v'-.8m'.\v'.8m'
.	ds / \\k:\h'-(\\n(.wu*8/10-\*(#H)'\z\(sl\h'|\\n:u'
.	ds q o\h'-\w'o'u*8/10'\s-4\v'.4m'\z\(*i\v'-.4m'\s+4\h'\w'o'u*8/10'
.\}
.	\" troff and (daisy-wheel) nroff accents
.ds : \\k:\h'-(\\n(.wu*8/10-\*(#H+.1m+\*(#F)'\v'-\*(#V'\z.\h'.2m+\*(#F'.\h'|\\n:u'\v'\*(#V'
.ds 8 \h'\*(#H'\(*b\h'-\*(#H'
.ds v \\k:\h'-(\\n(.wu*9/10-\*(#H)'\v'-\*(#V'\*(#[\s-4v\s0\v'\*(#V'\h'|\\n:u'\*(#]
.ds _ \\k:\h'-(\\n(.wu*9/10-\*(#H+(\*(#F*2/3))'\v'-.4m'\z\(hy\v'.4m'\h'|\\n:u'
.ds . \\k:\h'-(\\n(.wu*8/10)'\v'\*(#V*4/10'\z.\v'-\*(#V*4/10'\h'|\\n:u'
.ds 3 \*(#[\v'.2m'\s-2\&3\s0\v'-.2m'\*(#]
.ds o \\k:\h'-(\\n(.wu+\w'\(de'u-\*(#H)/2u'\v'-.3n'\*(#[\z\(de\v'.3n'\h'|\\n:u'\*(#]
.ds d- \h'\*(#H'\(pd\h'-\w'~'u'\v'-.25m'\f2\(hy\fP\v'.25m'\h'-\*(#H'
.ds D- D\\k:\h'-\w'D'u'\v'-.11m'\z\(hy\v'.11m'\h'|\\n:u'
.ds th \*(#[\v'.3m'\s+1I\s-1\v'-.3m'\h'-(\w'I'u*2/3)'\s-1o\s+1\*(#]
.ds Th \*(#[\s+2I\s-2\h'-\w'I'u*3/5'\v'-.3m'o\v'.3m'\*(#]
.ds ae a\h'-(\w'a'u*4/10)'e
.ds Ae A\h'-(\w'A'u*4/10)'E
.ds oe o\h'-(\w'o'u*4/10)'e
.ds Oe O\h'-(\w'O'u*4/10)'E
.	\" corrections for vroff
.if v .ds ~ \\k:\h'-(\\n(.wu*9/10-\*(#H)'\s-2\u~\d\s+2\h'|\\n:u'
.if v .ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'\v'-.4m'^\v'.4m'\h'|\\n:u'
.	\" for low resolution devices (crt and lpr)
.if \n(.H>23 .if \n(.V>19 \
\{\
.	ds : e
.	ds 8 ss
.	ds v \h'-1'\o'\(aa\(ga'
.	ds _ \h'-1'^
.	ds . \h'-1'.
.	ds 3 3
.	ds o a
.	ds d- d\h'-1'\(ga
.	ds D- D\h'-1'\(hy
.	ds th \o'bp'
.	ds Th \o'LP'
.	ds ae ae
.	ds Ae AE
.	ds oe oe
.	ds Oe OE
.\}
.rm #[ #] #H #V #F C
.SH "NAME"
asetkey \- Add a key from a keytab to an AFS KeyFile
.SH "SYNOPSIS"
\fBasetkey\fR add <\fIkvno\fR> <\fIkeyfile\fR> <\fIprincipal\fR>
.PP
\fBasetkey\fR delete <\fIkvno\fR>
.PP
\fBasetkey\fR list
.SH "DESCRIPTION"
The \fBasetkey\fR command is used to add a key to an AFS KeyFile from a
Kerberos keytab.  It is similar to \fBbos addkey\fR except that it must be
run locally on the system where the KeyFile is located and it takes the
new key from a Kerberos 5 keytab rather than prompting for the password.
.PP
\fBasetkey delete\fR can be used to delete a key (similar to \fBbos
removekeys\fR), and \fBasetkey list\fR will list the keys in a KeyFile (similar
to \fBbos listkeys\fR).
.PP
\fBasetkey\fR is used when authentication for an AFS cell is provided by a
Kerberos 5 KDC rather than \fBkaserver\fR.  The key for the \f(CWafs\fR or
\f(CWafs/\fIcell name\fR\fR principal in the Kerberos 5 KDC must match the key
stored in the AFS KeyFile on all AFS database servers and file servers.
This is done by creating a keytab containing that key using the standard
Kerberos commands (generally the \f(CWktadd\fR function of the \fBkadmin\fR
command) and then, on each AFS database server and file server, adding
that key to the KeyFile with \fBasetkey add\fR.  The \fIkvno\fR chosen should
match the kvno in the Kerberos KDC (checked with \fBkvno\fR or the
\f(CWgetprinc\fR function of \fBkadmin\fR).  \fIprincipal\fR should be the name of
the AFS principal in the keytab, which must be either \f(CWafs\fR or
\f(CWafs/\fIcell name\fR\fR.
.PP
In cells that use the Update Server to distribute the contents of the
\fI/usr/afs/etc\fR directory, it is conventional to run \fBasetkey add\fR only
on the control machine and then let the Update Server propagate the new
KeyFile to all other systems.
.SH "CAUTIONS"
AFS currently only supports des-cbc-crc:v4 Kerberos keys.  Make sure, when
creating the keytab with \f(CWktadd\fR, you pass \f(CW-e des-cbc-crc:v4\fR to force
the encryption type.  Otherwise, AFS authentication may not work.
.PP
As soon as a new keytab is created with \f(CWktadd\fR, new AFS service tickets
will use the new key.  However, tokens formed from those service tickets
will only work if the new key is present in the KeyFile on the AFS file
server.  There is therefore an outage window between when the new keytab
is created and when the key had been added to the KeyFile of all AFS
servers with \fBasetkey\fR, during which newly obtained AFS tokens will not
work properly.
.PP
All of the KeyFile entries must match the key in the Kerberos KDC, but
each time \f(CWktadd\fR is run, it creates a new key.  Either the Update Server
must be used to distribute the KeyFile to all servers or the same keytab
must be used with \fBasetkey\fR on each server.
.SH "EXAMPLES"
The following commands create a new keytab for the principal \f(CWafs\fR and
then import the key into the KeyFile.  Note the kvno in the output from
\f(CWktadd\fR.
.PP
.Vb 8
\&    % kadmin
\&    Authenticating as principal rra/admin@stanford.edu with password.
\&    Password for rra/admin@stanford.edu:
\&    kadmin:  ktadd -k /tmp/afs.keytab -e des-cbc-crc:v4 afs
\&    Entry for principal afs with kvno 3, encryption type DES cbc mode
\&    with CRC-32 added to keytab WRFILE:/tmp/afs.keytab.
\&    kadmin:  exit
\&    % asetkey 3 /tmp/afs.keytab afs
.Ve
You may want to use \f(CWafs/\fIcell name\fR\fR instead of \f(CWafs\fR, particularly if
you may have multiple AFS cells for a single Kerberos realm.
.SH "PRIVILEGE REQUIRED"
The issuer must be able to read (for \fBasetkey list\fR) and write (for
\fBasetkey add\fR and \fBasetkey delete\fR) the KeyFile, normally
\fI/usr/afs/etc/KeyFile\fR.  In practice, this means that the issuer must be
the local superuser \f(CWroot\fR on the AFS file server or database server.
For \fBasetkey add\fR, the issuer must also be able to read the specified
keytab file.
.SH "SEE ALSO"
the \fIKeyFile(5)\fR manpage,
the \fIbos_addkey(8)\fR manpage,
the \fIbos_listkeys(8)\fR manpage,
the \fIbos_removekey(8)\fR manpage,
\fIkadmin\fR\|(8),
\fIkvno\fR\|(1)
.SH "COPYRIGHT"
Copyright 2006 Russ Allbery <rra@stanford.edu>
.PP
This documentation is covered by the IBM Public License Version 1.0.  This
man page was written by Russ Allbery for OpenAFS.

.rn }` ''
.IX Title "asetkey 8"
.IX Name "asetkey - Add a key from a keytab to an AFS KeyFile"

.IX Header "NAME"

.IX Header "SYNOPSIS"

.IX Header "DESCRIPTION"

.IX Header "CAUTIONS"

.IX Header "EXAMPLES"

.IX Header "PRIVILEGE REQUIRED"

.IX Header "SEE ALSO"

.IX Header "COPYRIGHT"

