<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 3//EN">
<HTML><HEAD>
<TITLE>管理の手引き</TITLE>
<!-- Begin Header Records  ========================================== -->
<!-- E:\IDWB\TEMP\idwt2118\AUAGD000.SCR converted by idb2h R4.2 (359) -->
<!-- ID Workbench Version (OS2) on 24 Dec 1999 at 12:07:32            -->
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=Shift_JIS">
<META HTTP-EQUIV="updated" CONTENT="Fri, 24 Dec 1999 12:07:30">
<META HTTP-EQUIV="review" CONTENT="Sun, 24 Dec 2000 12:07:30">
<META HTTP-EQUIV="expires" CONTENT="Mon, 24 Dec 2001 12:07:30">
</HEAD><BODY>
<!-- (C) IBM Corporation 2000. All Rights Reserved    --> 
<BODY bgcolor="ffffff"> 
<!-- End Header Records  ============================================ -->
<A NAME="Top_Of_Page"></A>
<H1>管理の手引き</H1>
<HR><H1><A NAME="HDRWQ383" HREF="auagd002.htm#ToC_320">AFS データのバックアップと復元</A></H1>
<P>本章では、AFS データのバックアップおよび復元方法、およびバックアップ・データベースの管理方法を説明しています。これは、
<A HREF="auagd011.htm#HDRWQ334">AFS バックアップ・システムの構成</A> の説明に従い、すべてのバックアップ・システム・コンポーネントの構成を完了していることを前提としています。
<HR><H2><A NAME="HDRWQ384" HREF="auagd002.htm#ToC_321">手順の概要</A></H2>
<P>この章では、指示されたコマンドを使って以下のタスクを実行する手順について説明します。
<BR>
<TABLE WIDTH="100%">
<TR>
<TD ALIGN="LEFT" VALIGN="TOP" WIDTH="70%">対話モードに入る
</TD><TD ALIGN="LEFT" VALIGN="TOP" WIDTH="30%"><B>backup (interactive)</B>
</TD></TR><TR>
<TD ALIGN="LEFT" VALIGN="TOP" WIDTH="70%">対話モードを出る
</TD><TD ALIGN="LEFT" VALIGN="TOP" WIDTH="30%"><B>(backup) quit</B>
</TD></TR><TR>
<TD ALIGN="LEFT" VALIGN="TOP" WIDTH="70%">対話モードの操作をリストする
</TD><TD ALIGN="LEFT" VALIGN="TOP" WIDTH="30%"><B>(backup) jobs</B>
</TD></TR><TR>
<TD ALIGN="LEFT" VALIGN="TOP" WIDTH="70%">対話モードの操作を取り消す
</TD><TD ALIGN="LEFT" VALIGN="TOP" WIDTH="30%"><B>(backup) kill</B>
</TD></TR><TR>
<TD ALIGN="LEFT" VALIGN="TOP" WIDTH="70%">テープ・コーディネーターを開始する
</TD><TD ALIGN="LEFT" VALIGN="TOP" WIDTH="30%"><B>butc</B>
</TD></TR><TR>
<TD ALIGN="LEFT" VALIGN="TOP" WIDTH="70%">テープ・コーディネーターを停止する
</TD><TD ALIGN="LEFT" VALIGN="TOP" WIDTH="30%">&lt;<B>Ctrl-c</B>>
</TD></TR><TR>
<TD ALIGN="LEFT" VALIGN="TOP" WIDTH="70%">テープ・コーディネーターの状況を検査する
</TD><TD ALIGN="LEFT" VALIGN="TOP" WIDTH="30%"><B>backup status</B>
</TD></TR><TR>
<TD ALIGN="LEFT" VALIGN="TOP" WIDTH="70%">データをバックアップする
</TD><TD ALIGN="LEFT" VALIGN="TOP" WIDTH="30%"><B>backup dump</B>
</TD></TR><TR>
<TD ALIGN="LEFT" VALIGN="TOP" WIDTH="70%">ダンプ・レコードの表示
</TD><TD ALIGN="LEFT" VALIGN="TOP" WIDTH="30%"><B>backup dumpinfo</B>
</TD></TR><TR>
<TD ALIGN="LEFT" VALIGN="TOP" WIDTH="70%">ボリュームのダンプ履歴を表示する
</TD><TD ALIGN="LEFT" VALIGN="TOP" WIDTH="30%"><B>backup volinfo</B>
</TD></TR><TR>
<TD ALIGN="LEFT" VALIGN="TOP" WIDTH="70%">テープのコンテンツをスキャンする
</TD><TD ALIGN="LEFT" VALIGN="TOP" WIDTH="30%"><B>backup scantape</B>
</TD></TR><TR>
<TD ALIGN="LEFT" VALIGN="TOP" WIDTH="70%">ボリュームを復元する
</TD><TD ALIGN="LEFT" VALIGN="TOP" WIDTH="30%"><B>backup volrestore</B>
</TD></TR><TR>
<TD ALIGN="LEFT" VALIGN="TOP" WIDTH="70%">パーティションを復元する
</TD><TD ALIGN="LEFT" VALIGN="TOP" WIDTH="30%"><B>backup diskrestore</B>
</TD></TR><TR>
<TD ALIGN="LEFT" VALIGN="TOP" WIDTH="70%">ボリューム・グループの復元
</TD><TD ALIGN="LEFT" VALIGN="TOP" WIDTH="30%"><B>backup volsetrestore</B>
</TD></TR><TR>
<TD ALIGN="LEFT" VALIGN="TOP" WIDTH="70%">バックアップ・データベースの整合性の検証
</TD><TD ALIGN="LEFT" VALIGN="TOP" WIDTH="30%"><B>backup dbverify</B>
</TD></TR><TR>
<TD ALIGN="LEFT" VALIGN="TOP" WIDTH="70%">バックアップ・データベース内の破壊の修復
</TD><TD ALIGN="LEFT" VALIGN="TOP" WIDTH="30%"><B>backup savedb</B> および
<B>backup restoredb</B>
</TD></TR><TR>
<TD ALIGN="LEFT" VALIGN="TOP" WIDTH="70%">ダンプ・セットをバックアップ・データベースから削除する
</TD><TD ALIGN="LEFT" VALIGN="TOP" WIDTH="30%"><B>backup deletedump</B>
</TD></TR></TABLE>
<HR><H2><A NAME="HDRWQ402" HREF="auagd002.htm#ToC_322">バックアップ・システムのインターフェースの使用</A></H2>
<A NAME="IDX6969"></A>
<P>バックアップ操作を実行する場合、以下の 3 つのバックアップ・システム・コンポーネントとの対話操作を行います。
<UL>
<LI><B>backup</B> スイートのコマンドを発行して、バックアップ操作を開始します。任意の AFS クライアントまたはサーバーのコマンド・シェルで、アクセス可能な <B>backup</B>
バイナリーからのコマンドを発行できます (または、シェル・スクリプトでこれらを呼び出せます)。通常の構成では、バイナリーは、サーバー・マシンの <B>/usr/afs/bin</B>、およびクライアント・マシンの <B>/usr/afsws/etc</B> ディレクトリーに配置されています。
<P>
<P>このスイートは、バックアップ・サーバーおよびボリューム・ロケーション (VL) サーバーへの持続接続に関する複数のコマンドを発行できる対話モードを提供します。対話モードでは、いくつかの便利な機能が用意されています。詳細については、<A HREF="#HDRWQ404">対話モードおよび正規コマンド・モードの使用</A> を参照してください。
<P>
<P>オペレーティング・システムによっては、そのシステムの <B>backup</B> コマンドを含むものもあります。このようなオペレーティング・システムを実行するマシンの場合、これを構成して、任意の <B>backup</B> バイナリーにアクセスするようにしてください。
</LI><LI>バックアップ操作を実行して、テープ装置、またはバックアップ・データ・ファイル間との読み取りまたは書き込みを行う前に、該当するテープ・コーディネーター・マシンへの専用接続をオープンし、装置またはファイルを処理をするテープ・コーディネーター
(<B>butc</B>) プロセスを開始する必要があります。
<B>butc</B> プロセスは、操作の実行中、または実行が可能である間は、専用接続に対して実行が継続されていなくてはなりません。詳細については、
<A HREF="#HDRWQ407">テープ・コーディネーター・プロセスの開始および停止</A>を参照してください。
</LI><LI>バックアップ・サーバー (<B>buserver</B>) プロセスは、データベース・サーバー・マシン上で実行する必要があります。ほとんどのバックアップ操作では、バックアップ・データベースの情報へのアクセス、またはその変更が要求されるためです。<I>AFS インストールの手引き</I> では、バックアップ・サーバーの構成方法を説明しています。
</LI></UL>
<P>バックアップ・システム・パフォーマンスに矛盾がないように、
3 つのバイナリー (<B>backup</B>、<B>butc</B>、および <B>buserver</B>) すべての AFS ビルド・レベルが一致する必要があります。ビルド・レベルの表示方法は、<A HREF="auagd008.htm#HDRWQ152">バイナリー・ファイルの作成レベルの表示</A> を参照してください。
<P><H3><A NAME="HDRWQ403" HREF="auagd002.htm#ToC_323">ローカル・スーパーユーザー root、または外部セルからのバックアップ操作の実行</A></H3>
<A NAME="IDX6970"></A>
<A NAME="IDX6971"></A>
<A NAME="IDX6972"></A>
<P>デフォルトでは、バックアップ操作で使用するボリュームおよびバックアップ・データベースは、
<B>/usr/vice/etc/ThisCell</B> ファイル
(テープ・コーディネーター・マシンおよび <B>backup</B> コマンドを実行するマシンにあります)
に名前のあるセルに属するサーバー・マシンに配置されています。同様に、ほとんどの <B>backup</B> コマンドの発行においては、ローカル・セルの <B>/usr/afs/etc/UserList</B> ファイルにリストされている AFS トークンを ID に持つ必要があります (通常、セル内のすべてのサーバー・マシンについて同じ)。ただし、バックアップ操作の実行は、外部セルのボリュームまたはバックアップ・データベース上で行うことができ、この際、特権 AFS の ID ではなくローカル・スーパーユーザー <B>root</B> としてログインします。
<P>ローカル・セルのボリュームで、ローカル・セルのマシンを使用してバックアップ操作を行うには、その外部セルを、テープ・コーディネーターおよび <B>backup</B> コマンド・インタープリターの実行セルに指定する必要があります。以下の 2 つの方法のどちらかを使用します。どちらの方法でも、外部セルの <B>/usr/afs/etc/UserList</B> ファイルにリストされている管理者トークンが必要です。
<UL>
<LI><B>backup</B> コマンドおよび <B>butc</B> コマンドを発行する前に、両方のコマンド・シェルの AFSCELL 環境変数を外部セル名に設定します。
</LI><LI><B>butc</B> およびすべての <B>backup</B> コマンドには <B>-cell</B> 引き数を組み込みます。
<B>backup (対話モード)</B> コマンドに引き数を組み込む場合、これは対話式セッション中発行されるすべてのコマンドに適用されます。
</LI></UL>
<P>管理者 AFS トークンなしにバックアップ操作を実行するには、テープ・コーディネーター・マシンおよび <B>backup</B> コマンドを発行するマシンのどちらとも、ローカル・スーパーユーザー <B>root</B> としてログオンする必要があります。両方のマシンともサーバー・マシンであり、少なくとも、他のサーバー・マシンのファイルに一致する <B>/usr/afs/etc/KeyFile</B> ファイルがある必要があります。次に <B>-localauth</B> 引き数を、
<B>butc</B> コマンドおよびすべての <B>backup</B> コマンド (または <B>backup (対話モード)</B> コマンド) の両方に組み込みます。テープ・コーディネーターおよび <B>backup</B> コマンド・インタープリターは、ローカル・ファイルの <B>/usr/afs/etc/KeyFile</B> ファイル中の最新のキー・バージョン数のサーバー暗号化鍵を使用してサーバー・チケットを構成し、これをローカルの <B>/usr/afs/etc/ThisCell</B> ファイルに含まれるバックアップ・サーバー、ボリューム・サーバー、および VL サーバーに提示します。チケットには有効期限はありません。
<P>同じコマンドで <B>-cell</B> および <B>-localauth</B> オプションを組み合わせることはできません。また、各コマンドとも AFSCELL 環境変数または
<B>/usr/vice/etc/ThisCell</B> ファイルに定義された設定を上書きします。
<P><H3><A NAME="HDRWQ404" HREF="auagd002.htm#ToC_324">対話モードおよび正規コマンド・モードの使用</A></H3>
<A NAME="IDX6973"></A>
<A NAME="IDX6974"></A>
<P><B>backup</B> コマンド・スイートは、バックアップ・サーバーおよび VL サーバーへの持続接続に関する複数のコマンドを発行できる、
<I>対話モード</I> を提供します。対話モードは、以下の機能を提供します。
<UL>
<LI>通常のコマンド・シェル・プロンプトの代わりに <TT>backup></TT> プロンプトが表示されます。
</LI><LI>コマンド名から最初の <B>backup</B> 文字列が省略できます。操作コードおよびオプション名のみを入力します。
</LI><LI><B>backup</B> スイートに含まれないコマンドは発行できません。
</LI><LI>対話モードに入る際、管理者 AFS ID を前提とする、または外部セルを指定する場合、これは対話式セッション中発行されるすべてのコマンドに適用されます。
<A HREF="#HDRWQ403">ローカル・スーパーユーザー root、または外部セルからのバックアップ操作の実行</A> を参照してください。
</LI><LI>シェルのメタ文字を二重引用符で囲む必要がありません。
</LI></UL>
<A NAME="IDX6975"></A>
<A NAME="IDX6976"></A>
<P>対話モードでバックアップ操作を開始する場合、バックアップ・システムは <I>ジョブ ID 番号</I> を割り当てます。
<B>(backup) jobs</B> コマンドを使用すると、現在の操作および保留中の操作のリストが表示できます。説明は、<A HREF="#HDRWQ405">対話モードで保留または実行中のジョブを表示する</A> を参照してください。
(正規および対話モードの両方で、テープ・コーディネーターは、
<B>backup</B> コマンドで開始した各操作に対して <I>タスク ID 番号</I> を割り当てます。タスク ID 番号は、
<B>backup status</B> コマンドでトラックすることができます。<A HREF="#HDRWQ407">テープ・コーディネーター・プロセスの開始および停止</A> を参照してください。)
<P><B>(backup) kill</B> コマンドを使用すると、対話モードの操作を取り消すことができます。説明は、<A HREF="#HDRWQ406">対話モードで操作を取り消すには</A> を参照してください。ただし、ダンプ操作は取り消さない方がよいでしょう。作成されるダンプが不完全なものとなり、復元操作を中止した場合は、ボリュームが矛盾した状態になるか、これがサーバー・マシンから完全に除去されてしまう場合があるためです。詳細は、<A HREF="#HDRWQ412">データのバックアップ</A> および
<A HREF="#HDRWQ422">データの復元と回復</A> を参照してください。
<P><B>(backup) jobs</B> および <B>(backup) kill</B> コマンドは対話モードでのみ使用可能で、正規コマンド・モードでは同等の機能のコマンドは存在しません。
<A NAME="IDX6977"></A>
<A NAME="IDX6978"></A>
<A NAME="IDX6979"></A>
<A NAME="IDX6980"></A>
<P><H3><A NAME="Header_325" HREF="auagd002.htm#ToC_325">対話モードに入るには</A></H3>
<OL TYPE=1>
<LI><B>/usr/afs/etc/UserList</B> ファイルにリストされているユーザーとして認証されていることを検証します。対話モードに入るだけでは特権は必要とされませんが、その他のほとんどの <B>backup</B> コマンドでは特権が必要です。また、モードに入る際に前提とする AFS ID は、内部で発行するすべてのコマンドに適用されます。必要な場合には、<B>bos listusers</B> コマンドを発行します。このコマンドについては、<A HREF="auagd021.htm#HDRWQ816">UserList ファイルのユーザーの表示</A>で詳しく説明しています。
<P>
<PRE>   % <B>bos listusers</B> &lt;<VAR>machine name</VAR>>
</PRE>
</LI><LI>システム・プロンプトで <B>backup (対話式)</B> コマンドを発行します。
<TT>backup></TT> プロンプトが表示されます。
<B>-localauth</B> および <B>-cell</B> オプションのいずれかを組み込めますが、両方を組み込むことはできません (<A HREF="#HDRWQ403">ローカル・スーパーユーザー root、または外部セルからのバックアップ操作の実行</A> を参照してください)。
<P>
<PRE>   % <B>backup</B>
   backup>
</PRE>
</LI></OL>
<A NAME="IDX6981"></A>
<A NAME="IDX6982"></A>
<A NAME="IDX6983"></A>
<A NAME="IDX6984"></A>
<P><H3><A NAME="Header_326" HREF="auagd002.htm#ToC_326">対話モードの終了</A></H3>
<P><B></B>
<OL TYPE=1>
<LI><TT>backup></TT> プロンプトで <B>quit</B> コマンドを発行します。コマンドが正常に実行されると、コマンド・シェル・プロンプトが表示されます
(保留または現在実行中のジョブがない場合のみ)。保留または現在実行中のジョブを表示、および取り消すには、<A HREF="#HDRWQ405">対話モードで保留または実行中のジョブを表示する</A>
および <A HREF="#HDRWQ406">対話モードで操作を取り消すには</A> の指示に従ってください。
<P>
<PRE>   backup>  <B>quit</B>
   %
</PRE>
</LI></OL>
<A NAME="IDX6985"></A>
<A NAME="IDX6986"></A>
<A NAME="IDX6987"></A>
<A NAME="IDX6988"></A>
<A NAME="IDX6989"></A>
<A NAME="IDX6990"></A>
<P><H3><A NAME="HDRWQ405" HREF="auagd002.htm#ToC_327">対話モードで保留または実行中のジョブを表示する</A></H3>
<OL TYPE=1>
<LI><TT>backup></TT> プロンプトで <B>jobs</B> コマンドを発行します。
<P>
<PRE>   backup> <B>jobs</B>
</PRE>
<P>
<P>ここで、
<P>
<DL>
<P><DT><B>j
</B><DD>は、<B>jobs</B> の受け入れ可能な省略形です。
</DL>
</LI></OL>
<P>出力には、現行対話セッション中に <B>backup</B> コマンド・インタープリターが使用するトークンの有効期限日付および時刻が必ず含まれています。フォーマットは、次のとおりです。
<PRE>      <VAR>date</VAR>   <VAR>time</VAR>: TOKEN EXPIRATION
</PRE>
<P>スケジュールされているダンプ・オペレーションに対して指定した実行日付および時刻が、
<I>date time</I> より遅い場合、個々の行が (以下の段落で説明するように) この行の下に表示され、現行トークンがこれを使用できないことを示します。
<P>対話モードに入るときに、<B>backup</B> コマンドの発行者が
<B>-localauth</B> フラグを組み込んだ場合、代わりに行は次のように読み取ります。
<PRE>   :  TOKEN NEVER EXPIRES
</PRE>
<P>スケジュールされたダンプ・オペレーションの項目の形式は以下のとおりです。
<PRE>   Job <VAR>job_ID</VAR>:  <VAR>timestamp</VAR>:  dump  <VAR>volume_set</VAR>  <VAR>dump_level</VAR>
</PRE>
<P>ここで、
<DL>
<P><DT><B><VAR>job_ID</VAR>
</B><DD>バックアップ・システムにより割り当てられたジョブの ID 番号。
<P><DT><B><VAR>timestamp</VAR>
</B><DD>ダンプ・オペレーションが開始される日付および時刻を示します。形式は、
<I>month</I>/<I>date</I>/<I>year</I> <I>hours</I>:<I>minutes</I> (24 時形式) です。
<P><DT><B><VAR>volume_set</VAR>
</B><DD>ダンプするボリューム・セット
<P><DT><B><VAR>dump_level</VAR>
</B><DD>ダンプ・オペレーションを実行するダンプ・レベルを示します。
</DL>
<P>任意のほかのタイプの保留中または実行中のオペレーションについての行の形式は、以下のとおりです。
<PRE>   Job <VAR>job_ID</VAR>:  <VAR>operation</VAR>  <VAR>status</VAR>
</PRE>
<P>ここで、
<DL>
<P><DT><B><VAR>job_ID</VAR>
</B><DD>バックアップ・システムにより割り当てられたジョブの ID 番号。
<P><DT><B><VAR>operation</VAR>
</B><DD>指定したコマンドで開始されたテープ・コーディネーターが実行しているオペレーション。
<P>
<DL>
<P><DT><B><TT>Dump</TT> <TT>(</TT><VAR>dump name</VAR><TT>)</TT>
</B><DD><B>backup dump</B> コマンドによって開始されます。<VAR>dump name</VAR> の形式は以下のとおりです。
<P>
<P><VAR>volume_set_name</VAR><B>.</B><VAR>dump_level_name</VAR>
<P><DT><B><TT>Restore</TT>
</B><DD><B>backup diskrestore</B>、<B>backup volrestore</B>、または <B>backup volsetrestore</B> コマンドによって開始されます。
<P><DT><B><TT>Labeltape</TT> <TT>(</TT><VAR>tape_label</VAR><TT>)</TT>
</B><DD><B>backup labeltape</B> コマンドによって開始されます。<VAR>tape_label</VAR> は、<B>backup labeltape</B> コマンドの <B>-name</B> または <B>-pname</B> 引き数によって指定される名前です。
<P><DT><B><TT>Scantape</TT>
</B><DD><B>backup scantape</B> コマンドによって開始されます。
<P><DT><B><TT>SaveDb</TT>
</B><DD><B>backup savedb</B> コマンドによって開始されます。
<P><DT><B><TT>RestoreDb</TT>
</B><DD><B>backup restoredb</B> コマンドによって開始されます。
</DL>
<P><DT><B><VAR>status</VAR>
</B><DD>以下のメッセージの 1 つにより、ジョブの現在の状況を示します。メッセージが表示されない場合は、ジョブはまだ保留中であるかまたは終了しています。
<P>
<DL>
<P><DT><B><VAR>number</VAR> <TT>Kbytes, volume</TT> <VAR>volume_name</VAR>
</B><DD>ダンプ・オペレーションの実行中の場合、テープまたはバックアップ・データ・ファイルにこれまでコピーされたキロバイト数および現在ダンプされているボリューム。
<P><DT><B><VAR>number</VAR> <TT>Kbytes, restore.volume</TT>
</B><DD>復元オペレーションの実行中の場合、テープまたはバックアップ・データ・ファイルから AFS にこれまでコピーされたキロバイト数。
<P><DT><B><TT>[abort requested]</TT>
</B><DD><B>(backup) kill</B> コマンドが発行されたが、その終了シグナルは、まだテープ・コーディネーターには送信されていない。
<P><DT><B><TT>[abort sent]</TT>
</B><DD>オペレーションは <B>(backup) kill</B> コマンドにより取り消されたことを意味する。バックアップ・システムがオペレーションを待ち行列から削除するか、あるいは実行を停止すると、そのオペレーションは、このコマンドからの出力には表示されなくなります。
<P><DT><B><TT>[butc contact lost]</TT>
</B><DD><B>backup</B> コマンド・インタープリターがテープ・コーディネーターに到達できない。このメッセージは、オペレーションを処理しているテープ・コーディネーターが、オペレーションの実行中に終了されたか失敗したことを示しているか、あるいはテープ・コーディネーターに対する接続がタイムアウトになったことを意味します。
<P><DT><B><TT>[done]</TT>
</B><DD>テープ・コーディネーターはオペレーションを終了したことを意味する。
<P><DT><B><TT>[drive wait]</TT>
</B><DD>オペレーションが、指定されたテープ・ドライブが空きになるのを待機している。
<P><DT><B><TT>[operator wait]</TT>
</B><DD>テープ・コーディネーターは、バックアップ・オペレーターがテープをドライブに挿入するのを待機していることを示す。
</DL>
</DL>
<A NAME="IDX6991"></A>
<A NAME="IDX6992"></A>
<A NAME="IDX6993"></A>
<A NAME="IDX6994"></A>
<A NAME="IDX6995"></A>
<P><H3><A NAME="HDRWQ406" HREF="auagd002.htm#ToC_328">対話モードで操作を取り消すには</A></H3>
<OL TYPE=1>
<LI><TT>backup></TT> プロンプトで <B>jobs</B> コマンドを発行して、取り消す操作のジョブ ID 番号を表示します。詳細は、<A HREF="#HDRWQ405">対話モードで保留または実行中のジョブを表示する</A> を参照してください。
<P>
<PRE>   backup> <B>jobs</B>
</PRE>
</LI><LI><B>(backup) kill</B> コマンドを発行して操作を取り消します。
<P>
<PRE>   backup> <B>kill</B> &lt;<VAR>job ID or dump set name</VAR>>
</PRE>
<P>
<P>ここで、
<P>
<DL>
<P><DT><B>k
</B><DD>は、<B>kill</B> の受け入れ可能な省略形です。
<P><DT><B><VAR>job ID or dump set name</VAR>
</B><DD><B>jobs</B> コマンドにより報告されたジョブ ID 番号で取り消すものを指定するか、または (ダンプ操作の場合のみ)
<VAR>volume_set_name</VAR>.<VAR>dump_level_name</VAR> 形式のダンプ名を指定します。
</DL>
</LI></OL>
<P><H3><A NAME="HDRWQ407" HREF="auagd002.htm#ToC_329">テープ・コーディネーター・プロセスの開始および停止</A></H3>
<A NAME="IDX6996"></A>
<P>バックアップ操作を実行して、テープ装置、またはバックアップ・データ・ファイル間との読み取りまたは書き込みを行う前に、ドライブまたはファイルを処理するテープ・コーディネーター (<B>butc</B>) プロセスを開始する必要があります。この機能グループでは、テープ・コーディネーター・プロセスを開始、停止、および状況の検査をする方法を説明します。これらの命令を使用するには、テープ・コーディネーター・マシンが構成済みであり、バックアップ・データベースのテープ・コーディネーター項目が作成されている必要があります
(<A HREF="auagd011.htm#HDRWQ361">テープ・コーディネーター・マシンおよびテープ装置の構成</A> の指示を参照してください)。
<P>
<A NAME="IDX6997"></A>
<A NAME="IDX6998"></A>
テープ・コーディネーターは、実行する各操作に <I>タスク ID 番号</I> を割り当てます。この番号は、対話操作で <B>backup</B> コマンド・インタープリターにより割り当てられたジョブ ID 番号
(<A HREF="#HDRWQ404">対話モードおよび正規コマンド・モードの使用</A> を参照) とは別個のものです。テープ・コーディネーターは、ログおよびエラー・ファイルに書き込んだタスク ID 番号を、画面上のトレースおよびメッセージに報告します。テープ・コーディネーターの実行中または保留中のタスク ID 番号を表示するには、<B>backup status</B> コマンドを発行します。
<A NAME="IDX6999"></A>
<A NAME="IDX7000"></A>
<A NAME="IDX7001"></A>
<P><H3><A NAME="HDRWQ408" HREF="auagd002.htm#ToC_330">テープ・コーディネーター・プロセスを開始するには</A></H3>
<OL TYPE=1>
<LI>テープ・コーディネーターがボリューム・データおよびバックアップ・データベースにアクセスするセルの <B>/usr/afs/etc/UserList</B> ファイルにリストされているユーザーとして認証されていることを検証します。必要な場合には、<B>bos listusers</B> コマンドを発行します。このコマンドについては、
<A HREF="auagd021.htm#HDRWQ816">UserList ファイルのユーザーの表示</A>で詳しく説明しています。
<P>
<PRE>   % <B>bos listusers</B> &lt;<VAR>machine name</VAR>>
</PRE>
<P>
<P>または、ローカル・スーパーユーザー <B>root</B> としてファイル・サーバー・マシンにログインします (<A HREF="#LIWQ409">3</A> のステップを参照)。
</LI><LI>テープ・コーディネーターのログ、およびローカル <B>/usr/afs/backup</B> ディレクトリーのエラー・ファイル (<B>TE_</B><VAR>device_name</VAR> および <B>TL_</B><VAR>device_name</VAR> ファイル) に書き込みができることを検証する。ログ・ファイルとエラー・ファイルが存在していない場合は、
<B>/usr/afs/backup</B> ディレクトリー内のファイルに挿入および書き込みができることが必要です。
</LI><LI><A NAME="LIWQ409"></A>(<B>telnet</B> または <B>rlogin</B> などのコマンドを使用して)
テープ装置を駆動する、またはそのローカル・ディスクがディスク・データ・ファイルを収納しているテープ・コーディネーター・マシンに接続をオープンする。テープ・コーディネーターは、テープ・コーディネーターが要求を受け入れるために、また、テープ・コーディネーターが要求を実行中に、オープンしたままでなければならない専用の接続またはウィンドウを使用します。
<P>
<P>次のステップで、
<B>-localauth</B> フラグを <B>butc</B> コマンドに組み込むことを計画する場合は、ローカル・スーパーユーザー <B>root</B> としてログインします。
</LI><LI><A NAME="LIWQ410"></A><B>butc</B> コマンドを発行してテープ・コーディネーターを開始する。
<B>-localauth</B> および <B>-cell</B> オプションのいずれかを組み込めますが、両方を組み込むことはできません (<A HREF="#HDRWQ403">ローカル・スーパーユーザー root、または外部セルからのバックアップ操作の実行</A> を参照してください)。
<P>
<PRE>   % <B>butc</B> [&lt;<VAR>port offset</VAR>>]  [<B>-debuglevel</B> &lt;<VAR>trace level</VAR>>]  \
          [<B>-cell</B> &lt;<VAR>cellname</VAR>>] [<B>-noautoquery</B>] [<B>-localauth</B>]
</PRE>
<P>
<P>ここで、
<P>
<DL>
<P><DT><B>butc
</B><DD>完全な形式でタイプする必要があります。
<P><DT><B><VAR>port offset</VAR>
</B><DD>テープ・コーディネーターのポート・オフセット番号を指定します。デフォルト値の <B>0</B> (ゼロ) が適切でない場合には、この引き数を指定しなければなりません。
<P><DT><B>-debuglevel
</B><DD>テープ・コーディネーターが標準出力ストリーム (stdout) に書き込むトレース・メッセージのタイプを指定します。以下の 3 つの値を与えるか、あるいは、この引き数を省略を省略してメッセージのデフォルト・タイプを表示します
(<B>0</B> [ゼロ] の値の設定に等しい)。
<UL>
<LI><B>0</B>: テープ・コーディネーターは、バックアップ・オペレーターと通信するのに必要な最小限の数のメッセージだけを生成する。これらのメッセージには、追加テープの挿入に対するプロンプト、およびオペレーションのエラー、開始、または完了を示すメッセージが含まれます。
</LI><LI><B>1</B>:
レベル <B>0</B> で表示されたメッセージに加えて、テープ・コーディネーターは、ダンプまたは復元されている各ボリュームの名前を表示する。
</LI><LI><B>2</B>:
レベル <B>0</B> および <B>1</B> で表示されてメッセージに加えて、テープ・コーディネーターは、すべてのメッセージを表示する。また、テープ・コーディネーターは、自己のログ・ファイル (<B>/usr/afs/backup/TL_</B><VAR>device_name</VAR>) にも書き込む。
</LI></UL>
<P><DT><B><VAR>cellname</VAR>
</B><DD>バックアップ・オペレーションを実行するセルの名前です (関係のあるボリュームが常駐し、バックアップ・サーバー・プロセスが実行しているセル)。この引き数を省略すると、テープ・コーディネーターは、ローカルの <B>/usr/vice/etc/ThisCell</B> ファイルで定義されたように自己のホーム・セルを使用します。この引き数を <B>-localauth</B>フラグと結合してはいけません。
<P><DT><B>-noautoquery
</B><DD>各オペレーションに必要な最初のテープに対するテープ・コーディネーターのプロンプトを使用不可にします。このフラグを組み込むことの利点および結果についての説明は、
<A HREF="auagd011.htm#HDRWQ378">最初のテープの検索またはプロンプトの除去</A> を参照してください。
<P><DT><B>-localauth
</B><DD>ローカルの <B>/usr/afs/etc/KeyFile</B> ファイルからの鍵を使用して、サーバー・チケットを構成します。<B>butc</B> プロセスは、相互の認証中にサーバー・チケットをバックアップ・サーバー、ボリューム・サーバー、および VL サーバーに提示します。このフラグを組み込むには、ユーザーは、ファイル・サーバー・マシンにローカル・スーパーユーザー <B>root</B> としてログインしていなければならず、このフラグを <B>-cell</B> 引き数と結合することはできません。
</DL>
</LI></OL>
<A NAME="IDX7002"></A>
<P><H3><A NAME="Header_331" HREF="auagd002.htm#ToC_331">テープ・コーディネーター・プロセスを停止するには</A></H3>
<OL TYPE=1>
<LI>テープ・コーディネーターとの専用接続に対し、&lt;<B>Ctrl-c</B>> などの割り込みシグナルを入力します。
</LI></OL>
<A NAME="IDX7003"></A>
<A NAME="IDX7004"></A>
<A NAME="IDX7005"></A>
<P><H3><A NAME="HDRWQ411" HREF="auagd002.htm#ToC_332">テープ・コーディネーター・プロセスの状況を検査するには</A></H3>
<OL TYPE=1>
<LI><B>/usr/afs/etc/UserList</B> ファイルにリストされているユーザーとして認証されていることを検証します。必要な場合には、<B>bos listusers</B> コマンドを発行します。このコマンドについては、<A HREF="auagd021.htm#HDRWQ816">UserList ファイルのユーザーの表示</A>で詳しく説明しています。
<P>
<PRE>   % <B>bos listusers</B> &lt;<VAR>machine name</VAR>>
</PRE>
</LI><LI><B>backup status</B> コマンドを入力します。
<P>
<PRE>   % <B>backup status</B> [&lt;<VAR>TC port offset</VAR>>]
</PRE>
<P>
<P>ここで、
<P>
<DL>
<P><DT><B>st
</B><DD><B>status</B> の受け入れ可能な最も短い省略形です。
<P><DT><B><VAR>TC port offset</VAR>
</B><DD>テープ・コーディネーターのポート・オフセット番号を指定します。デフォルト値の <B>0</B> (ゼロ) が適切でない場合には、この引き数を指定しなければなりません。
</DL>
</LI></OL>
<P>以下のメッセージは、テープ・コーディネーターが、現在、オペレーションを実行していないことを示します。
<PRE>   Tape coordinator is idle
</PRE>
<P>それ以外は、実行中または保留中のオペレーションに対して、以下の形式のメッセージが出力に組み込まれます。
<PRE>   Task <VAR>task_ID</VAR>:  <VAR>operation</VAR>:   <VAR>status</VAR>
</PRE>
<P>ここで、
<DL>
<P><DT><B><VAR>task_ID</VAR>
</B><DD>テープ・コーディネーターにより割り当てられたタスクの ID 番号。テープ・コーディネーターのポート・オフセット番号から始まります。
<P><DT><B><VAR>operation</VAR>
</B><DD>指定したコマンドで開始されたテープ・コーディネーターが実行しているオペレーション。
<UL>
<LI><TT>Dump</TT> (<B>backup dump</B> コマンド)
</LI><LI><TT>Restore</TT> (<B>backup diskrestore</B>、<B>backup volrestore</B>、または <B>backup volsetrestore</B> コマンド)
</LI><LI><TT>Labeltape</TT> (<B>backup labeltape</B> コマンド)
</LI><LI><TT>Scantape</TT> (<B>backup scantape</B> コマンド)
</LI><LI><TT>SaveDb</TT> (<B>backup savedb</B> コマンド)
</LI><LI><TT>RestoreDb</TT> (<B>backup restoredb</B> コマンド)
</LI></UL>
<P><DT><B><VAR>status</VAR>
</B><DD>以下のメッセージの 1 つにより、ジョブの現在の状況を示します。
<P>
<DL>
<P><DT><B><VAR>number</VAR> <TT>Kbytes transferred, volume</TT> <VAR>volume_name</VAR>
</B><DD>ダンプ・オペレーションの実行中の場合、テープまたはバックアップ・データ・ファイルにこれまでコピーされたキロバイト数および現在ダンプされているボリューム。
<P><DT><B><VAR>number</VAR> <TT>Kbytes, restore.volume</TT>
</B><DD>復元オペレーションの実行中の場合、テープまたはバックアップ・データ・ファイルから AFS にこれまでコピーされたキロバイト数。
<P><DT><B><TT>[abort requested]</TT>
</B><DD><B>(backup) kill</B> コマンドが発行されたが、その終了シグナルは、まだテープ・コーディネーターには送信されていない。
<P><DT><B><TT>[abort sent]</TT>
</B><DD>オペレーションは <B>(backup) kill</B> コマンドにより取り消されたことを意味する。バックアップ・システムがオペレーションを待ち行列から削除するか、あるいは実行を停止すると、そのオペレーションは、このコマンドからの出力には表示されなくなります。
<P><DT><B><TT>[butc contact lost]</TT>
</B><DD><B>backup</B> コマンド・インタープリターがテープ・コーディネーターに到達できない。このメッセージは、オペレーションを処理しているテープ・コーディネーターが、オペレーションの実行中に終了されたか失敗したことを示しているか、あるいはテープ・コーディネーターに対する接続がタイムアウトになったことを意味します。
<P><DT><B><TT>[done]</TT>
</B><DD>テープ・コーディネーターはオペレーションを終了したことを意味する。
<P><DT><B><TT>[drive wait]</TT>
</B><DD>オペレーションが、指定されたテープ・ドライブが空きになるのを待機している。
<P><DT><B><TT>[operator wait]</TT>
</B><DD>テープ・コーディネーターは、バックアップ・オペレーターがテープをドライブに挿入するのを待機していることを示す。
</DL>
</DL>
<HR><H2><A NAME="HDRWQ412" HREF="auagd002.htm#ToC_333">データのバックアップ</A></H2>
<A NAME="IDX7006"></A>
<A NAME="IDX7007"></A>
<A NAME="IDX7008"></A>
<A NAME="IDX7009"></A>
<A NAME="IDX7010"></A>
<A NAME="IDX7011"></A>
<A NAME="IDX7012"></A>
<A NAME="IDX7013"></A>
<A NAME="IDX7014"></A>
<A NAME="IDX7015"></A>
<A NAME="IDX7016"></A>
<A NAME="IDX7017"></A>
<P>本機能グループでは、<B>backup dump</B> コマンドを使用して、
AFS データをテープ・またはバックアップ・データ・ファイルにバックアップする方法を説明しています。説明は、バックアップ・システムの概念について理解しており、
<A HREF="auagd011.htm#HDRWQ334">AFS バックアップ・システムの構成</A> の指示にしたがってバックアップ・システムが構成済みであることを前提としています。特に、以下が完了しているものとします。
<UL>
<LI>テープまたはバックアップ・データ・ファイルのどちらにデータをダンプするか決定しており、テープ・コーディネーター・マシンおよびテープ・コーディネーター・プロセスが適切に構成されている。
<A HREF="auagd011.htm#HDRWQ361">テープ・コーディネーター・マシンおよびテープ装置の構成</A> および <A HREF="auagd011.htm#HDRWQ382">データのバックアップ・データ・ファイルへのダンプ</A> を参照してください。
</LI><LI>ダンプするボリュームのまとめて組み込むボリューム・セットが定義されている。
<A HREF="auagd011.htm#HDRWQ365">ボリューム・セットおよびボリューム項目の定義および表示</A> を参照してください。
</LI><LI>ボリューム・セットをダンプするダンプ階層内のダンプ・レベルが定義されている。増分ダンプ・レベルの場合は、あらかじめ親レベルでダンプを作成しておく必要があります。
<A HREF="auagd011.htm#HDRWQ367">ダンプ階層の定義および表示</A> を参照してください。
</LI><LI>入出力装置構成ファイルが作成されている。このファイルは、各テープ・スタッカー、ジュークボックス装置、またはバックアップ・データ・ファイルごとに必要です。また、これを使用して、バックアップ・システムの自動化機能を定義することもできます。<A HREF="auagd011.htm#HDRWQ375">バックアップ処理の自動化およびその効率化</A> を参照してください。
</LI></UL>
<P>ダンプ操作実行の最も基本的な方法は、適当なテープ・コーディネーターが使用可能となり次第に単独ボリューム・セットの初期ダンプを作成するものです。その際、<B>backup dump</B> コマンドに必要な引き数のみを使用します。説明は、<A HREF="#HDRWQ417">ダンプの作成</A> を参照してください。コマンドにはいくつかオプションの引き数があり、これを使用してバックアップ手順の効率および柔軟性を向上することができます。
<UL>
<LI>既に他のダンプを含むテープ・セットの最後にダンプを追加するには、
<B>-append</B> 引き数を組み込みます。組み込まない場合は、バックアップ・システムにより初期ダンプが作成されます。ダンプを追加することにより、テープの全容量が使用できるなど、利点があります。詳細は、
<A HREF="#HDRWQ415">ダンプを既存のダンプ・セットに追加するには</A> を参照してください。
</LI><LI>1 つ以上のダンプ操作をスケジュール化し、後に実行する場合は、
<B>-at</B> 引き数を組み込みます。詳細については、
<A HREF="#HDRWQ416">ダンプのスケジューリング</A> を参照してください。
</LI><LI>多数のダンプ操作を単一の <B>backup dump</B> コマンドで開始するには、<B>-file</B> 引き数を組み込み、コマンドをリストしたファイルを指定します。詳細については、
<A HREF="#HDRWQ415">ダンプを既存のダンプ・セットに追加するには</A> および <A HREF="#HDRWQ416">ダンプのスケジューリング</A> を参照してください。
</LI><LI>実際にダンプは行わず、ダンプに組み込むボリュームのリストを作成するには、実際にコマンドで使用する引き数に <B>-n</B> フラグを組み合わせます。
</LI></UL>
<P><H3><A NAME="HDRWQ413" HREF="auagd002.htm#ToC_334">バックアップ操作の効率化</A></H3>
<A NAME="IDX7018"></A>
<P>いくつかの方法により、ダンプ操作をより効率的にし、エラーを減少させ、ユーザーに混乱を与えないようにすることができます。その中にはまた、データが必要となった際の復元プロセスを単純化するものもあります。
<UL>
<LI>読み取り / 書き込みまたは読み取り専用バージョンのボリュームは、ダンプした場合に他のユーザーまたはプロセスがボリュームにアクセスできなくなるため、ダンプは行わない方がよいでしょう。その代わり、ダンプ操作を開始する直前に、ダンプする各ボリュームのバックアップ・バージョンを作成し、そのバックアップ・バージョンをダンプします。通常 Backup バージョンの作成によりソース・ボリュームが使用できなくなるのは、数分間だけです
(この間、他プロセスからのアクセスはブロックされますが失敗することはありません)。バックアップ・ボリュームの作成を自動化するには、
1 つ以上のサーバー・マシンの <B>/usr/afs/local/BosConfig</B>
ファイルに <B>cron</B> プロセスを作成し、ダンプ操作の開始までに十分な間隔があるようにその開始時刻を設定します。<B>-localauth</B> 引き数を <B>vos backup</B> または <B>vos backupsys</B> コマンドに組み込むことにより、管理トークンなしで実行することができます。説明については、<A HREF="auagd009.htm#HDRWQ217">新規プロセスを作成および開始する方法</A> を参照してください。
</LI><LI><B>backup dump</B> コマンドに指定するボリューム・セット、ダンプ・レベル、およびテープ・コーディネーターのポート・オフセットがバックアップ・データベースに正しく定義されていなくてはなりません。バックアップ・システムは、ダンプ操作の開始前にデータベースをチェックし、いずれかの必要な要素が不足する場合はコマンドを即時に停止します。必要であれば、以下のコマンドを使用します。
<UL>
<LI>ボリューム・セットを表示するには、<B>backup listvolsets</B> コマンドを使用。
<A HREF="auagd011.htm#HDRWQ366">ボリューム・セットおよびボリューム項目の表示</A> を参照。
</LI><LI>ダンプ・レベルを表示するには、<B>backup listdumps</B> コマンドを使用。
<A HREF="auagd011.htm#HDRWQ371">ダンプ階層の表示</A> を参照。
</LI><LI>ポート・オフセットを表示するには、<B>backup listhosts</B> コマンドを使用。
<A HREF="auagd011.htm#HDRWQ364">構成済みの磁気テープ・コーディネーターのリストを表示するには</A> を参照。
</LI></UL>
</LI><LI><B>backup dump</B> コマンドを発行する場合、および実際にダンプ操作を実行する場合のどちらにおいても、特権管理者 ID に対応する有効なトークンがバックアップ・システム・プロセスで使用可能なことを確認します
(詳細または必要な特権に関しては、<A HREF="auagd011.htm#HDRWQ360">バックアップ操作への管理特権の許可</A> を参照してください)。これはスケジュール・ダンプにおける特別の考慮事項です。代替方法としては、
<B>backup</B> コマンド (またはこれを起動するスクリプト)、および <B>butc</B> コマンドをサーバー・マシンで実行して、
<B>-localauth</B> 引き数をコマンドに組み込むものがあります。この場合のプロセスでは、ローカル <B>/usr/afs/etc/KeyFile</B> ファイルの最新のキー・バージョン数のキーが使用され、期限切れのないトークンが構成されます。これ以外の場合は、期限が切れる前にトークンを更新する方法を使用するか、またはトークンに長期の存続時間を認可する必要があります。いずれの場合も、マシンには物理的にも、許可されないネットワーク・アクセスに対しても両方の点で保全を図り、トークンに対する不適切なアクセスが行われないようにする必要があります。この場合の保護は、操作中に操作員が居合わせる場合よりも強力なものである必要があります。
</LI><LI>記録テープの容量およびファイル・マーク・サイズの値は、テープ・コーディネーターの <B>/usr/afs/backup/tapeconfig</B> ファイルおよびテープ・ラベルにできるだけ正確に指定します。指定された値について、およびこれが正確でない場合の結果については、<A HREF="auagd011.htm#HDRWQ358">tapeconfig ファイルの構成</A> を参照してください。
</LI><LI>無人ダンプで複数のテープが必要な場合、テープ・スタッカーまたはジュークボックスを適切に構成し、装置の <B>CFG_</B><VAR>device_name</VAR> ファイルで呼び出されるテープ・マウント・スクリプトを記述して、テープが提供されるようにします。説明については、<A HREF="auagd011.htm#HDRWQ377">装置のテープ取り付けおよび取り外しルーチンの呼び出し</A> を参照してください。
</LI><LI>テープ装置またはバックアップ・データ・ファイルの <B>CFG_</B><VAR>device_name</VAR> ファイルを構成し、バックアップ・システムの自動化機能を活用することができます。<A HREF="auagd011.htm#HDRWQ375">バックアップ処理の自動化およびその効率化</A> を参照してください。
</LI><LI><B>backup</B> コマンドを正規 (非対話式) モードで発行する場合、操作が完了するまでコマンド・シェル・プロンプトには戻りません。追加の接続をオープンせずにすむようにするには、<B>backup dump</B> コマンドを対話モードで発行します。特にスケジュール・ダンプ操作の場合は、
<B>-at</B> 引き数を組み込みます。
</LI><LI>増分ダンプは、使用しているレベルのすぐ上のダンプ・レベルにダンプが作成されている場合に最もスムーズに進行します。バックアップ・システムは、直接の親レベルに作成されたダンプのバックアップ・データベース・レコードを検出できないと、階層で 1 レベル上に作成されたダンプを検索し、必要であればフル・ダンプ・レベルまで検索します。システムは、検出された最下位の有効な親ダンプより 1 レベル下に増分ダンプを作成するか、または必要があればフル・ダンプを作成する場合もあります。このアルゴリズムにより、前回のダンプ以降に変更されたすべてのデータが確実にダンプに取り込まれますが、いくつか不利な点もあります。まず、バックアップ・システムがデータベース中の有効な親ダンプを検索するため、余計に時間がかかります。2 番目に、以降のダンプ・パターンは予期したダンプ・レベルで実行されたものでないため、データの復元を行う操作員にとって複雑になる場合があります。
<P>
<P>直接の親レベルにダンプが確実に存在するようにする最も簡単な方法としては、常に事前定義されたスケジュールに従いダンプを実行します。親ダンプが存在するかをチェックするには、
<B>backup dumpinfo</B> コマンド (<A HREF="#HDRWQ419">ダンプ・レコードの表示</A> を参照) を発行し、その出力を検索します。または、親ダンプに存在すると思われるボリュームに対し <B>backup volinfo</B> コマンド (<A HREF="#HDRWQ420">ボリュームのダンプ履歴を表示するには</A> を参照) を発行します。
</LI><LI>指定されたボリューム・セットをダンプする場合、常に同じ階層のダンプ・レベル (同じフル・ダンプの下位レベル) を使用します。異なる階層のレベル間で交換を行うと、データの回復、またはダンプ・レコードの読み取りの際、混乱する場合があります。また、変更されたデータがダンプに取り込まれない、または複数のダンプに冗長にバックアップされてしまう可能性が増します。
</LI><LI>AFS テープ名ではなく、永続テープ名を使用します。永続名は、
AFS テープ名の限定された形式よりも詳細な記述が可能で、テープが AFS テープ名のみを持つ場合にバックアップ・システムがデフォルトで実行する名前検査ステップをバイパスすることができます。また、テープ・コーディネーターが常にチェックをスキップするよう構成することもできます。
AFS テープ名で受け入れ可能な形式の詳細は、
<A HREF="auagd011.htm#HDRWQ380">AFS テープ名検査の除去</A> を参照してください。
</LI><LI>テープにダンプを書き込む場合、復元操作はすべてのテープ装置に互換性があれば (同じタイプのテープの読み取り可、圧縮率が同じなど) 最も単純になります。非互換の装置を使用する場合は、少なくとも個々の階層の同じダンプ・レベルで実行するダンプに対してはすべて互換性のある装置を使用します
(フル・ダンプ・レベルで実行するすべてのダンプに対して互換性のある装置、レベル 1 の増分ダンプ・レベルで実行するすべてのダンプに対して互換性のある装置、など)。<B>-portoffset</B> 引き数を <B>backup diskrestore</B>
および <B>backup volsetrestore</B> コマンドで使用することにより、複数のポート・オフセット番号を受け入れることができますが、この場合、すべてのフル・ダンプの復元には最初にリストされたポート・オフセットを、すべてのレベル 1 ダンプの復元には 2 番目のポート・オフセットを使用するなどのようになります。階層内の同じレベルでのダンプの作成において、互換性のあるテープ装置を使用しなければ、
<B>backup volrestore</B> コマンドを使用して 1 度に 1 つのボリュームを復元することになります。
</LI><LI><I>一時</I> ボリューム・セットの使用に意味がある場合もあります。一時ボリューム・セットは、そのボリューム・セットが作成された対話式セッションのコンテキストの中でのみ存在するもので、バックアップ・データベース内にそのボリューム・セット用のレコードは作成されません。これに相当する状況としては、(所有者がセルから抜ける際などに)
ボリュームを永続的に削除するための準備として、そのボリュームをテープにダンプする場合などがあります。この場合、1 度しか使用しないボリューム・セット・レコードでバックアップ・データベースに影響を及ぼすことなく、対象のボリュームのみを持つボリューム項目を定義することができます。
</LI><LI>ネットワーク、マシン、またはサーバー・プロセスに問題があり、バックアップ・システムがボリュームまたはボリューム・ロケーション・データベース (VLDB) にアクセスできない場合は、ダンプ操作は行わないでください。バックアップ・システムは、自動的に数回繰り返してアクセス不能なボリュームにアクセスしようとしますが、ダンプ操作には余計な時間がかかり、場合によっては完全に停止して継続方法を指示するようプロンプトが出ることがあります。さらに、バックアップ・システムの最後のアクセスが失敗して、ボリュームがダンプから省略された場合には、これをバックアップするステップ (停止したダンプ操作に続くステップ) が必要となります。バックアップ・システムによるアクセス試行の繰り返しについての詳細は、
<A HREF="#HDRWQ414">構成の選択がダンプ・プロセスに与える影響</A> を参照してください。
</LI><LI>特に無人の場合は、ダンプ操作が完了したら、できるだけすぐにバックアップ・システムが作成したログを検討します。これには正常にバックアップされなかったボリューム名、およびその他の問題が示されています。バックアップ・サーバーは、データベース・サーバー・マシンのローカル・ディスクの <B>/usr/afs/logs/BackupLog</B> ファイルに書き込みをし、これは、<B>bos getlog</B> コマンドを使用してリモート側から読み取ることができます。説明は、<A HREF="auagd009.htm#HDRWQ228">サーバー・プロセス・ログ・ファイル表示する</A> を参照してください。テープ・コーディネーターは、そのテープ・コーディネーターが実行されているマシン上のローカル <B>/usr/afs/backup</B> ディレクトリー内の 2 つのファイルに書き込みます。
<B>TE_</B><VAR>device_name</VAR> ファイルはエラーを記録し、
<B>TL_</B><VAR>device_name</VAR> ファイルはトレースとエラー・メッセージの両方を記録します。
</LI><LI>ダンプ操作は停止しないでください (たとえば、<B>(backup) kill</B> コマンドを対話モードで発行する)。混乱が起こる可能性があり、また中断からの復元には余計な手間がかかります。ダンプ操作が割り込まれた場合には、停止シグナルが受信される前にバックアップされたボリュームは、テープまたはバックアップ・データ・ファイル上にバックアップされており回復操作で使用できます。バックアップ・データベース内のボリューム・ダンプ活動記録レコードには、それらのレコードがバックアップされた時刻およびダンプ・レベルが、正確に記録されています。レコードを表示するには、
<A HREF="#HDRWQ420">ボリュームのダンプ履歴を表示するには</A> で説明しているように、
<B>backup volinfo</B> コマンドを使用してください。
<P>ただし、ダンプのバックアップ・データベース・レコードには、ボリュームが省略されたことは示す記録はありません。レコードを表示するには、<A HREF="#HDRWQ419">ダンプ・レコードの表示</A> で説明しているように、
<B>backup dumpinfo</B> コマンドを使用します。ダンプ操作が停止する前にバックアップされなかったボリュームについては、以下の方法をいずれかを選択します。(実際に、ダンプ操作が制御不能で停止した場合には、同様の方法をとります。)
<UL>
<LI>何も行わずに、バックアップは次の定期のスケジュール・ダンプ操作を待って行います。その際、バックアップ・システムは自動的にこれを適切なレベルでダンプし、前回のボリュームのダンプ以降に変更されたデータをすべて確実に取り込みます。ただし、次のダンプ操作までにボリュームが復元されないとは限らず、不確実な点が残ります。復元が必要な場合、ボリュームは前回ダンプに組み込んだ状態にしか復元できません。この場合、それ以降のボリュームの変更はすべて失われます。
</LI><LI>ダンプ全体を破棄して、ダンプ操作を再度実行します。ダンプを破棄するには、
<B>backup labeltape</B> コマンドを使用してテープまたはバックアップ・データ・ファイルを再度ラベル付けします。これにより、バックアップ・データベースからすべての関連レコードが自動的に除去されます。説明については、<A HREF="auagd011.htm#HDRWQ372">テープ・ラベルの書き込みおよび読み取り</A> を参照してください。ボリュームのバックアップ・バージョンを作成してから長時間が経過している場合、一部のソース・ボリュームは変更された可能性があります。このような場合には、
<B>vos backup</B> または <B>vos backupsys</B> コマンドを再度発行してから、ダンプ操作を行います。
</LI><LI>失われたボリュームを含む新しいボリューム・セットを作成し、フル・ダンプ・レベルでダンプすることができます (バックアップ・システムは、これらのボリュームを新しいボリューム・セットの一部としてバックアップしたことがないため、増分ダンプ・レベルを指定した場合でも、指定されたレベルの階層の最上層のフル・ダンプ・レベルを使用します)。次に元のボリューム・セットをダンプする際、バックアップ・システムは、前回元のボリューム・セットの一部にボリュームにダンプしたときのレベルより 1 レベル下に失われたボリュームを自動的にダンプします。
</LI></UL>
</LI></UL>
<P><H3><A NAME="HDRWQ414" HREF="auagd002.htm#ToC_335">構成の選択がダンプ・プロセスに与える影響</A></H3>
<A NAME="IDX7019"></A>
<P>本機能グループではバックアップ・プロセスを概説し、デフォルトおよびユーザーが選択した構成
(装置固有の <B>CFG_</B><VAR>device_name</VAR> ファイルに記述する構成命令を含む) によりそれぞれのステージにどのような影響があるかを説明します。明確にするため、単一の <B>backup dump</B> コマンドによる初期ダンプ作成の進行状況をトラックします。追加、またはスケジュール・ダンプを行う際の若干の相違については、
<A HREF="#HDRWQ415">ダンプを既存のダンプ・セットに追加するには</A>
または <A HREF="#HDRWQ416">ダンプのスケジューリング</A> を参照してください。
<P>具体例として、次の記述は、ボリューム・セット <B>user</B> のダンプを、
<B>/weekly/mon/tues/wed</B> ダンプ・レベルで追跡します。
<B>user</B> ボリューム・セットは、すべてのユーザー・ボリュームのバックアップ・バージョンに対応するボリューム項目を 1 つ所有します。
<PRE>      <B>.*    .*    user.*\.backup</B>
</PRE>
<P>ダンプ・レベルは、以下のダンプ階層に含まれます。
<PRE>   /weekly
          /mon
              /tues
                   /wed
                       /thurs
                             /fri
</PRE>
<OL TYPE=1>
<LI><A NAME="LIBKOV-BUTC"></A><B>butc</B> コマンドを発行して、テープ・コーディネーターによるダンプ操作を開始します。
<B>backup dump</B> コマンドを発行する際、テープ・コーディネーターが実行されている必要はありませんが、
<A HREF="#LIBKOV-VOLMATCHES">3</A> のステップが完了してダンプに組み込むボリュームのリストを受け入れる際にはアクティブでなければなりません。調整での問題を避けるには、
<B>backup dump</B> コマンドを発行する前にテープ・コーディネーターを開始するのがよいでしょう。
<P>
<P>テープ・コーディネーターが開始すると、これはローカルの <B>/usr/afs/backup/tapeconfig</B> ファイルの項目を読み取り、<B>butc</B> コマンド行で指定したポート・オフセットを検索します。項目には、使用する装置名が指定されており、テープ・コーディネーターはこれにアクセスできるか検証をします。また、装置構成ファイル <B>/usr/afs/backup/CFG_</B><VAR>device_name</VAR>が存在する場合は、これも読み取ります。ファイルの記述がダンプ操作に与える影響については、<A HREF="#LIBKOV-READCFG">6</A> のステップを参照してください。
</LI><LI>ボリューム・セット、ダンプ・レベル、および <A HREF="#LIBKOV-BUTC">1</A> のステップで <B>butc</B> コマンドに指定したのと同じポート・オフセット番号を指定して、
<B>backup dump</B> コマンドを発行します。バックアップ・システムは、これらが正しいバックアップ・データベース・レコードを持っているかを検証し、なければエラー・メッセージを出して停止します。
<P>
<P>対話モードでコマンドを発行する場合、バックアップ・システムは操作にジョブ ID 番号を割り当てます。これは、それぞれ <B>(backup) jobs</B> または <B>(backup) kill</B> コマンドを使用して操作状況のチェックまたは停止に使用できます。説明については、<A HREF="#HDRWQ405">対話モードで保留または実行中のジョブを表示する</A> および <A HREF="#HDRWQ406">対話モードで操作を取り消すには</A> を参照してください。
</LI><LI><A NAME="LIBKOV-VOLMATCHES"></A>バックアップ・システムは、VL サーバーと協力して、ボリューム・セットのボリューム項目に定義された名前とロケーションの条件に合う、
VLDB 内のボリュームのリストを生成します。ボリュームが複数のボリューム項目に一致する場合は、バックアップ・システムは重複を無視して、ダンプにボリューム・データのコピーが 1 つだけ組み込まれるようにします。
<P>
<P>復元操作でテープ交換に必要な回数を減らすのであれば、バックアップ・システムはサーバー・マシンおよびパーティションごとにボリュームをソートし、ダンプ操作中に特定のパーティションのボリュームのデータをすべて書き込んでから、次のパーティションに移動します。
<P>
<P>前述のように、ダンプ中のユーザーのデータ・アクセスを妨げないようにするには、読み取り / 書き込みボリュームではなく、バックアップ・ボリュームをバックアップする方がよいでしょう。これには、ボリューム項目定義のボリューム名に <B>.backup</B> サフィックスを組み込みます。複数ボリュームに一致するボリューム項目の定義方法については、
<A HREF="auagd011.htm#HDRWQ365">ボリューム・セットおよびボリューム項目の定義および表示</A> を参照してください。
<P>
<P>この例では、
50 ボリュームが <B>user</B> ボリューム・セット基準に合致し、これには <B>user.pat.backup</B>、
<B>user.terry.backup</B>、および <B>user.smith.backup</B> が含まれるものとします。
</LI><LI><A NAME="LIBKOV-CLONEDATE"></A>次にバックアップ・システムは、
<B>backup dump</B> コマンド行で指定したダンプ階層のダンプ・レベルをスキャンします。これがフル・レベルであれば、現行の操作でバックアップ・システムは、
<A HREF="#LIBKOV-VOLMATCHES">3</A> のステップで取得したリストのすべてのボリュームのデータをバックアップします。
<P>
<P>ダンプ・レベルが増分の場合、バックアップ・システムは、バックアップ・データベース内の各ボリュームのダンプ階層を読み取り、前回このボリューム・セットの一部としてそのボリュームをバックアップした際に、パス名のどの親レベルが使用されたかを判別します。通常、これは現在のダンプ・レベルの直接の親レベルです。
<P>
<P>ボリュームの増分ダンプには、そのボリュームが親ダンプに組み込まれた後で変更されたデータのみが含まれます。適格なデータを判別するために、バックアップ・システムは、ボリュームの<I>複製日</I> の概念を使用します。読み取り / 書き込みボリュームの複製日は、バックアップ・システムが、ボリュームのコンテンツをダンプにコピーする前に、そのボリュームをロックした日です。バックアップ・ボリュームの複製日は、元の読み取り / 書き込みボリュームの複製作成操作
(<B>vos backup</B>、または <B>vos backupsys</B> コマンドによって開始された操作)
の完了時刻です。読み取り専用ボリュームの複製日は、前回のダンプ操作を完了した際の
(<B>vos release</B> コマンドによって開始された) 解放操作の時刻です。
<P>
<P>より正確に言うと、増分ダンプには、変更タイム・スタンプが、親ダンプに組み込まれているボリュームの複製日 (<I>親複製日</I>)と、現在のダンプに組み込まれるボリュームの複製日 (<I>現行複製日</I>)
の間になっているデータのみが含まれます。
<P>
<P>ボリュームの親ダンプは直接の親レベルに作成されたダンプであるという一般的な規則には、いくつか共通して例外があります。
<UL>
<LI>最後のダンプ時にボリュームがまったく存在しなかった。この場合、バックアップ・システムはそのフル・ダンプを自動的に行います。
</LI><LI>ボリュームが、最後のダンプ時のボリューム・セット名および位置基準に合致しなかった。この場合、ボリュームが他のボリューム・セットの一部として最近バックアップされた (フルまたは増分) 場合でも、バックアップ・システムはフル・ダンプを自動的に行います。このような冗長性は、特にボリュームを頻繁に移動する場合にボリューム項目の定義において、位置よりは名前の点から問題となります。
</LI><LI>ボリュームが、何らかの理由により直接の親レベルのダンプに組み込まれなかった
(プロセス、マシン、またはネットワーク・アクセスが原因で、バックアップ・システムがこれにアクセスできなかった)。この場合、バックアップ・システムは、複製日を、そのボリュームが組み込まれた前回のダンプ操作の時刻に設定します。ボリュームが、現行レベルのパス名のいずれのレベルで実行されたダンプにも組み込まれなかった場合、バックアップ・システムはそのフル・ダンプを行います。
</LI></UL>
<P>
<P>この例では、現在のダンプ・レベルは <B>/weekly/mon/tues/wed</B> です。<B>user.pat.backup</B> および <B>user.terry.backup</B> ボリュームが、昨日 (火曜) に実行されたダンプの <B>/weekly/mon/tues</B> レベルに組み込まれています。バックアップ・システムは、火曜日の 3:00 a.m.
(火曜日のダンプ操作の前にそのバックアップ・バージョンが作成された時刻)
を親複製日として使用します。ただし、火曜のダンプでは何かしらの理由により
<B>user.smith.backup</B> ボリュームが組み込まれませんでした。このボリュームが最後にダンプに組み込まれたのは月曜日で、
<B>/weekly/mon</B> レベルでした。バックアップ・システムは、月曜のダンプ操作の時点で最後にそのボリュームのバックアップ・バージョンが作成されたときを示す、親複製日の月曜の 2:47 a.m. を使用します。
</LI><LI>増分ダンプを実行する場合、バックアップ・システムは、ボリューム・サーバーと協力して、親複製日と現在の複製日の間で変更された (タイム・スタンプが変更された)
各ボリュームの中の、すべてのファイルのリストを作成します。ダンプには、このような各ファイルの完全な内容が組み込まれます。ファイルが変更されなかった場合、ダンプにはそのプレースホルダー・スタブのみが組み込まれます。ダンプにはまた、前回のダンプから変更するしないにかかわらず、ボリュームの完全なディレクトリー構造のコピーが組み込まれます。
<P>
<P>前回のダンプ以降、ボリューム内のデータが全く変更されていない場合は、バックアップ・システムはそのボリュームを完全に省略します。テープ・コーディネーター・ウィンドウおよびログ・ファイルに以下のメッセージが作成されます。
<P>
<PRE>   Volume <VAR>volume_name</VAR> (<VAR>volume_ID</VAR>) not dumped - has not been modified 
       since last dump.
</PRE>
</LI><LI><A NAME="LIBKOV-READCFG"></A>テープ・コーディネーターはデータをバックアップする準備をします。
<B>CFG_</B><VAR>device_name</VAR> ファイルが存在する場合、テープ・コーディネーターはこれを
<A HREF="#LIBKOV-BUTC">1</A> のステップで読み取ります。以下のリストでは、ファイル内の各指示によってこの時点のテープ・コーディネーターの動作がどう変わるのかを説明します。
<P>
<DL>
<P><DT><B>FILE
</B><DD>この命令を <B>YES</B> に設定すると、テープ・コーディネーターはバックアップ・データ・ファイルにデータを書き込みます。ダンプを正常に行うには、
<B>tapeconfig</B> ファイルの <VAR>device_name</VAR> フィールドでもファイル名を指定する必要があります。バックアップ・データ・ファイルの構成に関する詳細は、
<A HREF="auagd011.htm#HDRWQ382">データのバックアップ・データ・ファイルへのダンプ</A> を参照してください。
<P>
<P>これが <B>NO</B> に設定されている、またはファイルにない場合、テープ・コーディネーターはテープ装置に書き込みます。
<P><DT><B>MOUNT および UNMOUNT
</B><DD>ファイルに <B>MOUNT</B> 命令が存在する場合、テープ・コーディネーターが新規のテープを必要とする度に、指定したスクリプトまたはプログラムを呼び出して、装置のテープ・ドライブにテープをマウントします。テープ・スタッカーまたはジュークボックスによりテープの交換を自動的に行うのであれば、<B>MOUNT</B> 命令は必須です。
<B>MOUNT</B> 命令がない場合、テープ・コーディネーターはテープを必要とする際、操作員にプロンプト指示を出します。
<P>
<P>この後で説明する <B>AUTOQUERY</B> 命令は、テープ・コーディネーターの、ダンプ操作で最初に必要となるテープのテープ要求手順を変更します。
<P>
<P><B>UNMOUNT</B> 命令がある場合は、テープ・コーディネーターはテープ装置をクローズする度に、指定したスクリプトまたはプログラムを呼び出します。すべてのテープ装置が別個にテープの取り外しルーチンを持つわけではなく、この場合、<B>UNMOUNT</B> 命令は必要ありません。両方の命令に関する詳細は、
<A HREF="auagd011.htm#HDRWQ377">装置のテープ取り付けおよび取り外しルーチンの呼び出し</A> を参照してください。
<P><DT><B>AUTOQUERY
</B><DD>この命令を <B>NO</B> に設定すると、テープ・コーディネーターは、ダンプ操作に必要な最初のテープがテープ装置にあることを前提とします。前述の <B>MOUNT</B> 命令で説明されている通常のテープ要求手順は使用しません。<B>butc</B> コマンドに <B>-noautoquery</B> フラグを組み込むことによっても同様の結果が得られます。
<P>
<P>この命令がない、または <B>YES</B> に設定されている場合、テープ・コーディネーターは最初のテープに対して、通常のテープ要求手続きを使用します。詳しくは、
<A HREF="auagd011.htm#HDRWQ378">最初のテープの検索またはプロンプトの除去</A> を参照してください。
<P><DT><B>BUFFERSIZE
</B><DD>この命令がファイルにある場合は、テープ・コーディネーターはバッファー・サイズをデフォルトの 16 KB ではなく、指定した値に設定します。詳しくは、<A HREF="auagd011.htm#HDRWQ381">テープ・ストリーミングをプロモートするためのメモリー・バッファーの設定</A> を参照してください。
</DL>
<P>
<P><B>CFG_</B><VAR>device_name</VAR> ファイルがない場合、テープ・コーディネーターはデータの書き込みをテープ装置に行い、テープが必要になると操作員にプロンプト指示を出します
(<B>-noautoquery</B> フラグを <B>butc</B> コマンドに組み込んだ場合に最初のテープのみが例外となります)。
</LI><LI><A NAME="LIBKOV-NAMECHECK"></A>ここで、テープ・コーディネーターは、
<B>CFG_</B><VAR>device_name</VAR> ファイル
(<A HREF="#LIBKOV-READCFG">6</A> のステップで説明しています) 内の命令の指示に従って、テープ・ドライブかバックアップ・データ・ファイルをオープンします。この命令は、取り付けスクリプトを呼び出すか、あるいは操作員にプロンプト指示を出すかも判別します。<A HREF="#LIBKOV-BUTC">1</A> のステップでは、テープ・コーディネーターは、
<B>tapeconfig</B> ファイルから装置容量およびファイル・マーク・サイズを読み取りました。今度は、同じ値をテープまたはバックアップ・データ・ファイルの磁気ラベルから読み取り、
<B>tapeconfig</B> の値と異なる場合は、これを上書きします。
<P>
<P>この例のように初期ダンプを作成している場合、ラベルに永続名がなければ、次に、テープ・コーディネーターは、
AFS テープ名が受け入れ可能な 3 つの形式のいずれかになっているかどうかを検査します。この形式でなければ、テープは拒否され、<B>backup labeltape</B> コマンドを使用して受け入れ可能な名前を書き込まなくてはなりません。この名前検査ステップは、
<B>NAME_CHECK NO</B> 命令を
<B>CFG_</B><VAR>device_name</VAR> ファイルに組み込むことによりバイパスできます。詳細および受け入れ可能な AFS テープ名の値については、<A HREF="auagd011.htm#HDRWQ380">AFS テープ名検査の除去</A> を参照してください。
</LI><LI><A NAME="LIBKOV-EXPDATE"></A>初期ダンプの場合、テープ・コーディネーターは、テープまたはバックアップ・ダンプ・ファイルの先頭から書き込みを開始し、既存のデータは上書きします。不適切な上書きを避けるために、バックアップ・システムは、まずバックアップ・データベースをチェックして、テープまたはバックアップ・ダンプ・ファイルのラベルの名前
(永続名または AFS テープ名) に関連したダンプ・レコードを検索します。そして、期限が切れていないダンプがあるバックアップ・データ・ファイルや、または期限が切れていないダンプを持つダンプ・セットに含まれるテープへの書き込みを拒否します。すべてのダンプが期限切れとなる前にファイルまたはテープを再利用するには、
<B>backup labeltape</B> コマンドを使用して、テープのラベルを変更します。これにより、そのファイルまたはダンプ・セット内のすべてのテープに含まれる、すべてのダンプのバックアップ・データベース・レコードが除去され、どのテープからのデータの復元もできなくなります。有効期限に関する詳細は、<A HREF="auagd011.htm#HDRWQ370">有効期限の定義</A> を参照してください。
<P>
<P>テープ・コーディネーターは、他にも不適切なテープ再利用を 2 種類チェックします。テープには、現在実行中のダンプに含まれるデータがあってはいけません。これは、以前のテープがドライブにある、または誤って再度挿入してしまったことを示すためです。テープ・コーディネーターは、以下のメッセージを作成して、別のテープを取得しようとします。
<P>
<PRE>   Can't overwrite tape containing the dump in progress
</PRE>
<P>
<P>テープには、現行の (増分) ダンプの親ダンプのデータがあってはいけません。これは、親ダンプを上書きすることにより、現行ダンプのデータが復元できなくなるためです。テープ・コーディネーターは、以下のメッセージを作成して、別のテープを取得しようとします。
<P>
<PRE>   Can't overwrite the parent dump <VAR>parent_name</VAR> (<VAR>parent_dump_ID</VAR>)
</PRE>
</LI><LI><A NAME="LIBKOV-WRITE"></A>これでテープ・コーディネーターはテープまたはバックアップ・データ・ファイルにデータを書き込みます。<A HREF="#LIBKOV-NAMECHECK">7</A> のステップで取得した容量およびファイル・マーク・サイズを使用して使用可能な容量をトラックし、テープの最後に到達してもダンプが完了しない場合は、自動的にテープ要求手続きを使用します。詳細およびテープ・コーディネーターが予期しない物理的なテープ終了に到達した場合については、
<A HREF="auagd011.htm#HDRWQ358">tapeconfig ファイルの構成</A> を参照してください。同様に、予期しない容量不足からもっとも適した方法で回復するようにバックアップ・データ・ファイルを構成する手順については、
<A HREF="auagd011.htm#HDRWQ382">データのバックアップ・データ・ファイルへのダンプ</A> で説明している手順の中の、
<A HREF="auagd011.htm#LITAPECONFIG-FILE">6</A> のステップを参照してください。
<P>ダンプ中、テープ・コーディネーターがボリュームにアクセスできない場合は
(サーバー・プロセス、マシン、またはネットワークの障害による)、ボリュームをスキップし、アクセス可能なすべてのボリュームについてダンプを継続します。テープ・コーディネーターは、テープ・コーディネーター・ウィンドウおよびログ・ファイルに、略されたボリュームに関するエラー・メッセージを生成します。バックアップ・ボリュームが前回のダンプ操作以降複製されていないことがわかった場合も
(つまり、そのボリュームの現在の複製日がその親複製日と同じ場合)、テープ・コーディネーターは同様のメッセージを生成します。
<P>
<PRE>   Volume <VAR>volume_name</VAR> (<VAR>volume_ID</VAR>) not dumped - has not been re-cloned 
       since last dump.
</PRE>
<P>
<P>すべてのボリュームについて最初のパスが完了すると、テープ・コーディネーターは、省略した各ボリュームについて、再度ダンプを試行します。最初のパスでボリュームがアクセス不能であった理由について、
VL サーバーが <A HREF="#LIBKOV-VOLMATCHES">3</A> のステップで作成したダンプ・ボリュームのリストからボリュームが移動されたためであるかチェックされます。そうであれば、新規サイトからボリュームをダンプします。
2 度目のボリューム・アクセスも失敗した場合、テープ・コーディネーターは以下のメッセージを作成し、今後の処理について指示するようプロンプトを出します。
<P>
<PRE>   Dump of volume <VAR>volume_name</VAR> (<VAR>volume_ID</VAR>) failed
   Please select action to be taken for this volume.
      r - retry, try dumping this volume again
      o - omit, this volume from this dump
      a - abort, the entire dump
</PRE>
<P>
<P>ダンプ・プロセスの自動化の比率を向上させるには、
<B>ASK NO</B> 命令を
<B>CFG_</B><VAR>device_name</VAR> ファイルに組み込みこのプロンプトを抑制し、テープ・コーディネーターが自動的にダンプのボリュームを省略するようにします。
<P>
<P>ダンプを順次トラックするのであれば、プロンプトを使用することにより修正アクションが可能です。ボリュームが再度複製されていなければ、
<B>vos backup</B> コマンドが発行できます。ボリュームがアクセス不能の場合は、調査を行い原因の解決を行うことができます。
<A NAME="IDX7020"></A>
<A NAME="IDX7021"></A>
<A NAME="IDX7022"></A>
<A NAME="IDX7023"></A>
<A NAME="IDX7024"></A>
</LI><LI>テープまたはバックアップ・データ・ファイルにまだ AFS テープ名がない場合は、バックアップ・システムが適切な名前を構成し、ラベルおよびバックアップ・データベースに記録します。また、ダンプ名および ID 番号をダンプに割り当て、バックアップ・データベースに作成したダンプ・レコード記録します。テープおよびダンプ名については、<A HREF="auagd011.htm#HDRWQ353">ダンプ名および磁気テープ名</A> を参照してください。ダンプ・レコードまたはボリュームのダンプ履歴の表示、またはテープ内容のスキャン方法については、
<A HREF="#HDRWQ418">バックアップ・ダンプ・レコードの表示</A> を参照してください。
</LI></OL>
<P><H3><A NAME="HDRWQ415" HREF="auagd002.htm#ToC_336">ダンプを既存のダンプ・セットに追加するには</A></H3>
<A NAME="IDX7025"></A>
<P>AFS バックアップ・システムでは、
<B>-append</B> フラグを <B>backup dump</B> コマンドに組み込むことにより、ダンプ・セットの最後のテープの終端にダンプを追加することができます。ダンプを付加することは、バックアップ・システムの自動化と効率を以下のように改善します。
<UL>
<LI>テープ容量の使用を最大化します。初期ダンプは、常に新しいテープから開始しなければなりませんが、必ずしもダンプ・セットの最後のテープの終端まで使用する必要はありません。
1 つまたは複数のダンプを付加することによって、テープの未使用部分を埋めることができます。
</LI><LI>ダンプ操作を完了させるために必要なテープ数およびテープ変更の数を削減できます。一連の初期ダンプを最初にまとめて実行するのではなく、まず 1 つの初期ダンプを行った後、すぐに幾つかの付加ダンプを行います。この方法では、1 つの系列のダンプをすべて同じテープに書き込むことができます
(テープに十分な容量があれば)。これとは対照的に、一連の初期ダンプを最初に実行すると、それぞれが新しいテープから開始しなければならず、ダンプを追加するにはテープを再び交換しなければなりません。
<P>
<P>該当する一連の <B>backup dump</B> コマンドを、対話式 <TT>backup></TT> プロンプトで発行するか、あるいは、その <B>backup dump</B> コマンドの
<B>-file</B> 引き数で指定するファイルに記録します。この方法でダンプを付加することにより、テープ・スタッカーまたはジュークボックスがない場合でも、複数の無人バックアップ操作が実行可能となります。もちろん、すべてのダンプが 1 つのテープにフィットする場合です。
</LI><LI>復元オペレーションの際の、テープ変更の回数が削減できます。たとえば、ボリューム・セットのすべての増分ダンプを 1 つのダンプ・セットのテープに追加するのであれば、ボリューム・セットからのボリューム復元に必要となるテープ交換回数は最低限で済みます。ただし、親のフル・ダンプを含むテープには、増分ダンプを追加しない方がよいでしょう。テープを損失した場合、ボリュームのすべてのデータを失うことになります。
<P>
<P>関連する付加ダンプをまとめるのは効果的ですが、バックアップ・システムにとっては、
1 つのテープ、または 1 つのダンプ・セット内の追加ダンプ間に関連がある必要はありません。
</LI></UL>
<P>追加ダンプを書き込む際、バックアップ・システムは
<A HREF="#HDRWQ414">構成の選択がダンプ・プロセスに与える影響</A> で説明したほとんどのステップを実行します。追加ダンプはお互いまたは初期ダンプとの間に関連がある必要はありませんので、
<A HREF="#LIBKOV-NAMECHECK">7</A> のステップは省略されます。この場合は、
AFS テープ名がボリューム・セット名やダンプ・レベル名を反映しているかどうかをチェックする必要もありません。
<A HREF="#LIBKOV-EXPDATE">8</A> のステップも省略します。これは、バックアップ・システムはテープ上の既存のデータを一切上書きしないため、テープまたはファイル上の既存のダンプの有効期限をチェックする必要がないからです。次に、<A HREF="#LIBKOV-WRITE">9</A> のステップで、テープ・コーディネーターはデータの書き込みを始める前に、テープまたはバックアップ・データ・ファイルを、最後のダンプの終わりまでスキャンします。
<P>バックアップ・システムは、追加ダンプに以下の条件を付加します。
<UL>
<LI>テープに書き込む場合、テープ・コーディネーターは、これがダンプ・セット中の最終テープであることを確認します
(ダンプ・セットにはバックアップ・データベース中、完全で有効なテープおよびダンプ・レコードが存在)。そうでない場合は、テープを拒否し、受け入れ可能なテープを要求します。テープに有効なデータが確実に含まれているのであれば、バックアップ・データベースのダンプ・レコードを再構成することができます (<B>-dbadd</B> 引き数を
<B>backup scantape</B> コマンドに使用。
<A HREF="#HDRWQ421">テープ内容をスキャンするには</A> を参照)。
</LI><LI>テープまたはバックアップ・データ・ファイルの最新ダンプが正常に完了している必要があります。
</LI><LI>そのテープまたはファイルを含むダンプ・セットは、バックアップ・データベースに記録されている初期ダンプから開始する必要があります。現在のテープにダンプがない場合、バックアップ・システムはそのダンプ操作を初期ダンプとして扱い、関連する要求 (たとえば、AFS テープ名のチェック) を強要します。
</LI></UL>
<P>ダンプを付加する際、ダンプ・セットのダンプ、およびバックアップ・データベースのテープ・レコードのすべてが、初期ダンプにインデックス化されることに留意してください。付加ダンプのレコードを削除する場合には、初期ダンプのレコードも削除しなければならず、これによりダンプ・セットのすべてのダンプのレコードが削除されます。これらのレコードがなければ、ダンプ・セットのデータはいずれも復元できません。
<P>同様に、ダンプ・セットのいずれかのテープを再利用する (新規に初期ダンプを書き込む) 前に、ダンプ・セットのすべてのダンプの期限が切れている必要があります。有効期限が、ダンプ・セットのいずれかのテープを再利用する日付以降の場合は、ダンプを追加しないでください。最終の有効期限以前にテープを再利用するには、バックアップ・データベースから初期ダンプのレコードを削除しなければなりません。
<B>backup labeltape</B> コマンドを使用してテープを再度ラベル付けするか
(<A HREF="auagd011.htm#HDRWQ373">磁気テープのラベル付け</A> を参照)、または <B>backup deletedump</B> コマンドを使用してレコードを直接削除します
(<A HREF="#HDRWQ438">ダンプ・レコードをバックアップ・データベースから削除するには</A>を参照)。
<P>理論的には、任意数のダンプを追加することができますが、一般には以下の理由により、ダンプ・セットのテープ数を制限します (たとえば、5)。
<UL>
<LI>ダンプ・セットのテープのいずれかに読み取り不能な点が発生した場合、テープ・コーディネーターは、
<B>backup scantape</B> 操作の一部としてテープをスキャンし、バックアップ・データベース・レコードを再構成することができなくなる場合があります。通常、テープ・コーディネーターは、損傷のある点までは正常にスキャンし、小さな損傷であればスキップすることができます。スキャン操作は、ダンプ・セットのいずれのテープからも開始することができるため、テープの 1 つに損傷があってもダンプ・セットの他のテープのスキャンが行えなくなることはありません。しかし、テープのスキャンは、ダンプ・セットの損傷テープの前のテープ、または後続のテープのいずれかで、両方では行えません。(テープを使用してバックアップ・データベース内の情報を再構成する方法の詳細は、
<A HREF="#HDRWQ421">テープ内容をスキャンするには</A> を参照してください。)
<P>
<P>また、読み取り不能な点により、ボリュームを完全に復元することができなくなります。これは、復元操作はフル・ダンプから開始し、続いて各増分ダンプについて順番に行うためです。特定のダンプが復元できなければ、後続の増分ダンプからいずれのデータも復元できません。
</LI><LI>後で 1 つ以上のダンプを保存するのであれば、対象とするデータを含むテープだけではなく、ダンプ・セットを構成するテープ・セット全体を保存する必要があります。これは、テープとアーカイブ記憶域の両方を空費します。アーカイブについての詳細は、<A HREF="auagd011.htm#HDRWQ369">テープの保存</A> を参照してください。
</LI></UL>
<P><H3><A NAME="HDRWQ416" HREF="auagd002.htm#ToC_337">ダンプのスケジューリング</A></H3>
<P>デフォルトでは、バックアップ・システムは、
<B>backup dump</B> コマンドが入力されるとすぐにダンプ操作を開始し、テープ・コーディネーターが使用中から解放され、書き込むファイルのリストが使用可能になると、すぐにデータの書き込みが開始します。ただし、ダンプ操作をスケジュール化し、後の特定の時刻に開始することができます。
<UL>
<LI>単一のダンプ操作をスケジュール化するには、<B>-at</B> 引き数を組み込みその開始時刻を指定します。
</LI><LI>複数のダンプ操作をスケジュール化するには、
<B>-file</B> 引き数で指定したファイルに操作をリストし、<B>-at</B> 引き数を使用して <B>backup</B> コマンド・インタープリターがファイルを読み取る時刻を指定します。
<B>-at</B> 引き数を省略すると、コマンド・インタープリターはファイルを即時に読み取るため、スケジューリングとはなりませんが、これにより複数のダンプ操作を単一コマンドで開始することはできます。
<B>-file</B> 引き数を、
<B>-volumeset</B>、<B>-dump</B>、<B>-portoffset</B>、<B>-append</B>、または <B>-n</B> オプションと組み合わせないでください。
<P>
<P>ファイル形式の指示については、
<B>-file</B> 引き数の説明
(<A HREF="#HDRWQ417">ダンプの作成</A> の <A HREF="#LIBKDUMP-SYNTAX">7</A> のステップ) を参照してください。
</LI></UL>
<P>バックアップ・システムでは、初期ダンプおよび追加ダンプが、スケジュールであるか <B>backup dump</B> コマンド発行直後に実行するかにかかわらず、同じ方法で実行されます。唯一の相違点としては、正常に実行するための要件が、コマンドの発行時、およびバックアップ・システムが実際に実行を開始する際の両方に適用される点があります。バックアップ・データベースのボリューム・セット、ダンプ・レベル、およびポート・オフセットに対するすべての必須項目、およびすべてのダンプおよびテープ・レコードがどちらの場合にも存在しなくてはなりません。より重要な点としては、必要な管理トークンがどちらの時点でも使用可能でなければならないということがあります。<A HREF="#HDRWQ413">バックアップ操作の効率化</A> を参照してください。
<P><H3><A NAME="HDRWQ417" HREF="auagd002.htm#ToC_338">ダンプの作成</A></H3>
<OL TYPE=1>
<LI><B>/usr/afs/etc/UserList</B> ファイルにリストされているユーザーとして認証されていることを検証します。必要な場合には、<B>bos listusers</B> コマンドを発行します。このコマンドについては、<A HREF="auagd021.htm#HDRWQ816">UserList ファイルのユーザーの表示</A>で詳しく説明しています。
<P>
<PRE>   % <B>bos listusers</B> &lt;<VAR>machine name</VAR>>
</PRE>
</LI><LI>磁気テープ装置に操作を行う磁気テープ・コーディネーターが実行されていない場合には、該当する磁気テープ・コーディネーター・マシンとの接続をオープンにし、<B>butc</B> コマンドを発行してください。詳細については、
<A HREF="#HDRWQ408">テープ・コーディネーター・プロセスを開始するには</A>を参照してください。
<P>
<PRE>   % <B>butc</B> [&lt;<VAR>port offset</VAR>>] [<B>-noautoquery</B>]
</PRE>
</LI><LI>テープ装置を使用する場合は、テープを挿入します。
</LI><LI><B>backup</B> コマンドを発行して、対話モードに入ります。
<P>
<PRE>   % <B>backup</B>
</PRE>
</LI><LI>どのボリューム・セットを使用するか、およびどのダンプ・レベルを使用するかを決定します。必要であれば、
<B>backup listvolsets</B> および <B>backup listdumps</B> コマンドを発行して、既存のボリューム・セットおよびダンプ・レベルを表示します。詳細な説明および出力については、<A HREF="auagd011.htm#HDRWQ366">ボリューム・セットおよびボリューム項目の表示</A>
および <A HREF="auagd011.htm#HDRWQ371">ダンプ階層の表示</A> を参照してください。
<P>
<PRE>   backup> <B>listvolsets</B>  [&lt;<VAR>volume set name</VAR>>]
   backup> <B>listdumps</B>
</PRE>
<P>
<P>一時ボリューム・セットを使用したい場合は、そのボリューム・セットを現行の対話式セッションの中で作成する必要があります。これは、(所有者がセルから抜ける際などに)
ボリュームを永続的に削除するための準備として、そのボリュームをテープにダンプする場合に便利です。この場合、1 度しか使用しないボリューム・セット・レコードでバックアップ・データベースに影響を及ぼすことなく、対象のボリュームのみを持つボリューム項目を定義することができます。詳細な説明が <A HREF="auagd011.htm#HDRWQ365">ボリューム・セットおよびボリューム項目の定義および表示</A> に示されています。
<P>
<PRE>   backup>  <B>addvolset</B> &lt;<VAR>volume set name</VAR>> <B>-temporary</B>
   backup> <B>addvolentry  -name</B> &lt;<VAR>volume set name</VAR>>  \
                        <B>-server</B> &lt;<VAR>machine name</VAR>>  \
                        <B>-partition</B> &lt;<VAR>partition name</VAR>>  \
                        <B>-volumes</B> &lt;<VAR>volume name (regular expression)</VAR>>
</PRE>
</LI><LI>初期ダンプを作成する場合で、永続名を持たないテープまたはバックアップ・データ・ファイルに書き込む場合、
AFS テープ名は、
<A HREF="auagd011.htm#HDRWQ380">AFS テープ名検査の除去</A> で説明したバックアップ・システムの形式要件を満たしている必要があります。必要であれば、<B>backup readlabel</B> コマンドを使用してラベルを表示し、
<B>backup labeltape</B> コマンドを使用して名前を変更します
(<A HREF="auagd011.htm#HDRWQ372">テープ・ラベルの書き込みおよび読み取り</A> を参照)。テープを上書きし、これが期限の切れていないダンプを含むダンプ・セットの一部である場合、テープを再度ラベル付けしますが、これは推奨できません。テープの適切な再利用方法については、
<A HREF="auagd011.htm#HDRWQ368">テープ再利用スケジュールの作成</A> を参照してください。
<A NAME="IDX7026"></A>
<A NAME="IDX7027"></A>
</LI><LI><A NAME="LIBKDUMP-SYNTAX"></A><B>backup dump</B> コマンドを発行して、ボリューム・セットを作成します。
<UL>
<LI>1 つの初期ダンプを作成するには、ボリューム・セット名、ダンプ・レベル名、およびポート・オフセット (ゼロでない場合) のみを指定します。
</LI><LI>1 つの追加ダンプを作成するには、<B>-append</B> フラグを追加します。
</LI><LI>単一の初期または追加ダンプをスケジューリングするには、<B>-at</B> 引き数を追加します。
</LI><LI>複数のダンプ操作を開始するには、該当するコマンドをファイルに組み込み、これを <B>-file</B> 引き数で指定します。この引き数は、<B>-at</B> 以外のオプションと組み合わせないでください。
</LI></UL>
<P>
<PRE>   backup> <B>dump</B> &lt;<VAR>volume set name</VAR>> &lt;<VAR>dump level name</VAR>> [&lt;<VAR>TC port offset</VAR>>]   \
                [<B>-at</B> &lt;<VAR>Date/time to start dump</VAR>><SUP>+</SUP>]  \
                [<B>-append</B>]  [<B>-n</B>] [<B>-file</B> &lt;<VAR>load file</VAR>>]
</PRE>
<P>
<P>ここで、
<P>
<DL>
<P><DT><B>dump
</B><DD>完全な形式でタイプする必要があります。
<P><DT><B><VAR>volume set name</VAR>
</B><DD>ダンプを作成するボリューム・セット名を指定します。
<P><DT><B><VAR>dump level name</VAR>
</B><DD>ボリューム・セットをダンプするダンプ・レベルの完全なパス名を指定します。
<P><DT><B><VAR>TC port offset</VAR>
</B><DD>操作を処理するテープ・コーディネーター・プロセス・のポート・オフセット番号を指定します。デフォルト値の 0 (ゼロ) が適切でない場合には、この引き数を指定しなければなりません。
<P><DT><B>-at
</B><DD>後でコマンドを実行する、または <B>-file</B> 引き数で指定したファイルを読み取る日時を指定します。値を <VAR>mm</VAR>/<VAR>dd</VAR>/<VAR>yyyy</VAR> [<VAR>hh</VAR>:<VAR>MM</VAR>] 形式で入力し、月 (<VAR>mm</VAR>)、日 (<VAR>dd</VAR>)、および年 (<VAR>yyyy</VAR>) は必須です。年範囲の有効な値は、<B>1970</B> から <B>2037</B> までです。標準 UNIX 表示における最後の日付の表示は 2023 年 2 月であるため、これより高い価は無効です。バックアップ・システムは、それ以降の日付を自動的に最大値の 2038 に削減します。
<P>
<P>時刻 (<VAR>hh</VAR>:<VAR>MM</VAR>) はオプションですが、入力する場合は 24 時間形式です (たとえば、<B>14:36</B> は 2:36 p.m. のことです)。. これを省略すると、デフォルトの時刻は午前 0 時 (00:00) になります。
<P>
<P>例では、値 <B>04/23/1999
20:20</B> により、1999 年 4 月 23 日 8:20 p.m. にコマンドをスケジューリングします。
<P>
<TABLE><TR><TD ALIGN="LEFT" VALIGN="TOP"><B>注:</B></TD><TD ALIGN="LEFT" VALIGN="TOP">コマンド構文中、この引き数にはプラス記号が続きますが、これは複数値を受け入れるためで (値を二重引用符や他の区切り文字で囲む必要はありません)、複数の日付を受け入れるわけではありません。単一の日付 (オプションで時間) を定義します。
</TD></TR></TABLE>
<P><DT><B>-append
</B><DD>そのテープまたはバックアップ・データ・ファイルに見つけた以前の 1 つまたは複数のダンプ操作から、データの最後までスキャンすることによって、追加ダンプを作成します。
<P><DT><B>-n
</B><DD>データを実際にテープまたはバックアップ・データ・ファイルに書き込まずに、指定されたダンプに組み込まれるすべてのボリュームの名前を表示します。このフラグを実際のコマンドで使用する引き数に組み合わせますが、<B>-file</B> 引き数とは使用しないでください。
<P><DT><B>-file
</B><DD><B>backup</B> コマンドを含むファイルのローカル・ディスクまたは AFS パス名を指定します。バックアップ・システムは即時に、または <B>-at</B> 引き数を指定した場合はこれに指定した時刻にファイルを読み取ります。部分的なパス名は、現行作業ディレクトリーに対する相対として解釈されます。
<P>
<P>指定したファイルに、<B>backup dump</B> コマンドをそれぞれその行に配置します。構文はコマンド行と同じですが、行の開始に <B>backup</B> は使用しません。それぞれのコマンドには、
<VAR>volume set name</VAR> および <VAR>dump level name</VAR> 引き数を組み込む必要があります。さらに、デフォルトの値ゼロが適さない場合には、
<VAR>TC port offset</VAR> 引き数も組み込む必要があります。ファイル内のコマンドには、
<B>backup dump</B> コマンドのいずれのオプション引き数を組み込むことができます
(<B>-at</B> 引き数を含む。これにはバックアップ・システムがファイルを読み取る日時以降の日時を指定します)。
</DL>
</LI><LI><B>butc</B> コマンドを発行したときに <B>-noautoquery</B> フラグを付けなかったか、装置の
<B>CFG_</B><VAR>device_name</VAR> 構成ファイルに
<B>AUTOQUERY YES</B> 命令を記述している場合には、テープ・コーディネーターから装置のドライブにテープを装てんするようにプロンプトが出されます。すでにこれを行っていても、
&lt;<B>Return</B>> を押して、テープがラベル付けの準備ができていることを示さなければなりません。
<P>
<P>複数のテープが必要な場合は、
<B>MOUNT</B> 命令を <B>CFG_</B><VAR>device_name</VAR> ファイルに組み込み、対応するスタッカーまたはジュークボックスにテープを装てんするか、コンソールにとどまり次のテープに対するプロンプトに応えなければなりません。
</LI><LI>ダンプ操作が完了したら、バックアップ・システムのログ・ファイルにエラーがないかチェックします。
<B>bos getlog</B> コマンド
(<A HREF="auagd009.htm#HDRWQ228">サーバー・プロセス・ログ・ファイル表示する</A> を参照) を使用して <B>/usr/afs/logs/BackupLog</B> ファイルを読み取り、テープ・コーディネーター・マシンのテキスト・エディターを使用して
<B>TE_</B><VAR>device_name</VAR> および <B>TL_</B><VAR>device_name</VAR> ファイル (<B>/usr/afs/backup</B> ディレクトリー) を読み取ります。
<P>
<P>それぞれのテープの外部ラベルにテープ名およびダンプ ID 番号を記録してとよいでしょう。
</LI></OL>
<HR><H2><A NAME="HDRWQ418" HREF="auagd002.htm#ToC_339">バックアップ・ダンプ・レコードの表示</A></H2>
<P><B>backup</B> スイートには、バックアップしたデータの情報を表示する 3 つのコマンドが含まれます。
<UL>
<LI>実行の日付および組み込まれたボリュームの数など、
1 つ以上のダンプ操作に関する情報を表示するには、<B>backup dumpinfo</B> コマンドを使用します
(<A HREF="#HDRWQ419">ダンプ・レコードの表示</A>を参照)。単一のダンプの詳細な記録を表示する、または特定数のダンプについて最新のものから古いものへとより詳細な記録を表示することができます。ダンプの数を指定するか、またはデフォルトの 10 を指定します。
</LI><LI>ボリュームのダンプ履歴を表示するには、<B>backup volinfo</B> コマンドを使用します (<A HREF="#HDRWQ420">ボリュームのダンプ履歴を表示するには</A>を参照)。
</LI><LI>テープまたはバックアップ・データ・ファイルに含まれるボリュームについて抽出した情報を表示するには、
<B>backup scantape</B> コマンドを使用します。テープおよびダンプ・レベルから派生した新規のダンプおよびテープ・レコードをバックアップ・データベースに作成するには、
<B>-dbadd</B> フラグを追加します。説明については、
<A HREF="#HDRWQ421">テープ内容をスキャンするには</A>を参照してください。
</LI></UL>
<A NAME="IDX7028"></A>
<A NAME="IDX7029"></A>
<A NAME="IDX7030"></A>
<A NAME="IDX7031"></A>
<A NAME="IDX7032"></A>
<A NAME="IDX7033"></A>
<A NAME="IDX7034"></A>
<P><H3><A NAME="HDRWQ419" HREF="auagd002.htm#ToC_340">ダンプ・レコードの表示</A></H3>
<OL TYPE=1>
<LI><B>/usr/afs/etc/UserList</B> ファイルにリストされているユーザーとして認証されていることを検証します。必要な場合には、<B>bos listusers</B> コマンドを発行します。このコマンドについては、<A HREF="auagd021.htm#HDRWQ816">UserList ファイルのユーザーの表示</A>で詳しく説明しています。
<P>
<PRE>   % <B>bos listusers</B> &lt;<VAR>machine name</VAR>>
</PRE>
</LI><LI><B>backup dumpinfo</B> コマンドを発行して、バックアップ・データベース内にレコードされたダンプについての情報をリストする。
<P>
<PRE>   % <B>backup dumpinfo</B> [<B>-ndumps</B> &lt;<VAR>no. of dumps</VAR>>]  [<B>-id</B> &lt;<VAR>dump id</VAR>>]  [<B>-verbose</B>]
</PRE>
<P>
<P>ここで、
<P>
<DL>
<P><DT><B>dump
</B><DD>は、<B>dumpinfo</B> の受け入れ可能な省略形です。
<P><DT><B>-ndumps
</B><DD>特定数のダンプについてそれぞれ、最新のものから古いものへとバックアップ・データベース・レコードを表示します。データベースのダンプが要求した数より少なければ、出力には既存のすべてのダンプのレコードが含まれます。この引き数は、<B>-id</B> 引き数または <B>-verbose</B> フラグと組み合わせないでください。最新の 10 ダンプのレコードを表示するには、3 つのオプションをすべて省略します。
<P><DT><B>-id
</B><DD>バックアップ・データベース・レコードを表示する単一ダンプのダンプ ID 番号を指定します。
<B>-id</B> スイッチを組み込む必要があります。このオプションは、<B>-ndumps</B> または
<B>-verbose</B> 引き数と組み合わせないでください。最新の 10 ダンプのレコードを表示するには、3 つの引き数をすべて省略します。
<P><DT><B>-verbose
</B><DD><B>-id</B> 引き数 (この引き数も合わせて指定します) で指定したダンプに関するより詳細な情報を提供します。このフラグは、
<B>-ndumps</B> オプションと組み合わせないでください。
</DL>
</LI></OL>
<P><B>-ndumps</B> 引き数を指定すると、以下の情報がテーブル形式で、ダンプごとに 1 行に表示されて出力されます。
<DL>
<P><DT><B><TT>dumpid</TT>
</B><DD>ダンプ ID 番号。
<P><DT><B><TT>parentid</TT>
</B><DD>ダンプの親ダンプのダンプ ID 番号。値 <TT>0</TT> (ゼロ) は、フルダンプを意味します。
<P><DT><B><TT>lv</TT>
</B><DD>ダンプを作成するために使用されたダンプ・レベルのダンプ階層における深さ。値 <TT>0</TT> (ゼロ) は、フルダンプを意味します。この場合は、<TT>parentid</TT> フィールドの値も <TT>0</TT> となります。<TT>1</TT> 以上の値の場合、ダンプ階層内で適切なレベルで、増分ダンプが作成されています。
<P><DT><B><TT>created</TT>
</B><DD>バックアップ・システムが、ダンプを作成したダンプ・オペレーションを開始した日時。
<P><DT><B><TT>nt</TT>
</B><DD>ダンプにデータを含むテープの数。値 <TT>0</TT> (ゼロ) は、ダンプ・オペレーションが終了または失敗したことを示します。<B>backup deletedump</B> コマンドを使用して、古くなった項目を除去します。
<P><DT><B><TT>nvols</TT>
</B><DD>ダンプにデータを組み込まれたボリュームの数。ボリュームがテープをスパンする場合、ボリュームは 2 度カウントされます。値 <TT>0</TT> (ゼロ) は、そのダンプ・オペレーションが終了または失敗したことをダンプ・オペレーションに示します。この場合は、<TT>nt</TT> フィールドの値も <TT>0</TT> となります。
<P><DT><B><TT>dump name</TT>
</B><DD>以下の形式のダンプ名。
<P>
<PRE>      <VAR>volume_set_name</VAR>.<VAR>dump_level_name</VAR> (<VAR>initial_dump_ID</VAR>)
   
</PRE>
<P>
<P>
<P>ここで、<VAR>volume_set_name</VAR> は、ボリューム・セットの名前であり、
<VAR>dump_level_name</VAR> は、ボリューム・セットがダンプされたダンプ・レベル内の最後の要素の名前です。
<P>
<P><VAR>initial_dump_ID</VAR> が表示された場合、これは、このダンプが属しているダンプ・セットの初期ダンプのダンプ ID です。括弧内に値がない場合、ダンプは、ダンプ・セット内の初期ダンプで、追加ダンプはありません。
</DL>
<P><B>-id</B> 引き数だけが指定されている場合、出力の最初の行は、文字列 <TT>Dump</TT> で始まり、以下のフィールドにダンプ全体の情報がレポートされます。
<DL>
<P><DT><B><TT>id</TT>
</B><DD>ダンプ ID 番号。
<P><DT><B><TT>level</TT>
</B><DD>ダンプを作成するために使用されたダンプ・レベルのダンプ階層における深さ。値 <TT>0</TT> (ゼロ) は、フルダンプを意味します。
<TT>1</TT> またはそれ以上の値は、ダンプ階層の指定されたレベルで行われた増分ダンプを示します。
<P><DT><B><TT>volumes</TT>
</B><DD>ダンプにデータを組み込まれたボリュームの数。
<P><DT><B><TT>created</TT>
</B><DD>ダンプ操作が開始した日時。
</DL>
<P>フランク行に続いて、ダンプからのボリューム・データを収容する各テープについての項目が出力されます。文字列 <TT>Tape</TT> に続いて、各項目の最初の 2 行では、以下のフィールドにそのテープに関する情報がレポートされます。
<DL>
<P><DT><B><TT>name</TT>
</B><DD>テープに永続名がある場合はその名前、永続名がない場合は AFS テープ名、および括弧内にテープの ID 番号。
<P><DT><B><TT>nVolumes</TT>
</B><DD>このテープがダンプ・データを組み込むボリュームの数。
<P><DT><B><TT>created</TT>
</B><DD>テープ・コーディネーターがこのテープにデータの書き込みを開始した日時。
</DL>
<P>別のブランク行に続いて、テープに固有の情報が、テープの各ボリューム・ダンプごとに 1 行を組み込むテーブル形式で出力されます。情報は、以下の見出しを持つ列に表示されます。
<DL>
<P><DT><B><TT>Pos</TT>
</B><DD>このテープまたはファイルの各ボリュームの相対的な位置。テープでは、カウンターは、位置 2 から始まり (テープ・ラベルが位置 1 を占めます)、ボリュームごとに 1 ずつ増分されます。バックアップ・データ・ファイルのボリュームの場合、位置番号は、1 から始まり、通常、1 ずつ増分されません。各ボリュームは、ボリュームのデータが開始されるファイル内の 16 KB オフセットの順序です。したがって、位置番号の差は、ボリュームのデータが 16 KB ブロックをいくつ占有しているかを示します。たとえば、リストの 2 番目のボリュームが位置 5 で、
3 番目のボリュームが位置 9 の場合は、2 番目のボリュームのダンプが、ファイル内の 64KB (16KB ブロック 4 つ) のスペースを占有することを意味します。
<P><DT><B><TT>Clone time</TT>
</B><DD>バックアップ・ボリュームまたは読み取り専用ボリュームの場合は、読み取り / 書き込みソースから複製された時刻です。読み取り / 書き込みボリュームの場合は、出力の最初の行にレポートされるダンプ作成日と同じになります。
<P><DT><B><TT>Nbytes</TT>
</B><DD>ボリュームのダンプ内のデータのバイト数。
<P><DT><B><TT>Volume</TT>
</B><DD>適切な場合、<TT>.backup</TT> または <TT>.readonly</TT> 拡張子を使用します。
</DL>
<P><B>-id</B> 引き数と <B>-verbose</B> フラグの両方を指定すると、出力は、いくつかの機能グループに分割されます。
<UL>
<LI>最初の機能グループは、下線付きの文字列 <TT>Dump</TT> で、ダンプ全体に関する情報が表示されます。<TT>id</TT>、<TT>level</TT>、<TT>created</TT>、および<TT>nVolumes</TT>というラベルのフィールドは、<B>-id</B> 引き数だけを指定したときに出力の最初の行に表示される値と同じ値 (順序は違います) をレポートします。その他にバックアップ・オペレーターが関心を持つ可能性のあるフィールドには、以下のものがあります。
<P>
<DL>
<P><DT><B><TT>maxTapes</TT>
</B><DD>このダンプが属するダンプ・セットのデータを含むテープの数。
<P><DT><B><TT>Start Tape Seq</TT>
</B><DD>ダンプ・セットを含むテープのセットにおいて、このダンプが開始されるテープの順序。
</DL>
</LI><LI>このダンプからのデータを含む各テープごとに、下線付きの文字列 <TT>Tape</TT> の見出しで始まる機能グループがあります。
<TT>name</TT>、<TT>written</TT>、および<TT>nVolumes</TT>というラベルのフィールドは、<B>-id</B> 引き数だけを指定したときに出力の 2 行目と 3行目の行に表示される値と同じ値 (順序は違います) をレポートします。その他にバックアップ・オペレーターが関心を持つ可能性のあるフィールドには、以下のものがあります。
<P>
<DL>
<P><DT><B><TT>expires</TT>
</B><DD>このテープがリサイクルできる日付と時刻。テープに含まれるすべてのダンプに有効期限があるためです。
<P><DT><B><TT>nMBytes Data</TT> および <TT>nBytes Data</TT>
</B><DD>これらのフィールドは、合計され、
(ラベル、ファイル・マーク、およびその他のマーカーではなく)
ボリュームから実際にダンプしたデータの合計量を表します。
<P><DT><B><TT>KBytes Tape Used</TT>
</B><DD>ダンプ・データの保管に使用されたテープのキロバイト数 (または、バックアップ・データ・ファイルの場合はディスク・スペース)。この値は、一般に、
<TT>nMBytes Data</TT> および <TT>nBytes Data</TT> フィールド内の値の合計よりも大きくなります。なぜなら、この値には、ラベル、ファイル・マーク、およびその他のマーカーに必要なスペースも含まれるからであり、指定されたブロックのデータが 16 KB に満たない場合でも、バックアップ・システムがデータを 16 KB オフセットで書き込むからです。
</DL>
</LI><LI>指定したテープのボリュームごとに、下線付きの文字列 <TT>Volume</TT> の見出しで始まる機能グループがあります。<TT>name</TT>、<TT>position</TT>、<TT>clone</TT>、および <TT>nBytes</TT> というラベルのフィールドは、<B>-id</B> 引き数だけを指定したときに各テープのボリュームにリストされるテーブルに表示される値と同じ値 (順序は違います) をレポートします。その他にバックアップ・オペレーターが関心を持つ可能性のあるフィールドには、以下のものがあります。
<P>
<DL>
<P><DT><B><TT>id</TT>
</B><DD>ボリューム ID。
<P><DT><B><TT>tape</TT>
</B><DD>このボリューム・データが書き込まれた磁気テープの名前
</DL>
</LI></UL>
<P>以下の例のコマンドでは、
5 つの最新ダンプ操作のバックアップ・データベース・レコードを表示しています。
<PRE>   % <B>backup dump 5</B>
      dumpid   parentid lv created          nt nvols dump name
   924424000          0 0  04/18/1999 04:26  1    22 usr.sun (924424000)
   924685000  924424000 1  04/21/1999 04:56  1    62 usr.wed (924424000)
   924773000  924424000 1  04/22/1999 05:23  1    46 usr.thu (924424000)
   924860000  924424000 1  04/23/1999 05:33  1    58 usr.fri (924424000)
   925033000          0 0  04/25/1999 05:36  2    73 sys.week
</PRE>
<A NAME="IDX7035"></A>
<A NAME="IDX7036"></A>
<A NAME="IDX7037"></A>
<A NAME="IDX7038"></A>
<P><H3><A NAME="HDRWQ420" HREF="auagd002.htm#ToC_341">ボリュームのダンプ履歴を表示するには</A></H3>
<OL TYPE=1>
<LI><B>/usr/afs/etc/UserList</B> ファイルにリストされているユーザーとして認証されていることを検証します。必要な場合には、<B>bos listusers</B> コマンドを発行します。このコマンドについては、<A HREF="auagd021.htm#HDRWQ816">UserList ファイルのユーザーの表示</A>で詳しく説明しています。
<P>
<PRE>   % <B>bos listusers</B> &lt;<VAR>machine name</VAR>>
</PRE>
</LI><LI><B>backup volinfo</B> コマンドを発行して、ボリュームのダンプ履歴を表示します。
<P>
<PRE>   % <B>backup volinfo</B> &lt;<VAR>volume name</VAR>>
</PRE>
<P>
<P>ここで、
<P>
<DL>
<P><DT><B>voli
</B><DD>は、<B>volinfo</B> の受け入れ可能な省略形です。
<P><DT><B><VAR>volume name</VAR>
</B><DD>ダンプ履歴を表示するボリュームの名前です。ボリュームのバックアップまたは読み取り専用バージョンをダンプした場合は、
<B>.backup</B> または <B>.readonly</B> 拡張子を組み込みます。
</DL>
</LI></OL>
<P>出力には、指定したボリュームについて言及する、各バックアップ・データベースのダンプ・レコードに関する 1 行が、最新のものから順に組み込まれています。各レコードに関する出力は、6 列のテーブルに表示されます。
<DL>
<P><DT><B><TT>dumpID</TT>
</B><DD>ボリュームが組み込まれているダンプのダンプ ID。
<P><DT><B><TT>lvl</TT>
</B><DD>ボリュームをダンプするダンプ・レベルのダンプ階層における深さ。値の <TT>0</TT> は、これがフルダンプであることを示します。<TT>1</TT> またはそれ以上の値は、ダンプ階層の指定された深さで行われた増分ダンプを示します。
<P><DT><B><TT>parentid</TT>
</B><DD>ダンプの親ダンプのダンプ ID。値の <TT>0</TT> は、フルダンプを示します。これは親を持っていません。このケースでは、<TT> lvl</TT> もまた <TT>0</TT> でなければなりません。
<P><DT><B><TT>creation date</TT>
</B><DD>バックアップ・システムが、ダンプを作成したダンプ・オペレーションを開始した日時。
<P><DT><B><TT>clone date</TT>
</B><DD>バックアップ・ボリュームまたは読み取り専用ボリュームの場合は、読み取り / 書き込みソースから複製された時刻です。読み取り / 書き込みボリュームの場合は、
<TT>creation date</TT> フィールドの値と同じです。
<P><DT><B><TT>tape name</TT>
</B><DD>ダンプを含んでいるテープの名前。&lt;<I>volume_set_name</I>>.&lt;<I>dump_level_name</I>>.&lt;<I>tape_index</I>>の形式の、永久テープまたは AFS テープ名。ここで、<I>volume_set_name</I> は、ダンプ・セット内の初期ダンプと関連したボリューム・セットの名前です。
<I>dump_level_name</I> は、初期ダンプがバックアップされたダンプ・レベルにおける最終要素の名前です。
<I>tape_index</I> は、ダンプ・セット内のテープの数値的な位置です。いずれの名前のタイプの後にダンプ ID が括弧内に続くことがあります。ダンプ ID が表示された場合、これは、この付記されたダンプが属しているダンプ・セットの初期ダンプのダンプ ID です。
</DL>
<P>次の例は、バックアップ・ボリューム <B>user.smith.backup</B> のダンプ履歴の一部を示しています。
<PRE>   %<B> backup volinfo user.smith.backup</B>
   DumpID    lvl parentID  creation   date  clone date       tape name
   924600000 1   924427600 04/20/1999 05:20 04/20/1999 05:01 user_incr_2 (924514392)
   924514392 1   924427600 04/19/1999 05:33 04/19/1999 05:08 user_incr_2 
   924427600 0           0 04/18/1999 05:26 04/18/1999 04:58 user_full_6 
       .     .      .         .       .       .      .         .
       .     .      .         .       .       .      .         .
</PRE>
<A NAME="IDX7039"></A>
<A NAME="IDX7040"></A>
<A NAME="IDX7041"></A>
<A NAME="IDX7042"></A>
<A NAME="IDX7043"></A>
<P><H3><A NAME="HDRWQ421" HREF="auagd002.htm#ToC_342">テープ内容をスキャンするには</A></H3>
<TABLE><TR><TD ALIGN="LEFT" VALIGN="TOP"><B>注:</B></TD><TD ALIGN="LEFT" VALIGN="TOP">破壊または損傷したテープをスキャンできるかどうかは、損傷の程度および破壊されたデータの種類によります。通常、バックアップ・システムは、損傷のある点までは正常にスキャンすることができます。損傷が微小であれば、バックアップ・システムは通常これをスキップし、残りをスキャンしますが、損傷が大きいとスキャンの継続ができない場合があります。スキャン操作は、ダンプ・セットの最初のテープから開始する必要はありませんが、バックアップ・システムは指定された初期テープ以降のテープ処理は順番にしか行いません。このため、1 つのテープに損傷があってもダンプ・セットの他のテープのスキャンが行えなくなることはありませんが、スキャン可能なのは損傷テープの前のテープか、後続のテープのいずれかで、両方はスキャンできません。
<P>
<P><B>-dbadd</B> フラグを使用してバックアップ・データベースに情報をスキャンする場合で、最初のテープがダンプ・セットの最初のテープではない場合、以下の制限が適用されます。
<UL>
<LI>テープの最初のデータが、ダンプ・セットの前の (未スキャン) テープから開始するボリュームの継続であれば、バックアップ・システムはそのボリュームのレコードをバックアップ・データベースに追加しません。
</LI><LI>バックアップ・システムは、追加ダンプにボリュームのデータベース・レコードを追加する際に、追加ダンプの開始を示すマーカーを読み取らなくてはなりません。テープの最初のボリュームが追加ダンプに含まれる場合で、追加ダンプ・マーカーが直前にない場合、バックアップ・システムは、追加ダンプ、または追加ダンプに含まれる後続のボリュームのバックアップ・データベース・レコードは作成しません。
</LI></UL>
</TD></TR></TABLE>
<OL TYPE=1>
<LI><B>/usr/afs/etc/UserList</B> ファイルにリストされているユーザーとして認証されていることを検証します。必要な場合には、<B>bos listusers</B> コマンドを発行します。このコマンドについては、<A HREF="auagd021.htm#HDRWQ816">UserList ファイルのユーザーの表示</A>で詳しく説明しています。
<P>
<PRE>   % <B>bos listusers</B> &lt;<VAR>machine name</VAR>>
</PRE>
</LI><LI>磁気テープ装置に操作を行う磁気テープ・コーディネーターが実行されていない場合には、該当する磁気テープ・コーディネーター・マシンとの接続をオープンにし、<B>butc</B> コマンドを発行してください。詳細については、
<A HREF="#HDRWQ408">テープ・コーディネーター・プロセスを開始するには</A> を参照してください。
<P>
<PRE>   % <B>butc</B> [&lt;<VAR>port offset</VAR>>] [<B>-noautoquery</B>]
</PRE>
</LI><LI>テープをスキャンする場合は、テープをドライブに挿入します。
</LI><LI><B>(オプション)</B> <B>backup</B> コマンドを発行して、対話モードに入ります。
<P>
<PRE>   % <B>backup</B>
</PRE>
<A NAME="IDX7044"></A>
<A NAME="IDX7045"></A>
</LI><LI><B>backup scantape</B> コマンドを発行して、テープの内容を読み取ります。
<P>
<PRE>   backup> <B>scantape</B> [<B>-dbadd</B>] [<B>-portoffset</B> &lt;<VAR>TC port offset</VAR>>]
</PRE>
<P>
<P>ここで、
<P>
<DL>
<P><DT><B>sc
</B><DD>は、<B>scantape</B> の受け入れ可能な省略形です。
<P><DT><B>-dbadd
</B><DD>ダンプ内のテープおよびダンプ・レベルからダンプおよびテープ・レコードを構成し、これをバックアップ・データベースに書き込みます。
<P><DT><B><VAR>TC port offset</VAR>
</B><DD>操作を処理するテープ・コーディネーター・プロセス・のポート・オフセット番号を指定します。デフォルト値の 0 (ゼロ) が適切でない場合には、この引き数を指定しなければなりません。
</DL>
</LI><LI><B>butc</B> コマンドを発行したときに、<B>-noautoquery</B> フラグを付けなかったか、装置の <B>CFG_</B><VAR>device_name</VAR> 構成ファイルに
<B>AUTOQUERY YES</B> 命令を記述している場合には、テープ・コーディネーターから装置のドライブにテープを装てんするようにプロンプトが出されます。すでにこれを行っていても、
&lt;<B>Return</B>> を押して、テープが読み取りの準備ができていることを示さなければなりません。
</LI></OL>
<P>テープのスキャン操作を終了するには、
&lt;<B>Ctrl-c</B>> などの終了シグナルを使用するか、対話モードで <B>(backup)
kill</B> コマンドを発行します。
<B>-dbadd</B> 引き数を組み込んだ場合は、スキャンに割り込みをしない方がよいでしょう。バックアップ・システムがバックアップ・データベースに新規レコードの書き込みを行った場合は、これを除去してからスキャン操作を再度実行します。スキャン操作の繰り返し中に、バックアップ・システムが作成する必要のあるレコードが既に存在することを検出すると、操作が停止します。
<P>テープ上の各ダンプに対して、[テープ・コーディネーター] ウィンドウ内の出力は、ダンプ・ラベル、および、それに続く、各ボリュームに対する項目を表示します。[コマンド] ウィンドウ内には出力はありません。ダンプ・ラベルは、<A HREF="auagd011.htm#HDRWQ372">テープ・ラベルの書き込みおよび読み取り</A> で説明したように、
<B>backup readlabel</B> コマンドによって表示されたテープ・ラベルと同じフィールドを持っています。出力フィールドの詳細は、<I>AFS Administration Reference</I> を参照してください。
<P>以下の例は、ポート・オフセット 2 を持っている装置内のテープ上のダンプ・ラベルおよび最初のボリューム項目を示します。
<PRE>   % <B>backup scantape 2</B>
   -- Dump label --
   tape name = monthly_guest
   AFS tape name = guests.monthly.3
   creationTime =  Mon Feb  1 04:06:40 1999
   cell = abc.com
   size = 2150000 Kbytes
   dump path = /monthly
   dump id = 917860000
   useCount = 44
   -- End of dump label --
   -- volume --
   volume name: user.guest10.backup
   volume ID 1937573829
   dumpSetName: guests.monthly
   dumpID 917860000
   level 0
   parentID 0
   endTime 0
   clonedate Mon Feb  1 03:03:23 1999
</PRE>
<HR><H2><A NAME="HDRWQ422" HREF="auagd002.htm#ToC_343">データの復元と回復</A></H2>
<A NAME="IDX7046"></A>
<A NAME="IDX7047"></A>
<A NAME="IDX7048"></A>
<A NAME="IDX7049"></A>
<A NAME="IDX7050"></A>
<A NAME="IDX7051"></A>
<A NAME="IDX7052"></A>
<A NAME="IDX7053"></A>
<A NAME="IDX7054"></A>
<A NAME="IDX7055"></A>
<A NAME="IDX7056"></A>
<A NAME="IDX7057"></A>
<P>バックアップを作成する目的は、データが破壊または偶発的に除去された場合に、データを過去の状態と一貫性がある状態に戻して復元することにあります。
AFS バックアップ・システムでは、さまざまな数のボリュームを復元するコマンドを 3つ提供しています。
<UL>
<LI>1 つ以上のボリュームを単一のサイト (AFS ファイル・サーバー・マシン上のパーティション) に復元するには、
<B>backup volrestore</B> コマンドを使用します。
</LI><LI>ボリューム・セットとして定義された 1 つ以上のボリュームを、それぞれ指定したサイトに復元するには、<B>backup volsetrestore</B> コマンドを使用します。
</LI><LI>パーティション全体を復元するには (VLDB に常駐するものとしてリストされているすべてのボリューム)、
<B>backup diskrestore</B> コマンドを使用します。
</LI></UL>
<P>コマンドは組となって各種目的に応じるようにしています。コマンドの機能の組み合わせ、およびその付与する要件が各種存在するためです。特定の復元操作に適切なコマンドを決定するには、この概要に続く機能グループ <A HREF="#HDRWQ424">backup volrestore コマンドを使用する</A>、<A HREF="#HDRWQ426">backup diskrestore コマンドの使用</A>、および <A HREF="#HDRWQ428">backup volsetrestore コマンドの使用</A> を参照してください。
<P><H3><A NAME="HDRWQ423" HREF="auagd002.htm#ToC_344">復元操作をより効率的にする</A></H3>
<P>以下の記述は、すべてのタイプの復元操作に適用されます。
<UL>
<LI>バックアップ・システムは、ボリュームの最新のフル・ダンプの復元から開始します。以降の増分ダンプを復元する際は、フル・ダンプのデータが適切に更新され、ボリュームの変更履歴が必ず反復されます。
<B>backup diskrestore</B> および <B>backup volsetrestore</B> コマンドにより、常にすべての増分ダンプが復元され、ボリュームは最新の増分ダンプ時の状態に戻ります。
<B>backup volrestore</B> コマンドを使用すると、ボリュームを過去の指定時刻の状態に戻すことができます。この場合、この時刻以降に実行された増分ダンプからは復元しません。
</LI><LI>バックアップ・システムは、復元されたボリュームの作成日を、復元操作の日時に設定します。作成日は、
<B>vos examine</B> および <B>vos listvol</B> コマンド出力の <TT>Creation</TT> フィールドに表示されます。
</LI><LI>復元するボリュームを識別するには、基本 (読み取り / 書き込み) 名を指定するのがよいでしょう。この場合、バックアップ・システムは、バックアップ・データベースから、そのボリュームの読み取り / 書き込みまたはバックアップ・バージョンのデータを組み込んだ最新のダンプ・セットを検索し、そのボリュームのダンプの復元を最新のフル・ダンプから開始します。指定するボリューム名に <B>.backup</B> または
<B>.readonly</B> 拡張子を組み込むと、バックアップ・システムはそのバージョンのダンプのみを復元します。そのバージョンからダンプされたデータが見つからないと、その他のバージョンがダンプされていても復元は行われません。
</LI><LI>3 つの復元コマンドはいずれも <B>-n</B> オプションを受け入れます。これにより、復元するボリューム、および必要なダンプを含むテープまたはバックアップ・データ・ファイルのリストが作成されます。この場合、実際に AFS サーバー・パーティションにデータが復元されることはありません。これにより、復元操作を開始する前に
(スタッカーまたはジュークボックスを使用する場合は、ロードする前に)、テープを集めることができます。
</LI><LI>テープに AFS データをバックアップする場合、復元操作はすべてのテープ装置に互換性があれば (同じタイプのテープの読み取り可、圧縮率が同じなど) 最も単純になります。
(データを復元する段階になってからでは設定できないため、これは <A HREF="#HDRWQ413">バックアップ操作の効率化</A> でも説明されています。)
データのバックアップを非互換の装置を使用して行った場合でも、単一コマンドにより複数ボリュームを復元することが可能です。
3 つの復元コマンドに使用する <B>-portoffset</B> 引き数では、複数の値が受け入れられます。ただしバックアップ・システムは、それぞれのボリュームのフル・ダンプを復元する際、リスト中の最初のポート・オフセットを使用し、レベル 1 の増分ダンプの復元では次のポート・オフセットというように、以降はポート・オフセットを順次使用します。どのボリュームについてもフル・ダンプの作成時に互換性のあるテープ装置を使用しなかった場合は
(それぞれの増分レベルについても同様)、単一コマンドで複数ボリュームを復元することはできません。
<B>backup volrestore</B> コマンドを使用して 1 度に 1 ボリュームを復元するか、またはボリュームをグループ化したボリューム・セットの定義をダンプに使用したテープ装置に応じて行ってから <B>backup volsetrestore</B> コマンドを使用する必要があります。
</LI><LI>復元操作中、バックアップ・システムは、関係のある <B>CFG_</B><VAR>device_name</VAR> 構成ファイル中の命令を、ダンプ操作中と同様の方法 (<A HREF="#HDRWQ414">構成の選択がダンプ・プロセスに与える影響</A> を参照) で使用します。
<B>MOUNT</B>、<B>UNMOUNT</B>、
<B>AUTOQUERY</B>、<B>BUFFERSIZE</B>、および <B>FILE</B> 命令が、ダンプ操作の場合と同様の手順で使用されます。
<B>BUFFERSIZE</B> 命令の手順で異なるのは、この命令で上書きされるデフォルト・バッファー・サイズが、ダンプ操作では 16 KB であるのに対し、復元操作では 32 KB となる点です。バックアップ・システムは、復元操作では <B>NAME_CHECK</B> 命令を使用しません。バックアップ・システムが何らかの理由によりボリュームを復元できない場合、プロンプトを出すかどうか <B>ASK</B>命令により制御します。これを <B>NO</B> に設定すると、問題のあるボリュームはスキップされ、他のボリュームが最大限復元されます。
</LI><LI>ネットワーク、マシン、またはサーバー・プロセスに問題があり、バックアップ・システムがボリュームまたは VLDB にアクセスできない可能性がある場合は、復元操作は行わないでください。バックアップ・システムは、自動的に数回繰り返しボリュームを復元しようとしますが、復元操作には余計な時間がかかり、場合によっては完全に停止して継続方法を指示するようプロンプトが出ることがあります。
</LI><LI>復元操作は停止しないでください (たとえば、<B>(backup) kill</B> コマンドを対話モードで発行する)。復元操作が何らかの理由で割り込まれた場合、
(制御不能な原因を含む)、同じ復元コマンドをすぐさま再発行するのが現実的な解決法です。障害、または他の問題により操作が中断した場合は、システムが正常な状態に戻るまでは継続しないでください。
<P>
<P>操作が停止した際に完全に復元されているボリュームは、オンラインにあり使用可能ですが、この状態にあると思われるボリュームはごく少数です。複数ボリュームを 1 度に復元する場合、バックアップ・システムはすべてのボリュームのフル・ダンプを復元してから、そのいずれかのレベル 1 の増分ダンプの復元を開始します。そして、すべてのボリュームの復元を指定した増分レベルで完了し、次の増分レベルのデータ復元を開始します。ボリュームが、同じ操作の一部として復元される他のボリュームの増分レベルより上位のレベルでダンプされているのでなければ、復元が完了する見込みがなくなります。
<P>
<P>ボリュームの現行の内容を上書きする場合に復元操作を割り込むのはさらに危険です。復元操作がどの程度進行したかにもよりますが、ボリュームが矛盾した状態になり、バックアップ・システムがこれを完全に除去してしまう場合があります。復元中のデータはテープ、またはバックアップ・データ・ファイル上で使用することができますが、ボリュームを再度作成するには、余計なステップを踏まなくてはなりません。
</LI></UL>
<P><H3><A NAME="HDRWQ424" HREF="auagd002.htm#ToC_345">backup volrestore コマンドを使用する</A></H3>
<A NAME="IDX7058"></A>
<A NAME="IDX7059"></A>
<A NAME="IDX7060"></A>
<A NAME="IDX7061"></A>
<A NAME="IDX7062"></A>
<A NAME="IDX7063"></A>
<P>いくつかのボリュームを単一のサイト (ファイル・サーバー・マシンのパーティション)に復元するには、
<B>backup volrestore</B> コマンドを使用するのが最適です。デフォルトでは、ボリュームは最新のダンプ操作時の状態に復元されます
(<I>フル復元</I> と呼ばれます)。また、このコマンドを使用することにより、<I>日付指定の復元</I> が実行できます。これは、指定した日時以前に実行されたダンプ (フルおよび増分) のみを復元し、ボリュームを妥当な最終増分ダンプ時の状態に戻します。<B>backup diskrestore</B> および <B>backup volsetrestore</B> コマンドは、フル復元のみ実行します。
<P>データの復元を、現行バージョンに上書きするのではなく、それぞれのボリュームの新規コピーに行うには、
<B>-extension</B> 引き数を組み込みます。ファイル・スペースに新規ボリュームをマウントした後、両者の内容を比較して、どちらを永続的に保持するか決定することができます。
<P>以下のリストには、<B>backup
volrestore</B> コマンドの引き数を組み合わせた、異なる方法によるボリュームの復元方法を示しています。
<UL>
<LI>前述のように、日付指定の復元を実行するには、
<B>-date</B> 引き数を使用して日付およびオプションで時刻を指定します。バックアップ・システムは、ダンプに組み込まれたボリュームの複製日が指定した日時より前である最新のフル・ダンプ、および後続の増分ダンプをそれぞれ復元します (複製日の定義については、
<A HREF="#HDRWQ414">構成の選択がダンプ・プロセスに与える影響</A> の <A HREF="#LIBKOV-CLONEDATE">4</A> のステップを参照)。この引き数を<B>-extension</B> 引き数と組み合わせることにより、新規ボリュームに日付指定の復元が配置できます。
</LI><LI>ボリュームを新規サイトに移動し、復元されたデータで内容を上書きをするには、
<B>-server</B> および <B>-partition</B> 引き数を単独で、または組み合わせて使用し、現行サイトではなく新規のサイトを指定します。バックアップ・システムはそのサイトに新しいボリュームを作成し、既存のボリュームを削除し、そのボリュームの VLDB 項目内のサイト情報を更新します。元のサイトにそのボリュームのバックアップ・バージョンがある場合、そのバックアップ・バージョンは、自動的に削除されません。
<B>vos remove</B> コマンドを使用してこれを削除し、
<B>vos backup</B> コマンドを使用して、新しいサイトにバックアップ・バージョンを作成します。
</LI><LI>既存ボリュームを上書きするのではなく、新規ボリュームを作成して復元データを配置するには、
<B>-extension</B> 引き数を使用します。バックアップ・システムは、
<B>-server</B> および <B>-partition</B> 引き数で指定したサーバーおよびパーティション上の新規ボリュームを作成します。この名前は、
<B>-volume</B> 引き数で指定した名前に拡張子を追加したもので、これに対する新規 VLDB 項目が作成されます。コマンドにより、既存のボリュームが影響を受けることはありません。ただし、指定された拡張子を持つボリュームが既に存在する場合は、コマンドはこれを上書きします。新規ボリュームの内容をアクセス可能にするには、<B>fs mkmount</B> コマンドを使用してこれをマウントします。その上で、その内容を既存のボリュームの内容と比較し、どちらを永続的に保存するか判別することができます。
</LI><LI>データがバックアップされており、
AFS サーバー・パーティションに存在しないボリュームを復元するには、
<B>-volume</B> 引き数で新規ボリューム名を指定し、<B>-server</B> および <B>-partition</B> 引き数を使用して任意のサイトにこれを復元します。バックアップ・システムは、新規ボリュームおよび新規の VLDB 項目を作成します。
</LI></UL>
<A NAME="IDX7064"></A>
<A NAME="IDX7065"></A>
<P><H3><A NAME="HDRWQ425" HREF="auagd002.htm#ToC_346">backup volrestore コマンドによるボリュームの復元</A></H3>
<OL TYPE=1>
<LI><B>/usr/afs/etc/UserList</B> ファイルにリストされているユーザーとして認証されていることを検証します。必要な場合には、<B>bos listusers</B> コマンドを発行します。このコマンドについては、<A HREF="auagd021.htm#HDRWQ816">UserList ファイルのユーザーの表示</A>で詳しく説明しています。
<P>
<PRE>   % <B>bos listusers</B> &lt;<VAR>machine name</VAR>>
</PRE>
</LI><LI>磁気テープ装置に操作を行う磁気テープ・コーディネーターが実行されていない場合には、該当する磁気テープ・コーディネーター・マシンとの接続をオープンにし、<B>butc</B> コマンドを発行してください。詳細については、
<A HREF="#HDRWQ408">テープ・コーディネーター・プロセスを開始するには</A> を参照してください。
<P>
<PRE>   % <B>butc</B> [&lt;<VAR>port offset</VAR>>] [<B>-noautoquery</B>]
</PRE>
<P>
<P>複数のテープ装置を使用している場合は、それぞれのテープ・コーディネーターごとにコマンドを繰り返します。
</LI><LI>テープ装置を使用する場合は、テープを挿入します。
</LI><LI><B>backup</B> コマンドを発行して、対話モードに入ります。
<P>
<PRE>   % <B>backup</B>
</PRE>
</LI><LI>使用したい引き数を付けて <B>backup volrestore</B> コマンドを発行します。
<P>
<PRE>   backup> <B>volrestore</B> &lt;<VAR>destination machine</VAR>> &lt;<VAR>destination partition</VAR>>  \
                      <B>-volume</B> &lt;<VAR>volume(s) to restore</VAR>><SUP>+</SUP>  \
                      [<B>-extension</B> &lt;<VAR>new volume name extension</VAR>>]  \
                      [<B>-date</B> &lt;<VAR>date from which to restore</VAR>>]  \
                      [<B>-portoffset</B> &lt;<VAR>TC port offsets</VAR>><SUP>+</SUP>] [<B>-n</B>]
</PRE>
<P>
<P>ここで、
<P>
<DL>
<P><DT><B>volr
</B><DD>は、<B>volrestore</B> の受け入れ可能な省略形です。
<P><DT><B><VAR>destination machine</VAR>
</B><DD>それぞれのボリュームを復元するファイル・サーバー・マシンの名前です。ボリュームの現行サイトである必要はありません。
<P><DT><B><VAR>destination partition</VAR>
</B><DD>それぞれのボリュームを復元するパーティションの名前です。ボリュームの現行サイトである必要はありません。
<P><DT><B>-volume
</B><DD>復元するボリュームの名前です。基本 (読み取り / 書き込み) 名を指定するのが最適です。理由は <A HREF="#HDRWQ423">復元操作をより効率的にする</A> を参照してください。
<P><DT><B>-extension
</B><DD>復元したデータを配置する新規ボリュームを作成します。名前は、<B>-volume</B> 拡張子で指定した各ボリューム名に指定文字列を追加して作成します。バックアップ・システムは、既存のボリュームが存在する場合は、その内容を保存します。<B>.readonly</B> または <B>.backup</B> 拡張子は予約済みのため使用しないでください。基本ボリューム名と拡張子の組み合わせは、22 文字以内とします。ピリオドを使って拡張子を名前から分離したい場合、ピリオドを文字列の最初の文字に指定します (たとえば、
<B>.rst</B> のようにします)。
<P><DT><B>-date
</B><DD>日付およびオプションで時刻を指定します。復元されるボリュームには、この日付以前に実行されたダンプのデータのみが組み込まれます。値を <I>mm</I>/<I>dd</I>/<I>yyyy</I> [<I>hh</I>:<I>MM</I>] 形式で入力します。必須部分の <I>mm/dd/yyyy</I> は、月 (<I>mm</I>)、日 (<I>dd</I>)、および年 (<I>yyyy</I>) を示し、オプションの <I>hh:MM</I> は、
24 時間形式の時刻を示します (たとえば、<B>14:36</B> は 2:36 p.m. を表します)。これを省略すると、デフォルトは、午前 0 時 59 秒 (00:00:59 時) となります。
<P>
<P>年範囲の有効な値は、<B>1970</B> から <B>2037</B> までです。標準 UNIX 表示における最後の日付の表示は 2023 年 2 月であるため、これより高い価は無効です。コマンド・インタープリターは、それ以降の日付を自動的に最大値に削減します。
<P>
<TABLE><TR><TD ALIGN="LEFT" VALIGN="TOP"><B>注:</B></TD><TD ALIGN="LEFT" VALIGN="TOP">コマンド構文中、この引き数にはプラス記号が続きますが、これは複数値を受け入れるためで (値を二重引用符や他の区切り文字で囲む必要はありません)、複数の日付を受け入れるわけではありません。単一の日付 (オプションで時間) を定義します。
</TD></TR></TABLE>
<P><DT><B>-portoffset
</B><DD>1 つ以上のポート・オフセット番号を指定します。それぞれが操作で使用するテープ・コーディネーターに対応します。複数の値がある場合、それぞれのボリュームのフル・ダンプを復元する際、リスト中の最初のオフセット、レベル 1 の増分ダンプの復元では次のオフセットというように、以降はこれを順次使用します。リストの最終値を使用する際は、ダンプ階層中これに対応する深さのダンプ、およびこれ以下のレベルのすべてのダンプが復元されます。
<P>
<P>すべてのダンプについてデフォルト値の 0 (ゼロ) が適切でない場合に限り、この引き数を使用します。
0 がリスト中の値の 1 つであれば、これを適当な順序で明示的に指定します。
<P><DT><B>-n
</B><DD>復元操作で必要とするダンプを含むテープのリストを表示します。実際に操作は行いません。
</DL>
</LI><LI><B>butc</B> コマンドを発行したときに、<B>-noautoquery</B> フラグを付けなかったか、装置の <B>CFG_</B><VAR>device_name</VAR> 構成ファイルに
<B>AUTOQUERY YES</B> 命令を記述している場合には、テープ・コーディネーターから装置のドライブにテープを装てんするようにプロンプトが出されます。すでにこれを行っていても、
&lt;<B>Return</B>> を押して、テープがラベル付けの準備ができていることを示さなければなりません。
<P>
<P>複数のテープが必要な場合は、
<B>MOUNT</B> 命令を <B>CFG_</B><VAR>device_name</VAR> ファイルに組み込み、対応するスタッカーまたはジュークボックスにテープを装てんするか、コンソールにとどまり次のテープに対するプロンプトに応えなければなりません。
</LI><LI>復元操作が完了したら、バックアップ・システムのログ・ファイルにエラーがないかチェックします。
<B>bos getlog</B> コマンド
(<A HREF="auagd009.htm#HDRWQ228">サーバー・プロセス・ログ・ファイル表示する</A> を参照) を使用して <B>/usr/afs/logs/BackupLog</B> ファイルを読み取り、テープ・コーディネーター・マシンのテキスト・エディターを使用して
<B>TE_</B><VAR>device_name</VAR> および <B>TL_</B><VAR>device_name</VAR> ファイル (<B>/usr/afs/backup</B> ディレクトリー) を読み取ります。
</LI></OL>
<P><H3><A NAME="HDRWQ426" HREF="auagd002.htm#ToC_347">backup diskrestore コマンドの使用</A></H3>
<A NAME="IDX7066"></A>
<A NAME="IDX7067"></A>
<P>ハードウェア障害によりすべてのデータが破壊または破棄された場合など、すべてのボリュームを AFS サーバー・パーティションに復元する必要がある場合には、
<B>backup diskrestore</B> コマンドが最適です。このコマンドにより、指定パーティションが現行サイトとして VLDB にリストされているすべての読み取り / 書き込みボリュームのフル復元が実行されます。この際、最新のダンプの種類に応じて、それぞれのボリュームの読み取り / 書き込みまたはバックアップ・バージョンのいずれかのダンプが使用されます。
(<B>backup diskrestore</B> 操作の完了後、
<B>vos backup</B> および <B>vos release</B> コマンドを使用すれば、パーティション上にある任意のバックアップまたは読み取り専用ボリュームを復元できます。)
<P>デフォルトでは、バックアップ・システムはボリュームが以前に配置されていたサイトに復元を行います。パーティション内容を新規サイトに移動するには、
<B>-newserver</B> および <B>-newpartition</B> 引き数を単独または組み合わせて使用します。
<P>デフォルトでは、バックアップ・システムは復元されたデータにより既存のボリュームの内容を上書きします。代わりに新規ボリュームを作成して復元データを配置するには、
<B>-extension</B> 引き数を使用します。バックアップ・システムは、
<B>-newserver</B> および <B>-newpartition</B> 引き数 (これを使用した場合)、または <B>-server</B> および <B>-partition</B> 引き数 (それ以外の場合) で指定したサイトに新規ボリュームを作成します。バックアップ・システムは、
VLDB にリストされている読み取り / 書き込み基本名に拡張子を追加してボリューム名を作成し、新しい VLDB 項目を作成します。コマンドにより、既存のボリュームが影響を受けることはありません。ただし、指定された拡張子を持つボリュームが既に存在する場合は、コマンドはこれを上書きします。
<P>パーティションが損傷を受けていると思われる場合、<B>backup diskrestore</B> コマンドの前に <B>vos syncserv</B> コマンドを実行しないでください。前述のとおり、バックアップ・システムは VLDB のサイト定義に従いボリュームを復元します。
<B>vos syncserv</B> コマンドは、パーティションの損傷がひどくボリューム・サーバーがボリュームの存在を確認できない場合に、ボリュームの VLDB 項目を除去する場合があります。
<A NAME="IDX7068"></A>
<A NAME="IDX7069"></A>
<P><H3><A NAME="HDRWQ427" HREF="auagd002.htm#ToC_348">backup diskrestore コマンドによるパーティションの復元</A></H3>
<OL TYPE=1>
<LI><B>/usr/afs/etc/UserList</B> ファイルにリストされているユーザーとして認証されていることを検証します。必要な場合には、<B>bos listusers</B> コマンドを発行します。このコマンドについては、<A HREF="auagd021.htm#HDRWQ816">UserList ファイルのユーザーの表示</A>で詳しく説明しています。
<P>
<PRE>   % <B>bos listusers</B> &lt;<VAR>machine name</VAR>>
</PRE>
</LI><LI>磁気テープ装置に操作を行う磁気テープ・コーディネーターが実行されていない場合には、該当する磁気テープ・コーディネーター・マシンとの接続をオープンにし、<B>butc</B> コマンドを発行してください。詳細については、
<A HREF="#HDRWQ408">テープ・コーディネーター・プロセスを開始するには</A> を参照してください。
<P>
<PRE>   % <B>butc</B> [&lt;<VAR>port offset</VAR>>] [<B>-noautoquery</B>]
</PRE>
<P>
<P>複数のテープ装置を使用している場合は、それぞれのテープ・コーディネーターごとにコマンドを繰り返します。
</LI><LI>テープ装置を使用する場合は、テープを挿入します。
</LI><LI><B>backup</B> コマンドを発行して、対話モードに入ります。
<P>
<PRE>   % <B>backup</B>
</PRE>
</LI><LI>使用したい引き数を付けて <B>backup diskrestore</B> コマンドを発行します。
<P>
<PRE>   backup> <B>diskrestore</B> &lt;<VAR>machine to restore</VAR>> &lt;<VAR>partition to restore</VAR>>  \
                       [<B>-portoffset</B> &lt;<VAR>TC port offset</VAR>><SUP>+</SUP>]  \
                       [<B>-newserver</B> &lt;<VAR>destination machine</VAR>>]  \
                       [<B>-newpartition</B> &lt;<VAR>destination partition</VAR>>]  \
                       [<B>-extension</B> &lt;<VAR>new volume name extension</VAR>>] [<B>-n</B>]
</PRE>
<P>
<P>ここで、
<P>
<DL>
<P><DT><B>di
</B><DD>は、<B>diskrestore</B> の受け入れ可能な省略形です。
<P><DT><B><VAR>machine to restore</VAR>
</B><DD>VLDB に復元の必要があるボリュームのサイトとしてリストされているファイル・サーバー・マシンの名前です。
<P><DT><B><VAR>partition to restore</VAR>
</B><DD>VLDB に復元の必要があるボリュームのサイトとしてリストされているパーティションの名前です。
<P><DT><B>-portoffset
</B><DD>1 つ以上のポート・オフセット番号を指定します。それぞれが操作で使用するテープ・コーディネーターに対応します。複数の値がある場合、それぞれのボリュームのフル・ダンプを復元する際、リスト中の最初のオフセット、レベル 1 の増分ダンプの復元では次のオフセットというように、以降はこれを順次使用します。リストの最終値を使用する際は、ダンプ階層中これに対応する深さのダンプ、およびこれ以下のレベルのすべてのダンプが復元されます。
<P>
<P>すべてのダンプについてデフォルト値の 0 (ゼロ) が適切でない場合に限り、この引き数を使用します。
0 がリスト中の値の 1 つであれば、これを適当な順序で明示的に指定します。
<P><DT><B>-newserver
</B><DD>ボリュームの復元先である代替ファイル・サーバー・マシンの名前です。この引き数を省略すると、ボリュームは <B>-server</B> 引き数で指定したファイル・サーバー・マシンに復元されます。
<P><DT><B>-newpartition
</B><DD>データの復元先となる代替パーティションの名前です。この引き数を省略すると、ボリュームは
<B>-partition</B> 引き数で指定したパーティションに復元されます。
<P><DT><B>-extension
</B><DD>復元されるそれぞれのボリュームに対して新規ボリュームを作成し、復元データを配置します。VLDB にリストされているボリュームの読み取り / 書き込み基本名に、指定文字列を追加します。
<B>.readonly</B>
または <B>.backup</B> 以外のいずれの文字列も受け入れ可能です。基本名と拡張子の組み合わせは、22 文字以内とします。ピリオドを使って拡張子を名前から分離するには、ピリオドを文字列の最初の文字に指定します (たとえば、
<B>.rst</B> のようにします)。
<P><DT><B>-n
</B><DD>要求された復元の実行に必要なテープをリストします。実際に操作は行いません。
</DL>
</LI><LI><B>butc</B> コマンドを発行したときに、<B>-noautoquery</B> フラグを付けなかったか、装置の <B>CFG_</B><VAR>device_name</VAR> 構成ファイルに
<B>AUTOQUERY YES</B> 命令を記述している場合には、テープ・コーディネーターから装置のドライブにテープを装てんするようにプロンプトが出されます。すでにこれを行っていても、
&lt;<B>Return</B>> を押して、テープがラベル付けの準備ができていることを示さなければなりません。
<P>
<P>複数のテープが必要な場合は、
<B>MOUNT</B> 命令を <B>CFG_</B><VAR>device_name</VAR> ファイルに組み込み、対応するスタッカーまたはジュークボックスにテープを装てんするか、コンソールにとどまり次のテープに対するプロンプトに応えなければなりません。
</LI><LI>復元操作が完了したら、バックアップ・システムのログ・ファイルにエラーがないかチェックします。
<B>bos getlog</B> コマンド
(<A HREF="auagd009.htm#HDRWQ228">サーバー・プロセス・ログ・ファイル表示する</A> を参照) を使用して <B>/usr/afs/logs/BackupLog</B> ファイルを読み取り、テープ・コーディネーター・マシンのテキスト・エディターを使用して
<B>TE_</B><VAR>device_name</VAR> および <B>TL_</B><VAR>device_name</VAR> ファイル (<B>/usr/afs/backup</B> ディレクトリー) を読み取ります。
</LI></OL>
<P><H3><A NAME="HDRWQ428" HREF="auagd002.htm#ToC_349">backup volsetrestore コマンドの使用</A></H3>
<P>複数の読み取り / 書き込みボリュームをフル復元し、それぞれを指定サイトに配置する場合は、
<B>backup volsetrestore</B> コマンドが最適です。復元するボリュームの指定は、
<B>-name</B> 引き数でボリューム・セットを指定するか、またはそれぞれのボリューム名および復元サイトを <B>-file</B> 引き数で指定したファイルにリストします。以下の機能グループで説明をします。
<P><B>backup volsetrestore</B> コマンドを使用すると、単一コマンドで多数のボリュームが復元できるため、復元操作は完了までに長時間かかる場合があります。時間を短縮する方法としては、コマンドの複数インスタンスを同時に実行する方法があります。
<B>-name</B> 引き数を使用してそれぞれのコマンドにばらばらのボリューム・セットを指定するか、
<B>-file</B> 引き数を使用して、異なるボリュームをリストするファイルを指定します。要求されるテープを読み取るには、複数のテープ・コーディネーターが必要です。復元するボリュームをテープにダンプする方法によっては、ばらばらのボリューム・セットを指定することにより、必要なテープ交換回数も減らすことができます。
<P><H4><A NAME="HDRWQ429">-name 引き数を使用したボリューム・セットの復元</A></H4>
<P><B>-name</B> 引き数を使用することにより、ボリューム・セットに定義されたボリューム・グループを復元することができます。バックアップ・システムは、ボリューム・セットのボリューム項目に定義されたサーバー、パーティション、およびボリューム名条件に一致し、ダンプが可能なボリュームのリストを VLDB に作成します。ボリュームは、VLDB にリストされていれば、サーバー・パーティションに存在しなくてもかまいません
(これはたとえば、ハードウェア問題によりディスク全体の内容が破壊された場合に起こります)。
<P>デフォルトでは、バックアップ・システムは、ボリューム・セット条件と一致するボリュームを、それぞれ読み取り / 書き込みボリュームとして、VLDB にリストされたサイトに復元します。一致する名前のボリュームがそのサイトに存在すれば、現行の内容は上書きされます。代わりに <B>-extension</B> 引き数を組み込むことにより、新規ボリュームを作成して復元データを配置することができます。バックアップ・システムは、新規ボリュームを既存のボリュームのサイトに作成します。この名前は、既存ボリュームの読み取り / 書き込み基本名に拡張子を追加したもので、これに対する新規 VLDB 項目が作成されます。コマンドにより、既存のボリュームが影響を受けることはありません。ただし、指定された拡張子を持つボリュームが既に存在する場合は、コマンドはこれを上書きします。新規ボリュームの内容をアクセス可能にするには、<B>fs mkmount</B> コマンドを使用してこれをマウントします。その上で、その内容を既存のボリュームの内容と比較し、どちらを永続的に保存するか判別することができます。
<P>そのボリューム・セットが、以前にボリュームのバックアップに使用された
(<B>backup dump</B> コマンドの <B>-volumeset</B> オプションとして使用された)
必要はありません。ボリューム・セットは、このコマンドを使った復元が必要かつ通常はよりよい選択肢であるボリュームに適すように、特に定義することができます。実際、
<B>backup addvolset</B> コマンドに <B>-temporary</B> フラグを組み込んで作成された
<I>temporary</I> ボリューム・セットは、このコンテキストでは特に役立ちます (<A HREF="auagd011.htm#HDRWQ365">ボリューム・セットおよびボリューム項目の定義および表示</A> の説明を参照)。一時ボリューム・セットはバックアップ・データベースに追加されず、現在の対話式バックアップ・セッションの間のみ存続します。これは、そのボリューム・セットが、このコマンドによって開始された単一の復元操作のみを完了する必要がある場合に適しています。
<P>特に定義されたボリューム・セットの方がおそらく適しているという理由は、ダンプ操作で使用するために以前に定義されたボリューム・セットは、ボリュームのバックアップ・バージョンに適していますが、復元操作に対しては、基本 (読み取り / 書き込み) 名に適したボリューム項目を定義するのがよいからです。この場合、バックアップ・システムは、バックアップ・データベースから、ボリュームの読み取り / 書き込みまたはバックアップ・バージョンのいずれかのダンプを含む最新のダンプ・セットを検索します。これに対して、ボリューム項目が明示的にボリュームのバックアップまたは読み取り専用バージョンと一致する場合は、バックアップ・システムは、そのボリューム・バージョンのダンプのみを使用し、
<B>.backup</B> または <B>.readonly</B> 拡張子を取り外して、それらを読み取り / 書き込みボリュームに復元します。
<P>ボリューム・セット条件に合致する VLDB 項目がある場合で、これに対してバックアップ・データベースにはダンプが記録されていなければ、バックアップ・システムはこれを復元することができません。それぞれにつき、標準エラー・ストリームにエラー・メッセージが表示されます。
<P><H4><A NAME="HDRWQ430">-file 引き数によりファイルにリストされたボリュームを復元する</A></H4>
<P><B>-file</B> 引き数を使用して、復元するそれぞれの読み取り / 書き込みボリュームの名前およびサイトを指定します。それぞれのボリュームの項目が、ファイル中の指定行 (改行なし) に以下の形式に準拠して表示されます。
<PRE>      <VAR>machine</VAR>    <VAR>partition</VAR>   <VAR>volume</VAR>    [<VAR>comments...</VAR>]
</PRE>
<P>ここで、
<DL>
<P><DT><B><VAR>machine</VAR>
</B><DD>ボリュームの復元先であるファイル・サーバー・マシンの名前です。現行サイト以外のマシンを指定することにより、復元する際にボリュームが移動できます。
<P><DT><B><VAR>partition</VAR>
</B><DD>ボリュームの復元先であるパーティションの名前です。現行サイト以外のパーティションを指定することにより、復元する際にボリュームが移動できます。
<P><DT><B><VAR>volume</VAR>
</B><DD>復元するボリュームの名前です。基本 (読み取り / 書き込み) 名を指定して、バックアップ・システムが、バックアップ・データベースから、ボリュームの読み取り / 書き込みまたはバックアップ・バージョンのいずれかのダンプを含む最新のダンプ・セットを検索するようにします。これにより、最新のフル・ダンプから開始して、ボリュームのそのバージョンのダンプが復元されます。一方で、
<TT>.backup</TT> または <TT>.readonly</TT> 拡張子を組み込んだ場合は、バックアップ・システムはそのボリューム・バージョンのダンプのみを復元しますが、読み取り / 書き込みボリュームに拡張子なしで復元されます。基本名は、
VLDB ではなくバックアップ・データベースのダンプ・レコードで使用する名前に一致させます (これらが異なる場合)。バックアップ・システムは <B>-file</B> 引き数を使用する際、VLDB を照会しません。
<P><DT><B><VAR>comments...</VAR>
</B><DD>その他のテキストです。バックアップ・システムは、ボリューム名以降の行内のテキストは無視するため、このフィールドに注釈を記入することができます。
</DL>
<P><VAR>machine</VAR>、<VAR>partition</VAR>、または <VAR>volume</VAR> フィールドにワイルドカード (たとえば <B>.*</B>) は使用しないでください。ファイル内の複数行で同じボリュームを指定することができますが、バックアップ・システムはその最初のボリュームのみ処理します。
<P>デフォルトでは、バックアップ・システムはそれぞれのボリュームの既存のバージョンを復元データに置き換え、ボリュームを
<VAR>machine</VAR> および <VAR>partition</VAR> フィールドで指定したサイトに配置します。代わりに
<B>-extension</B> 引き数を組み込むことにより、新規ボリュームを作成して復元内容を配置することができます。バックアップ・システムは、
<VAR>machine</VAR> および <VAR>partition</VAR> フィールドで指定したサイトに、新規ボリュームを作成します。新規ボリュームの名前は、
<VAR>volume</VAR> フィールドの名前の読み取り / 書き込みバージョンに指定拡張子を追加したもので、これに対する新規 VLDB 項目が作成されます。コマンドにより、既存のボリュームが影響を受けることはありません。ただし、指定された拡張子を持つボリュームが既に存在する場合は、コマンドはこれを上書きします。新規ボリュームの内容をアクセス可能にするには、<B>fs mkmount</B> コマンドを使用してこれをマウントします。その上で、その内容を既存のボリュームの内容と比較し、どちらを永続的に保存するか判別することができます。
<P>バックアップ・データベースにダンプが記録されていないボリュームの項目がファイルに含まれる場合は、バックアップ・システムはこれを復元することができません。それぞれにつき、標準エラー・ストリームにエラー・メッセージが表示されます。
<P><B>-file</B> 引き数の入力に使用するファイルを作成する方法としては、コマンドを <B>-name</B>
および <B>-n</B> オプションを使用して発行し、出力をファイルに送信する方法があります。出力には、それぞれのボリュームについて以下のような行が含まれます (ここでは分かりやすくするため、
2 行に分けて表示)。この値は、以下のリストに示すソースより取得しています。
<PRE>      <VAR>machine</VAR>   <VAR>partition</VAR>   <VAR>volume_dumped</VAR>  # as   <VAR>volume_restored</VAR>;    \
         <VAR>tape_name</VAR>   (<VAR>tape_ID</VAR>);   pos   <VAR>position_number</VAR>;   <VAR>date</VAR>
</PRE>
<P>ここで、
<DL>
<P><DT><B><VAR>machine</VAR>
</B><DD>現在ボリュームを所有するファイル・サーバー・マシンの名前。VLDB のリストに同様。
<P><DT><B><VAR>partition</VAR>
</B><DD>現在ボリュームを所有するパーティションの名前。VLDB のリストに同様。
<P><DT><B><VAR>volume_dumped</VAR>
</B><DD>バックアップ・データベースのリストに従って、ダンプされたボリュームのバージョン
(読み取り / 書き込みまたはバックアップ) を指定します。
<P><DT><B><VAR>volume_restored</VAR>
</B><DD><B>-n</B> フラグを組み込まずにバックアップ・システムがボリュームを復元する際に使用する名前を指定します。
<B>-extension</B> 引き数を、
<B>-name</B> および <B>-n</B> オプションと合わせて組み込んだ場合、このフィールドの名前には拡張子が付きます (たとえば、<TT>user.pat.rst</TT>)。
<P><DT><B><VAR>tape_name</VAR>
</B><DD>ボリュームのダンプを含むテープの名前です。バックアップ・データベースにリストされています。テープに永続名がある場合、ここに表示されます。なければ AFS テープ名となります。
<P><DT><B><VAR>tape_ID</VAR>
</B><DD>ボリュームのダンプを含むテープのテープ ID です。バックアップ・データベースにリストされています。
<P><DT><B><VAR>position_number</VAR>
</B><DD>テープにおけるダンプの位置を指定します (たとえば <TT>31</TT> は、テープ上で現行ダンプの前に 30 ボリューム・ダンプがあることを示します)。ダンプがバックアップ・データ・ファイルに書き込まれた場合は、この数はボリューム・データが開始する 16 KB オフセットの順序数です。
<P><DT><B><VAR>date</VAR>
</B><DD>ボリュームがダンプされた日時。
</DL>
<P>項目を <B>-file</B> 引き数で使用できるようにするには、これを指示に従い編集します。
<UL>
<LI>バックアップ・システムは、入力ファイルのそれぞれの行の最初の 3 つのフィールドのみを使用するため、番号記号 (<TT>#</TT>) より後のフィールドはすべて無視します。ファイルを読みやすくするためにこれらを削除することができますが、削除しなくてもかまいません。
</LI><LI>出力ファイルの各行の <VAR>volume_dumped</VAR> (3 番目) のフィールドが、入力ファイルの <VAR>volume</VAR> フィールドとなります。バックアップ・システムは、読み取り / 書き込みボリュームにのみデータを復元するため、
<VAR>volume_dumped</VAR> フィールドの名前に <TT>.backup</TT> または <TT>.readonly</TT> 拡張子がある場合は、これを削除します。
</LI><LI>出力ファイルには、特定のボリューム・ダンプを組み込むダンプ操作
(フル・ダンプおよび増分ダンプ) のそれぞれについての行が含まれます。しかし、バックアップ・システムは入力ファイル中、特定のボリュームについて記述した最初の行のみを処理します。ファイルを読みやすくするために、繰り返し現れる行は削除することができます。
</LI><LI>出力行の <I>machine</I> および <I>partition</I> フィールドは、ボリュームの現行サイトを指定します。復元する際、ボリュームを他のサイトに移動するには、値を変更します。
</LI></UL>
<A NAME="IDX7070"></A>
<A NAME="IDX7071"></A>
<P><H3><A NAME="HDRWQ431" HREF="auagd002.htm#ToC_352">backup volsetrestore コマンドによりボリューム・グループを復元する</A></H3>
<OL TYPE=1>
<LI><B>/usr/afs/etc/UserList</B> ファイルにリストされているユーザーとして認証されていることを検証します。必要な場合には、<B>bos listusers</B> コマンドを発行します。このコマンドについては、<A HREF="auagd021.htm#HDRWQ816">UserList ファイルのユーザーの表示</A>で詳しく説明しています。
<P>
<PRE>   % <B>bos listusers</B> &lt;<VAR>machine name</VAR>>
</PRE>
</LI><LI>磁気テープ装置に操作を行う磁気テープ・コーディネーターが実行されていない場合には、該当する磁気テープ・コーディネーター・マシンとの接続をオープンにし、<B>butc</B> コマンドを発行してください。詳細については、
<A HREF="#HDRWQ408">テープ・コーディネーター・プロセスを開始するには</A> を参照してください。
<P>
<PRE>   % <B>butc</B> [&lt;<VAR>port offset</VAR>>] [<B>-noautoquery</B>]
</PRE>
<P>
<P>複数のテープ装置を使用している場合は、それぞれのテープ・コーディネーターごとにコマンドを繰り返します。
</LI><LI>テープ装置を使用する場合は、テープを挿入します。
</LI><LI><B>backup</B> コマンドを発行して、対話モードに入ります。
<P>
<PRE>   % <B>backup</B>
</PRE>
</LI><LI><B>(オプション)</B>
この復元操作のために特別に新規ボリュームを作成するのが適当な場合は、
<B>(backup) addvolset</B> を発行してこれを作成します。バックアップ・データベースにボリューム・セットを負荷する必要がない場合は、
<B>-temporary</B> フラグを組み込みます。次に、1 つまたは複数の <B>(backup) addvolentry</B> コマンドを発行して、復元されるボリュームのみを組み込むボリューム項目を作成します。詳細な説明が <A HREF="auagd011.htm#HDRWQ365">ボリューム・セットおよびボリューム項目の定義および表示</A> に示されています。
<P>
<PRE>   backup> <B>addvolset</B> &lt;<VAR>volume set name</VAR>>  [<B>-temporary</B>]
   
   backup> <B>addvolentry  -name</B> &lt;<VAR>volume set name</VAR>>  \
                        <B>-server</B> &lt;<VAR>machine name</VAR>>  \
                        <B>-partition</B> &lt;<VAR>partition name</VAR>>  \
                        <B>-volumes</B> &lt;<VAR>volume name (regular expression)</VAR>>
</PRE>
</LI><LI>使用したい引き数を付けて <B>backup volsetrestore</B> コマンドを発行します。
<P>
<PRE>   backup> <B>volsetrestore</B> [<B>-name</B> &lt;<VAR>volume set name</VAR>>]  \
                 [<B>-file</B> &lt;<VAR>file name</VAR>>]  \
                 [<B>-portoffset</B> &lt;<VAR>TC port offset</VAR>><SUP>+</SUP>]  \
                 [<B>-extension</B> &lt;<VAR>new volume name extension</VAR>>] [<B>-n</B>] 
</PRE>
<P>
<P>ここで、
<P>
<DL>
<P><DT><B>-name
</B><DD>復元するボリューム・セットの名前です。バックアップ・システムは、
VLDB のリスト中、ボリューム・セットのボリューム項目に一致するすべてのボリュームを復元します
(<A HREF="#HDRWQ429">-name 引き数を使用したボリューム・セットの復元</A> を参照)。この引き数は、
<B>-file</B> 引き数とは一緒に使用できません。
<P><DT><B>-file
</B><DD>1 つ以上のボリューム、およびそれぞれのボリュームを復元するサイト
(ファイル・サーバー・マシンおよびパーティション) をリストするファイルの全パス名を指定します。入力ファイルは、
<A HREF="#HDRWQ430">-file 引き数によりファイルにリストされたボリュームを復元する</A> に説明した形式をとります。この引き数は、<B>-name</B> 引き数とは一緒に使用できません。
<P><DT><B><B>-portoffset</B>
</B><DD>1 つ以上のポート・オフセット番号を指定します。それぞれが操作で使用するテープ・コーディネーターに対応します。複数の値がある場合、それぞれのボリュームのフル・ダンプを復元する際、リスト中の最初のオフセット、レベル 1 の増分ダンプの復元では次のオフセットというように、以降はこれを順次使用します。リストの最終値を使用する際は、ダンプ階層中これに対応する深さのダンプ、およびこれ以下のレベルのすべてのダンプが復元されます。
<P>
<P>すべてのダンプについてデフォルト値の 0 (ゼロ) が適切でない場合に限り、この引き数を使用します。
0 がリスト中の値の 1 つであれば、これを適当な順序で明示的に指定します。
<P><DT><B>-extension
</B><DD>復元されるそれぞれのボリュームに対して新規ボリュームを作成し、復元データを配置します。VLDB にリストされているボリュームの読み取り / 書き込み基本名に、指定文字列を追加します。
<B>.readonly</B>
または <B>.backup</B> 以外のいずれの文字列も受け入れ可能です。基本名と拡張子の組み合わせは、22 文字以内とします。ピリオドを使って拡張子を名前から分離するには、ピリオドを文字列の最初の文字に指定します (たとえば、
<B>.rst</B> のようにします)。
<P><DT><B><B>-n</B>
</B><DD>フラグが組み込まれない場合に復元するボリュームのリストを表示します。実際にこれを復元することはありません。この解説ページの <B>出力</B> についての機能グループには、出力形式の詳細が記されています。
<B>-name</B> 引き数と組み合わせると、その出力が簡単に編集でき、以降の <B>backup volsetrestore</B> コマンドで <B>-file</B> 引き数の入力に使用することができます。
</DL>
</LI><LI><B>butc</B> コマンドを発行したときに、<B>-noautoquery</B> フラグを付けなかったか、装置の <B>CFG_</B><VAR>device_name</VAR> 構成ファイルに
<B>AUTOQUERY YES</B> 命令を記述している場合には、テープ・コーディネーターから装置のドライブにテープを装てんするようにプロンプトが出されます。すでにこれを行っていても、
&lt;<B>Return</B>> を押して、テープがラベル付けの準備ができていることを示さなければなりません。
<P>
<P>複数のテープが必要な場合は、
<B>MOUNT</B> 命令を <B>CFG_</B><VAR>device_name</VAR> ファイルに組み込み、対応するスタッカーまたはジュークボックスにテープを装てんするか、コンソールにとどまり次のテープに対するプロンプトに応えなければなりません。
</LI><LI>復元操作が完了したら、バックアップ・システムのログ・ファイルにエラーがないかチェックします。
<B>bos getlog</B> コマンド
(<A HREF="auagd009.htm#HDRWQ228">サーバー・プロセス・ログ・ファイル表示する</A> を参照) を使用して <B>/usr/afs/logs/BackupLog</B> ファイルを読み取り、テープ・コーディネーター・マシンのテキスト・エディターを使用して
<B>TE_</B><VAR>device_name</VAR> および <B>TL_</B><VAR>device_name</VAR> ファイル (<B>/usr/afs/backup</B> ディレクトリー) を読み取ります。
</LI></OL>
<A NAME="IDX7072"></A>
<HR><H2><A NAME="HDRWQ432" HREF="auagd002.htm#ToC_353">バックアップ・データベースの保守</A></H2>
<P>バックアップ・データベースは、データのダンプと復元を行うときに使用する構成と追跡のすべての情報を保管します。ハードウェア障害、またはデータベース・サーバー・マシンのほかの問題によってデータベースが破壊、または損傷した場合、構成情報 (ダンプ階層、ボリューム・セットのリスト、およびテープ・コーディネーターのポート・オフセット番号) を再作成するのは比較的容易です。けれども、ダンプ追跡情報 (ダンプ・レコード) の復元は、もっと複雑で時間がかかります。データの消失を防ぐ、バックアップ・データベースそのものを定期的にテープにバックアップします。
<P>他の潜在的な問題としては、バックアップ・システムは、ダンプ操作の詳細で相互参照されたレコードを保持するため、バックアップ・データベースがすぐに大きくなってしまう点があげられます。バックアップ・サーバーが、必要なデータを見つけるために大量の古くなったレコードをナビゲートしなければならない場合、バックアップ・オペレーションは、より非効率的になる可能性があります。データベースを管理可能なサイズに保つには、
<B>backup deletedump</B> コマンドを使用して、古くなったレコードを除去します
(<A HREF="#HDRWQ437">古くなったレコードをバックアップ・データベースから除去する</A> を参照)。しかし、まだ必要なレコードを除去してしまったことに後から気付いた場合は、
<B>backup
scantape</B> コマンドを使用して、対応するテープ上のダンプおよびラベルから情報をデータベースに読み取ることができます
(<A HREF="#HDRWQ421">テープ内容をスキャンするには</A> を参照)。
<A NAME="IDX7073"></A>
<A NAME="IDX7074"></A>
<A NAME="IDX7075"></A>
<A NAME="IDX7076"></A>
<A NAME="IDX7077"></A>
<P><H3><A NAME="HDRWQ433" HREF="auagd002.htm#ToC_354">バックアップ・データベースのバックアップと復元</A></H3>
<P>バックアップ・データベース内の情報は重要なものであり、これはテープまたは他の永続的なメディアに定期的に保存するのがよいでしょう。他の AFS 管理データベースの場合、推奨される方法としては、
UNIX
<B>tar</B> コマンドのようにマシンのローカル・ディスクをバックアップするためのユーティリティーを使用するものがあります。説明については、<A HREF="auagd008.htm#HDRWQ142">管理用データベースのバックアップと復元</A> を参照してください。
<P>まれにではありますが、バックアップ・データベースが損傷または破壊されたと思われる場合は、
<B>backup dbverify</B> コマンドを使用してその状況をチェックすることができます。これが破壊されている場合は、<B>backup savedb</B> コマンドを使用することにより損傷が修復可能な場合もあります。その上で、<B>backup restoredb</B> を使用して、修正したデータベースをデータベース・サーバー・マシンのローカル・ディスクに戻します。説明については、<A HREF="#HDRWQ434">バックアップ・データベースの破壊のチェックおよび修復</A> を参照してください。
<P><H3><A NAME="HDRWQ434" HREF="auagd002.htm#ToC_355">バックアップ・データベースの破壊のチェックおよび修復</A></H3>
<P>まれにバックアップ・データベースが、ディスクまたはその他のハードウェア・エラーのために損傷または破壊される場合があります。
<B>backup
dbverify</B> コマンドを使用して、データベースの整合性を検査します。これが破壊されている場合、最も効率的な修復方法は、<B>backup
savedb</B> コマンドを使用してデータベースをテープにコピーするものです。コマンドにより、自動的にいくつかの種類の損傷は自動的に修復され、その上で <B>backup restoredb</B> コマンドを使用して、データベースの修復コピーをデータベース・サーバー・マシンのローカル・ディスクに戻します。
<P><B>backup savedb</B> コマンドにより <I>孤立ブロック</I> を削除することもできます。これは、バックアップ・サーバーがデータベースに事前割り振りしたメモリー範囲で、使用できなくなったものです。孤立ブロックはデータベース・アクセスの障害となるものではありませんが、ディスク・スペースを浪費します。<B>backup dbverify</B> コマンドを使用すると、
<B>-detail</B> フラグを組み込んだ場合に、孤立ブロックがあるか報告されます。
<A NAME="IDX7078"></A>
<A NAME="IDX7079"></A>
<A NAME="IDX7080"></A>
<P><H3><A NAME="HDRWQ435" HREF="auagd002.htm#ToC_356">バックアップ・データベースの整合性を検査するには</A></H3>
<OL TYPE=1>
<LI><B>/usr/afs/etc/UserList</B> ファイルにリストされているユーザーとして認証されていることを検証します。必要な場合には、<B>bos listusers</B> コマンドを発行します。このコマンドについては、<A HREF="auagd021.htm#HDRWQ816">UserList ファイルのユーザーの表示</A>で詳しく説明しています。
<P>
<PRE>   % <B>bos listusers</B> &lt;<VAR>machine name</VAR>>
</PRE>
</LI><LI><B>backup dbverify</B> コマンドを発行して、バックアップ・データベースの整合性を検査します。
<P>
<PRE>   % <B>backup dbverify</B> [<B>-detail</B>]
</PRE>
<P>
<P>ここで、
<P>
<DL>
<P><DT><B>db
</B><DD>は、<B>dbverify</B> の受け入れ可能な省略形です。
<P><DT><B>-detail
</B><DD><I>AFS Administration Reference</I> の <B>backup dbverify</B> 参照ページで説明したように、孤立ブロックの存在、およびデータベースについてのその他の情報を表示します。
</DL>
<P>
<P>出力は、以下のメッセージのいずれかをレポートします。
<UL>
<LI><TT>Database OK</TT> は、バックアップ・データベースが損傷していないことを示す。
</LI><LI><TT>Database not OK</TT> は、バックアップ・データベースが損傷していることを示す。問題を回復するには、<A HREF="#HDRWQ436">バックアップ・データベースの破壊の修復</A> の指示に従います。
</LI></UL>
</LI></OL>
<A NAME="IDX7081"></A>
<A NAME="IDX7082"></A>
<P><H3><A NAME="HDRWQ436" HREF="auagd002.htm#ToC_357">バックアップ・データベースの破壊の修復</A></H3>
<OL TYPE=1>
<LI>ローカル・スーパーユーザー <B>root</B> として、セル内の各データベース・サーバー・マシンにログインします。
</LI><LI><A NAME="LISAVEDB-STARTTC"></A>磁気テープ装置に操作を行う磁気テープ・コーディネーターが実行されていない場合には、該当する磁気テープ・コーディネーター・マシンとの接続をオープンにし、<B>butc</B> コマンドを発行してください。詳細については、<A HREF="#HDRWQ408">テープ・コーディネーター・プロセスを開始するには</A> を参照してください。
<P>
<PRE>   % <B>butc</B> [&lt;<VAR>port offset</VAR>>] [<B>-noautoquery</B>]
</PRE>
</LI><LI>テープに書き込む場合は、適切な装置にテープを挿入します。
</LI><LI>いずれかのマシンで作業をし、<B>backup</B> コマンドを発行して、対話モードに入ります。
<P>
<PRE>   # <B> backup -localauth</B>
</PRE>
<P>
<P>ここで、<B>-localauth</B> により、ローカルの <B>/usr/afs/etc/KeyFile</B> ファイルからサーバー・チケットを構成します。このフラグにより、AFS 管理トークンを持っていなくても、ローカル・スーパーユーザー <B>root</B> としてログインし、特権コマンドを発行することができます。
</LI><LI>バックアップ操作がアクティブで実行されていないことを確認します。必要であれば、
<B>(backup) status</B> コマンドを発行します (<A HREF="#HDRWQ411">テープ・コーディネーター・プロセスの状況を検査するには</A> を参照)。それぞれのテープ・コーディネーターのポート・オフセットごとに順に繰り返します。
<P>
<PRE>   backup> <B>status -portoffset</B> &lt;<VAR>TC port offset</VAR>>
</PRE>
</LI><LI><A NAME="LISAVEDB-CMD"></A><B>(backup) savedb</B> コマンドを発行し、データベースがテープまたはファイルに書き込まれる際に破壊の修復を行います。
<P>
<PRE>   backup> <B>savedb</B> [<B>-portoffset</B> &lt;<VAR>TC port offset</VAR>>]
</PRE>
<P>
<P>ここで、
<P>
<DL>
<P><DT><B>sa
</B><DD>は、<B>savedb</B> の受け入れ可能な省略形です。
<P><DT><B>-portoffset
</B><DD>この操作で磁気テープを処理する磁気テープ・コーディネーターのポート・オフセット番号を指定します。デフォルト値の 0 (ゼロ) が適切でない場合には、この引き数を指定しなければなりません。
</DL>
</LI><LI>対話モードを終了します。
<P>
<PRE>   backup>  <B>quit</B>  
</PRE>
</LI><LI>それぞれのマシン上で、順に <B>bos shutdown</B> コマンドを発行して、バックアップ・サーバー・プロセスを終了します。ユーザーはローカル・スーパーユーザー root としてログインしているため、
<B>-localauth</B> を組み込みますが、管理トークンは必要ありません。完全なコマンド構文については、
<A HREF="auagd009.htm#HDRWQ223">プロセスを一時停止させる方法</A> を参照してください。
<P>
<PRE>   # <B>/usr/afs/bin/bos shutdown</B> &lt;<VAR>machine name</VAR>> <B>buserver  -localauth  -wait</B>
</PRE>
</LI><LI>それぞれのマシンで、順に以下のコマンドを発行し、バックアップ・データベースを除去します。
<P>
<PRE>   # <B>cd /usr/afs/db</B>
   # <B>rm bdb.DB0</B>
   # <B>rm bdb.DBSYS1</B>
</PRE>
</LI><LI>最下位の IP アドレスのマシンから開始し、それぞれのマシンで順に <B>bos start</B> コマンドを発行して、バックアップ・サーバー・プロセスを再始動します。開始する際には長さゼロのバックアップ・データベースのコピーが作成されます。完全なコマンド構文については、<A HREF="auagd009.htm#HDRWQ221">状況フラグを Run に変更してプロセスを開始する方法</A> を参照してください。
<P>
<PRE>   # <B>/usr/afs/bin/bos start</B> &lt;<VAR>machine name</VAR>> <B>buserver  -localauth</B>
</PRE>
</LI><LI>いずれかのマシンで作業をし、<B>backup</B> コマンドを発行して、対話モードに入ります。
<P>
<PRE>   # <B> backup -localauth</B>
</PRE>
<P>
<P>ここで、<B>-localauth</B> により、ローカルの <B>/usr/afs/etc/KeyFile</B> ファイルからサーバー・チケットを構成します。
</LI><LI><B>(backup) addhost</B> コマンドを発行し、データベースの修復コピーを読み取るテープまたはファイルを処理するテープ・コーディネーター・プロセスに対し、新規の空のデータベースに項目を作成します
(<A HREF="#LISAVEDB-STARTTC">2</A> のステップで開始したプロセス、および
<A HREF="#LISAVEDB-CMD">6</A> のステップの <B>backup savedb</B> 操作で実行したプロセスについて)。完全な構文については、
<A HREF="auagd011.htm#HDRWQ362">磁気テープ・コーディネーター・マシンを構成するには</A> 内の <A HREF="auagd011.htm#LICONFTC-ADDHOST">8</A> のステップを参照してください。
<P>
<PRE>   backup>  <B>addhost</B> &lt;<VAR>tape machine name</VAR>> [&lt;<VAR>TC port offset</VAR>>]
</PRE>
<A NAME="IDX7083"></A>
<A NAME="IDX7084"></A>
</LI><LI><B>(backup) restoredb</B> コマンドを発行し、修復されたデータベースをデータベース・サーバー・マシンにコピーします。
<P>
<PRE>   backup> <B>restoredb</B>  [<B>-portoffset</B> &lt;<VAR>TC port offset</VAR>>]
</PRE>
<P>
<P>ここで、
<P>
<DL>
<P><DT><B>res
</B><DD>は、<B>restoredb</B> の受け入れ可能な省略形です。
<P><DT><B>-portoffset
</B><DD>この操作で磁気テープを処理する磁気テープ・コーディネーターのポート・オフセット番号を指定します。デフォルト値の <B>0</B> (ゼロ) が適切でない場合には、この引き数を指定しなければなりません。
</DL>
</LI><LI><B>(オプション)</B>
追加の <B>backup</B> コマンドを発行する予定がなければ、対話モードを終了します。
<P>
<PRE>   backup>  <B>quit</B>
</PRE>
</LI><LI><B>(オプション)</B> 必要であれば、<B>Ctrl-d</B> または他の割り込みシグナルを入力し、それぞれのデータベース・サーバー・マシンの <B>root</B> シェルを終了します。また、テープ・コーディネーター・マシンで <B>Ctrl-c</B> 信号を発行してプロセスを停止することもできます。
</LI></OL>
<A NAME="IDX7085"></A>
<A NAME="IDX7086"></A>
<P><H3><A NAME="HDRWQ437" HREF="auagd002.htm#ToC_358">古くなったレコードをバックアップ・データベースから除去する</A></H3>
<P><B>backup dump</B> コマンドまたは <B>backup labeltape</B> コマンドを使用して、テープのリサイクルまたは再ラベル付けを行う度に、バックアップ・システムは、そのテープ、およびダンプ・セット内のすべてのテープ上に含まれたダンプに対するすべてのダンプ・レコードを自動的に除去します。しかし、それでも時間がたつと、バックアップ・データベースに古くなったレコードがたまる場合があります。たとえば、バックアップ・テープを、メーカーが推奨している最大使用回数まで使用して廃棄した場合、そのテープ上のダンプ用のレコードは、データベース上に残されます。同様に、ダンプの有効期限になってもそのダンプを含むテープをリサイクルまたはラベル変更しただけの場合、バックアップ・システムは自動的にダンプのレコードを削除しません。さらに、バックアップ操作が途中で停止した場合、操作が停止する前に正常にテープに書き込まれたすべてのボリュームのレコードは、データベース内に残ります。
<P>非常に大きいバックアップ・データベースは、バックアップ・オペレーションを、より非効率にする可能性があります。その理由は、バックアップ・サーバーが、必要なレコードを検出するのに大量のレコードをナビゲートしなければならないからです。古くなったレコードを除去するには、<B>backup deletedump</B> コマンドを使用します。ダンプ ID 番号によって個々のダンプを識別するか、または一定の時間枠で作成されたすべてのダンプの除去を指定します。それを行うと、すべての関連した付加ダンプのレコードを除去することになり、初期ダンプのレコードの除去を行わない限り、付加ダンプのレコードは、除去できないということに留意してください。ダンプのレコードを除去することは、対応するテープから、または削除されたダンプをその親として参照するどのダンプからも、直接的にも間接的にもデータの復元を不可能にします。つまり、復元オペレーションは、フルダンプから開始し、続いて各増分ダンプを順番に行わなければなりません。特定のダンプのレコードを除去した場合、どのデータもその後の増分ダンプから復元できません。
<P>バックアップ・データベースを切り捨てる別の方法は、<B>-archive</B> 引き数を <B>backup savedb</B> コマンドに組み込むものです。データベースのコピーがテープまたはバックアップ・データ・ファイルに書き込まれたら、バックアップ・サーバーは、指定した日時より前のタイプ・スタンプを持つすべてのダンプ操作のダンプ・レコードを削除します。ただし、<B>backup deletedump</B> コマンドに <B>-to</B> 引き数のみを組み合わせて発行すれば、結果的に同等であり、
<B>backup savedb</B> コマンドのようにテープ・コーディネーターの開始が要求されないためより簡単です。
<B>backup savedb</B> コマンドにおける <B>-archive</B> 引き数に関する詳細は、
<I>AFS Administration Reference</I> のコマンド解説ページを参照してください。
<P>削除したダンプ・レコードに後でアクセスする必要がある場合で、対応するテープがまだ存在するのであれば、<B>-dbadd</B> 引き数を
<B>backup scantape</B> コマンドで使用して、その内容をデータベースにスキャンすることができます。<A HREF="#HDRWQ421">テープ内容をスキャンするには</A> を参照してください。
<A NAME="IDX7087"></A>
<A NAME="IDX7088"></A>
<P><H3><A NAME="HDRWQ438" HREF="auagd002.htm#ToC_359">ダンプ・レコードをバックアップ・データベースから削除するには</A></H3>
<OL TYPE=1>
<LI><B>/usr/afs/etc/UserList</B> ファイルにリストされているユーザーとして認証されていることを検証します。必要な場合には、<B>bos listusers</B> コマンドを発行します。このコマンドについては、<A HREF="auagd021.htm#HDRWQ816">UserList ファイルのユーザーの表示</A>で詳しく説明しています。
<P>
<PRE>   % <B>bos listusers</B> &lt;<VAR>machine name</VAR>>
</PRE>
</LI><LI><B>(オプション)</B> 複数のレコードを削除する、または追加のコマンドを発行する場合は、<B>backup</B> コマンドを発行して、対話モードに入ります。以下のように対話式でプロンプトが表示されます。
<P>
<PRE>   % <B>backup</B>
</PRE>
</LI><LI><B>(オプション)</B> <B>backup dumpinfo</B> コマンドを発行して、削除するレコードを決定する手助けとなる情報をバックアップ・データベースからリストします。詳細は、<A HREF="#HDRWQ419">ダンプ・レコードの表示</A> を参照してください。
<P>
<PRE>   backup> <B>dumpinfo</B> [&lt;<VAR>no. of dumps</VAR>>]  [<B>-id</B> &lt;<VAR>dump id</VAR>>]  [<B>-verbose</B>]
</PRE>
</LI><LI><B>backup deletedump</B> コマンドを発行して、
1 つまたは複数のダンプ・セットを削除する。
<P>
<PRE>   backup> <B>deletedump</B> [<B>-dumpid</B> &lt;<VAR>dumpid</VAR>><SUP>+</SUP>] [<B>-from</B> &lt;<VAR>date time</VAR>>]  \
                      [<B>-to</B> &lt;<VAR>date time</VAR>>] 
</PRE>
<P>
<P>ここで、
<P>
<DL>
<P><DT><B>dele
</B><DD>は、<B>deletedump</B> の受け入れ可能な省略形です。
<P><DT><B>-dumpid
</B><DD>バックアップ・データベースから削除する各初期ダンプのダンプ ID を指定します。また、関連したすべての付加ダンプに対するレコードも削除されます。この引き数、または <B>-to</B> (そして、任意選択で、
<B>-from</B>) 引き数のいずれかを与えます。
<P><DT><B>-from
</B><DD>日付の範囲の先頭を指定します。指示された期間中に作成されたダンプに対するレコードは削除されます。
<P>
<P><B>-to</B> 引き数で指示された時刻以前のすべてのレコードを省略するには、この引き数を省略します。そうしない場合は、値を以下の形式で与えます。
<P>
<P><VAR>mm</VAR>/<VAR>dd</VAR>/<VAR>yyyy</VAR> [<VAR>hh</VAR>:<VAR>MM</VAR>]
<P>
<P>ここで、月 (<VAR>mm</VAR>)、日 (<VAR>dd</VAR>)、および年 (<VAR>yyyy</VAR>) は必須です。時と分 (<VAR>hh</VAR>:<VAR>MM</VAR>) を省略して、デフォルト値の真夜中 (00:00 時) を指示することができます。時と分を与える場合は、24 時間形式 (たとえば、値の <B>14:36</B> は、
2:36 p.m. を表す) を使用します。
<P>
<P>これと共に、<B>-to</B> 引き数を与えなければなりません。
<P>
<TABLE><TR><TD ALIGN="LEFT" VALIGN="TOP"><B>注:</B></TD><TD ALIGN="LEFT" VALIGN="TOP">コマンド構文中、この引き数にはプラス記号が続きますが、これは複数値を受け入れるためで (値を二重引用符や他の区切り文字で囲む必要はありません)、複数の日付を受け入れるわけではありません。単一の日付 (オプションで時間) を定義します。
</TD></TR></TABLE>
<P><DT><B>-to
</B><DD>日付の範囲の末尾を指定します。この範囲の中で作成されたダンプのレコードは、バックアップ・データベースから削除されます。
<P>
<P><B>-from</B> 引き数で指定する日付の後で作成されたすべてのレコードを削除するには、値の <B>NOW</B> を指定します。バックアップ・データベース内のすべてのダンプ・レコードを削除するには、値の <B>NOW</B> を与え、<B>-from</B> 引き数を省略します。そうしない場合は、<B>-from</B> 引き数について説明したのと同じ形式で、日付値を与えます。年 (<VAR>yyyy</VAR>) 範囲の有効な値は、<B>1970</B> から <B>2037</B> までです。これより高い値は無効です。なぜなら、標準 UNIX 表示における最も後の (将来に近い) 表示は、2038年の初期までだからです。コマンド・インタープリターは、それ以降の日付を自動的に最大値の 2038 に削減します。
<P>
<P>時刻部分 (<VAR>hh</VAR>:<VAR>MM</VAR>) を省略すると、午前 0 時 59 秒 (00:00:59 時) がデフォルトとなります。同様に、<B>backup</B> コマンド・インタープリターは、与えられた値に自動的に 59 秒を加算します。両方のケースとも、59 秒の加算は、バックアップ・データベースおよび <B>backup dumpinfo</B> コマンドがダンプ作成時刻を時と分だけで表示するのを補正します。たとえば、データベースは、20:55:00 から 20:55:59 までの間に開始したダンプ・オペレーションに対して、
<TT>20:55</TT> のタイム・スタンプ作成をレコードします。自動的に時刻に 59 秒を加算することにより、その一分間に生成されたすべてのダンプのレコードを含みます。
<P>
<P>この引き数か、または<B>-dumpid</B> 引き数のいずれかを与えます。
<B>-from</B> 引き数が与えられている場合は、この引き数は必須です。
<P>
<TABLE><TR><TD ALIGN="LEFT" VALIGN="TOP"><B>注:</B></TD><TD ALIGN="LEFT" VALIGN="TOP">コマンド構文中、この引き数にはプラス記号が続きますが、これは複数値を受け入れるためで (値を二重引用符や他の区切り文字で囲む必要はありません)、複数の日付を受け入れるわけではありません。単一の日付 (オプションで時間) を定義します。
</TD></TR></TABLE>
</DL>
</LI></OL>
<P><HR><B>&#91; <A HREF="#Top_Of_Page">ページのトップ</A> &#124; <A HREF="auagd011.htm">前ページ</A> &#124; <A HREF="auagd013.htm">次ページ</A> &#124; <A HREF="auagd002.htm#ToC">目次</A> &#124; <A HREF="auagd026.htm#HDRINDEX">索引</A> &#93;</B> 
<!-- Begin Footer Records  ========================================== -->
<P><HR><B> 
<br>(C) <A HREF="http://www.ibm.com/">IBM Corporation 2000.</A>  All Rights Reserved<!-- 991224 --> 
</B> 
<!-- End Footer Records  ============================================ -->
<A NAME="Bot_Of_Page"></A>
</BODY></HTML>
