# Copyright 2000, International Business Machines Corporation and others.
# All Rights Reserved.
# 
# This software has been released under the terms of the IBM Public
# License.  For details, see the LICENSE file in the top-level source
# directory or online at http://www.openafs.org/dl/license10.html

srcdir=@srcdir@
include @TOP_OBJDIR@/src/config/Makefile.config

# MakefileProto for LINUX systems
# This Makefile generates two libraries: the standard libuafs and libjuafs,
# a libuafs variant that is designed to link with Java enabled libraries.
# The libjuafs library implements the AFS_WEB_ENHANCEMENTS definition, see
# the libuafs README for details.

# System specific build commands and flags
CC = gcc
DEFINES= -D_REENTRANT -DKERNEL -DUKERNEL
KOPTS=
CFLAGS=-I. -I.. -I${TOP_OBJDIR}/src/config ${FSINCLUDES} $(DEFINES) $(KOPTS) ${DBUG}
OPTF=-O
# WEBOPTS = -I../nsapi -DNETSCAPE_NSAPI -DNET_SSL -DXP_UNIX -DMCC_HTTPD

TEST_CFLAGS=-pthread -D_REENTRANT -DAFS_PTHREAD_ENV -DAFS_LINUX22_ENV
TEST_LDFLAGS=
TEST_LIBS=-lpthread

LIBUAFS = libuafs.a
LIBJUAFS = libjuafs.a
LIBAFSWEB = nsafs.so
LIBAFSWEBKRB = nsafs.krb.so

include Makefile.common

setup_common:
	-$(RM) -f  h net netinet rpc ufs nfs  machine sys inet nsapi
	-ln -s /usr/include/sys h
	-ln -s /usr/include/net net
	-ln -s /usr/include/netinet netinet
	-ln -s /usr/include/rpc rpc
	-ln -s /usr/include/sys sys
	-ln -s /usr/include/nfs nfs
	-ln -s /usr/include/inet inet
	-ln -s /usr/include/ufs ufs
	-ln -s $(NS_INCL) nsapi

setup_uafs: UAFS setup_common
	-$(RM) -f UAFS/Makefile UAFS/Makefile.common
	ln -s ../Makefile UAFS/Makefile
	ln -s ../Makefile.common UAFS/Makefile.common

setup_juafs: JUAFS setup_common
	-$(RM) -f JUAFS/Makefile JUAFS/Makefile.common
	ln -s ../Makefile JUAFS/Makefile
	ln -s ../Makefile.common JUAFS/Makefile.common

UAFS:
	mkdir -p $@

JUAFS:
	mkdir -p $@

setup_nsafs: AFSWEB setup_common
	-$(RM) -f AFSWEB/Makefile AFSWEB/Makefile.common
	ln -s ../Makefile AFSWEB/Makefile
	ln -s ../Makefile.common AFSWEB/Makefile.common

AFSWEB:
	mkdir -p $@

UAFS/$(LIBUAFS): setup_uafs
	cd UAFS; \
	$(MAKE) $(LIBUAFS) DESTDIR=${DESTDIR} LIBJUAFS_FLAGS=

JUAFS/$(LIBJUAFS): setup_juafs
	cd JUAFS; \
	$(MAKE) $(LIBJUAFS) DESTDIR=${DESTDIR} LIBJUAFS_FLAGS=-DAFS_WEB_ENHANCEMENTS

AFSWEB/$(LIBAFSWEB): setup_nsafs
	cd AFSWEB; \
	$(MAKE) $(LIBAFSWEB) DESTDIR=${DESTDIR}

AFSWEB/$(LIBAFSWEBKRB): setup_nsafs
	cd AFSWEB; \
	$(MAKE) $(LIBAFSWEBKRB) DESTDIR=${DESTDIR}

# Below this line are targets when in the COMMON directory:

$(LIBUAFS): $(UAFSOBJ)
	-$(RM) -f $(LIBUAFS)
	$(AR) $(ARFLAGS) $(LIBUAFS) $(UAFSOBJ)

$(LIBJUAFS): $(JUAFSOBJ)
	-$(RM) -f $(LIBJUAFS)
	$(AR) $(ARFLAGS) $(LIBJUAFS) $(JUAFSOBJ)

$(LIBAFSWEB): $(AFSWEBOBJ) ${DES}/libdes.a
	-$(RM) -f $(LIBAFSWEB)
	ld -b $(LIBAFSWEB) $(AFSWEBOBJ) ${DES}/libdes.a $(WEBLIBS)

$(LIBAFSWEBKRB): $(AFSWEBOBJKRB) ${DES}/libdes.a
	-$(RM) -f $(LIBAFSWEBKRB)
	ld -b $(LIBAFSWEBKRB) $(AFSWEBOBJKRB) ${DES}/libdes.a $(WEBLIBS)






